"use strict";_SL.nmspc("schedule").form=function(){var a={formId:"#formReportSched",urlSelect:gCONTEXT_PATH+"report/schedule_form.json",urlDelete:gCONTEXT_PATH+"report/schedule_delete.do",urlSelectUser:gCONTEXT_PATH+"report/report_mail_user.json",eqpTreeId:"#eqp_ip_tree",eqpTypeTreeId:"#eqp_type_cd_tree",logCateTreeId:"#log_cate_cd_tree",assetGrpTreeId:"#asset_group_cd_tree",eqpUrl:gCONTEXT_PATH+"report/eqp_list.json",eqpTypeUrl:gCONTEXT_PATH+"report/eqp_type_list.json",logCateUrl:gCONTEXT_PATH+"report/log_cate_list.json",assetGrpUrl:gCONTEXT_PATH+"report/asset_group_list.json",add:{action:gCONTEXT_PATH+"report/schedule_add.do",message:"등록 하시겠습니까?"},update:{action:gCONTEXT_PATH+"report/schedule_update.do",message:"수정 하시겠습니까?"},condIds:{ALL:["eqp_ip","eqp_type_cd","log_cate_cd","asset_group_cd"],1:["log_cate_cd"],2:["eqp_type_cd","asset_group_cd"]}},b={form:$(a.formId),eqpTree:$(a.eqpTreeId),eqpTypeTree:$(a.eqpTypeTreeId),logCateTree:$(a.logCateTreeId),assetGrpTree:$(a.assetGrpTreeId),scheduleId:$(a.formId+" [name=schedule_id]"),schdStat:$(a.formId+" [name=schd_stat]"),reportId:$(a.formId+" [name=report_id]"),genCycle:$(a.formId+" [name=gen_cycle]"),genStartDay:$(a.formId+" [name=genStartDay]"),genStartHour:$(a.formId+" [name=genStartHour]"),genStartMin:$(a.formId+" [name=genStartMin]"),timeSet:$(a.formId+" [name=timeSet]"),schPeriodTr:$(a.formId+" #schPeriodTr"),week:$(a.formId+" [name=week]"),genCondition:$(a.formId+" [name=gen_condition]")},c={tree:null,isNew:""==b.scheduleId.val(),mode:""==b.scheduleId.val()?a.add:a.update,genCondition:""==b.genCondition.val()?"{}":b.genCondition.val()},d=function(){e(),b.reportId.trigger("change"),c.isNew?(b.form.find(".btn-delete").hide(),b.form.find(".schdStatTr").hide()):b.reportId.prop("disabled",!0),c.isNew||f(),slui.attach.init(a.formId)},e=function(){b.form.find(".btn-save").on("click",l),b.form.find(".btn-delete").on("click",m),b.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var c=_SL.formatDate.addMin(b.form.find("[name=schEndDay]").val()+b.form.find("[name=schEndHour]").val()+b.form.find("[name=schEndMin]").val(),-a);b.form.find("[name=schStartDay]").val(c.substring(0,8)),b.form.find("[name=schStartDay]").siblings(".tform-select").find(".tform-select-t").text(c.substring(0,8)),b.form.find("[name=schStartHour]").val(c.substring(8,10)),b.form.find("[name=schStartHour]").siblings(".tform-select").find(".tform-select-t").text(c.substring(8,10)),b.form.find("[name=schStartMin]").val(c.substring(10,12)),b.form.find("[name=schStartMin]").siblings(".tform-select").find(".tform-select-t").text(c.substring(10,12))}}),b.form.find("[name=schStartDay],[name=schStartHour],[name=schStartMin],[name=schEndDay],[name=schEndHour],[name=schEndMin]").change(function(){b.form.find("[name=timeSet]").val(0),b.form.find("[name=timeSet]").siblings(".tform-select").find(".tform-select-t").text(b.timeSet.find("option:eq(0)").text())}),b.reportId.on("change",g),h(),b.genCycle.on("change",h),b.form.find("#report_usr_add").click(function(){var a=b.form.find("[name=chk_user]").val();if(""==a)return!1;for(var c,d,e=b.form.find("[name=chk_user] option:selected").text(),f=e.split(","),g=0;g<f.length;g++)c=f[0],d=f[2];return d.length<=2?void _alert("이메일이 등록되지 않은 사용자 입니다. <br>( "+c+" )"):""==a?void _alert("사용자를 선택하세요."):b.form.find("[name=chk_user_list] option").is(function(){return this.value==a})?void _alert("해당 ID가 이미 존재합니다. ( ID : "+a+" )"):void b.form.find("[name=chk_user_list]").append($("<option>").val(a).text(e))}),b.form.find("#report_usr_del").click(function(){b.form.find("[name=chk_user_list] :selected").remove()})},f=function(){var c=b.scheduleId.val(),d={schedule_id:c},e=function(c){if(null!=c){var d=c.gen_start_time,e=c.sch_start_time,f=c.sch_end_time,i=(c.gen_day,c.gen_condition),j=c.gen_cycle;null!=e&&null!=f||(e=_SL.formatDate.addMin(d,-60),f=d),b.form.find("[name=genStartHour]").val(d.substring(8,10)),b.form.find("[name=genStartMin]").val(d.substring(10,12)),"0"==j&&(b.form.find("[name=genStartDay]").val(d.substring(0,8)),b.form.find("[name=schStartDay]").val(e.substring(0,8)),b.form.find("[name=schStartHour]").val(e.substring(8,10)),b.form.find("[name=schStartMin]").val(e.substring(10,12)),b.form.find("[name=schEndDay]").val(f.substring(0,8)),b.form.find("[name=schEndHour]").val(f.substring(8,10)),b.form.find("[name=schEndMin]").val(f.substring(10,12)),b.form.find("[name=gen_condition]").val(i)),_SL.setDataToForm(c,b.form,{schd_stat:{converter:function(a,c){"3"==a?(b.schdStat.parents("[class^=range-]").hide(),b.form.find(".comp_stat").show(),b.form.find(".btn-save").hide()):(b.schdStat.val(a),b.schdStat.parents("[class^=range-]").show(),b.form.find(".comp_stat").hide(),b.form.find(".btn-save").show())}},gen_day:{field:"week",converter:function(a,c){7==a&&(a=0),"2"==j&&b.form.find("[name=week]").val(a)}},file_format_list:{field:"file_format_list_chk",converter:function(a,c){var d=a.split(",");$.each(d,function(a,c){b.form.find("[name=file_format_list_chk]").each(function(){c==$(this).val()&&$(this).prop("checked",!0)})})}}}),g(),h(),slui.attach.init(a.formId)}else _alert("처리 중 에러가 발생하였습니다")};$("body").requestData(a.urlSelect,d,{callback:e});var f=function(c){var d,e;for(var f in c)d=c[f].user_id,e=c[f].user_nm+" ["+c[f].user_id+"], ["+c[f].mobile_no+"], ["+c[f].mail_addr+"]",b.form.find("[name=chk_user_list]").append($("<option value='"+d+"'>"+e+"</option>"));slui.attach.init(a.formId)};$("body").requestData(a.urlSelectUser,d,{callback:f})},g=function(){var c={report_id:b.reportId.val()},d=b.form.find("[name=report_id] option:selected").data("report-type");"2"==d?($("body").requestData(a.eqpTypeUrl,c,{callback:i}),$("body").requestData(a.assetGrpUrl,c,{callback:k})):"1"==d&&$("body").requestData(a.logCateUrl,c,{callback:j});var e,f=a.condIds[d];f||(f=[]);for(var g in a.condIds.ALL)e=a.condIds.ALL[g],$.inArray(e,f)>-1?$("#"+e+"_tr").show():$("#"+e+"_tr").hide()},h=function(){var c=b.genCycle.val();"0"==c?(b.genStartDay.parents("[class^=range-]").css("visibility","visible"),b.schPeriodTr.show(),b.week.parents("[class^=range-]").css("visibility","hidden"),slui.attach.setTransformSelect(a.formId+" #schPeriodTr")):(b.genStartDay.parents("[class^=range-]").css("visibility","hidden"),b.schPeriodTr.hide(),"2"==c?b.week.parents("[class^=range-]").css("visibility","visible"):b.week.parents("[class^=range-]").css("visibility","hidden"))},i=function(a){var d,e,f={},g=""==b.genCondition.val()?"{}":$.parseJSON(b.genCondition.val());d="eqp_type_cd",f[d]={title:"전체",key:"ALL",children:[]},e=!(g[d]&&g[d].length>0);for(var h in a){f[d].children.push({title:a[h],isFolder:!1,children:[],select:e||$.inArray(h,g[d])>-1,key:h})}b.eqpTypeTree.dynatree({minExpandLevel:3,checkbox:!0,selectMode:3,children:f[d]}),null==c.tree?c.tree=b.eqpTypeTree.dynatree("getTree"):c.tree.reload()},j=function(a){var d,e,f={},g=""==b.genCondition.val()?"{}":$.parseJSON(b.genCondition.val());d="log_cate_cd",f[d]={title:"전체",key:"ALL",children:[]},e=!(g[d]&&g[d].length>0);for(var h in a){f[d].children.push({title:a[h],isFolder:!1,select:e||$.inArray(h,g[d])>-1,children:[],key:h})}b.logCateTree.dynatree({minExpandLevel:3,checkbox:!0,selectMode:3,children:f[d]}),null==c.tree?c.tree=b.logCateTree.dynatree("getTree"):c.tree.reload()},k=function(a){var d,e,f={},g=""==b.genCondition.val()?"{}":$.parseJSON(b.genCondition.val());d="asset_group_cd",f[d]={title:"전체",key:"ALL",children:[]},e=!(g[d]&&g[d].length>0);for(var h in a){f[d].children.push({title:a[h],isFolder:!1,select:e||$.inArray(h,g[d])>-1,children:[],key:h})}b.assetGrpTree.dynatree({minExpandLevel:3,checkbox:!0,selectMode:3,children:f[d]}),null==c.tree?c.tree=b.assetGrpTree.dynatree("getTree"):c.tree.reload()},l=function(){var d=(1==$(this).data("after-close"),b.form.find("[name=genStartDay]").val()+b.form.find("[name=genStartHour]").val()+b.form.find("[name=genStartMin]").val()),e=b.form.find("[name=schStartDay]").val()+b.form.find("[name=schStartHour]").val()+b.form.find("[name=schStartMin]").val(),f=b.form.find("[name=schEndDay]").val()+b.form.find("[name=schEndHour]").val()+b.form.find("[name=schEndMin]").val(),g=b.genCycle.val();if("0"==g){if(d<f)return void _alert("실행시간이 검색기간보다 커야 합니다.");var h=_SL.formatDate.diff(e,f);if(h<=0)return void _alert("검색기간 종료시간이 시작시간보다 커야 합니다.");if(h/6e4>b.form.find("[name=timeSet] option:last-child").val())return void _alert("검색 기간 초과입니다.")}if(_SL.validate()){var i={},j=b.form.find("[name=report_id] option:selected").data("report-type"),k=a.condIds[j];k||(k=[]);var l,m,o;for(var l in k)m=k[l],o=$("#"+m+"_tree").dynatree("getTree"),o.getNodeByKey("ALL").isSelected()||(i[m]=$.map(o.getSelectedNodes(),function(a){if("_"!=a.data.key.charAt(0))return a.data.key}));var p=b.form.find("[name=file_format_list_chk]:checked").map(function(){return this.value}).get().join(",");b.form.find("[name=file_format_list]").val(p),$.isEmptyObject(i)||b.form.find("[name=gen_condition]").val(JSON.stringify(i)),b.form.find("[name=report_id]").prop("disabled",!1),$("body").requestData(c.mode.action,_SL.serializeMap(b.form),{callback:function(a,b,c){_alert(c,{onAgree:function(){n(!0)}})}})}},m=function(){var c=1==$(this).data("after-close");_confirm("삭제하시겠습니까?",{onAgree:function(){var d=b.scheduleId.val();$("body").requestData(a.urlDelete,{schedule_id:d},{callback:function(a,b,d){_alert(d,{onAgree:function(){n(c)}})}})}})},n=function(a){a&&b.form.find("[data-layer-close=true]").click()};return{init:d}}(),$(function(){slapp.schedule.form.init()});