"use strict";_SL.nmspc("topStatsMng").form=function(){var a={formId:"#formTopStatsMng",urlSelect:gCONTEXT_PATH+"analysis/top_stats_manager.json",urlDelete:gCONTEXT_PATH+"analysis/top_stats_manager_delete.do",urlSyncChk:gCONTEXT_PATH+"analysis/top_stats_manager_sync_check.json",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlQueryChk:gCONTEXT_PATH+"monitoring/log_search_list.json",add:{action:gCONTEXT_PATH+"analysis/top_stats_manager_add.do",message:"등록 하시겠습니까?"},update:{action:gCONTEXT_PATH+"analysis/top_stats_manager_update.do",message:"수정 하시겠습니까?"}},b={form:$(a.formId),itemTable:$(a.formId+" .grid-table-group"),topCode:$(a.formId+" [name=top_code]"),fieldSelBox:$(a.formId+" [name=field_sel_box]"),operatorSelBox:$(a.formId+" [name=operator_sel_box]"),sysValSelBox:$(a.formId+" [name=sysval_sel_box]"),searchQuery:$(a.formId+" [name=org_search_condition]")},c={isNew:""==b.topCode.val(),mode:""==b.topCode.val()?a.add:a.update},d=[],e=function(){f(),h(),c.isNew&&b.form.find(".btn-delete").hide()},f=function(){c.isNew?g():(b.itemTable.find("tbody").empty(),j())},g=function(){b.form.find("[name=group_field]").each(function(a,b){0==a&&$(this).prop("disabled",!0),i($(this),"m")}),b.form.find("[name=field_nm]").each(function(){i($(this),"s")})},h=function(){b.form.find(".btn-save").on("click",k),b.form.find(".btn-delete").on("click",n),b.fieldSelBox.chosen({search_contains:!0,width:"100%"}),b.fieldSelBox.on("change",p),b.operatorSelBox.on("change",q),b.form.find(".btn-case").on("click",s),b.sysValSelBox.chosen({search_contains:!0,width:"100%"}),b.sysValSelBox.on("change",r),b.form.find(".btn-plus").on("click",function(a){t()}),b.form.on("click",".btn-minus",function(){$(this).parent().parent().remove()}),b.form.on("change","[name=func]",u)},i=function(a,b){$.each(gFieldCaptions,function(b,c){a.append($("<option value='"+b+"'>"+c+" ["+b+"]</option>"))});var c=a.data("sel-value");if("m"==b){var d=c.split(",");a.chosen({search_contains:!0,placeholder_text_multiple:"[선택하세요]",width:"100%"}),c&&a.setSelectionOrder(d,!0)}else a.val(c),a.chosen({width:"100%"}),a.trigger("chosen:updated")},j=function(){var c=b.topCode.val(),d={top_code:c},e=function(a){_SL.setDataToForm(a,b.form);var c=a.itemList;for(var d in c)t(c[d]);g()};$("body").requestData(a.urlSelect,d,{callback:e})},k=function(){if(b.form.find("[name=delete_yn]").val("N"),_SL.validate(b.form)&&m())if(c.isNew)l();else{var e={top_code:b.topCode.val(),org_search_condition:b.searchQuery.val(),item_list:d};$("body").requestData(a.urlSyncChk,e,{callback:function(a){a?l():_confirm("통계관련설정이 수정 되었으므로<br>기존의 통계 데이터는 삭제됩니다.",{onAgree:function(){b.form.find("[name=delete_yn]").val("Y"),l()}})}})}},l=function(){var e=_SL.formatDate(),f=_SL.formatDate.addMin(e,-60),g=b.searchQuery.val(),h=b.form.find("[name=log_max_cnt]").val(),i={end_time:e,start_time:f,query:g,pageRow:1,startIndex:0};$("body").requestData(a.urlQueryChk,i,{callback:function(a,e,f){return a.total>h?void _alert("검색결과가 최대건수를 초과했습니다.<br>\t\t\t\t\t\t\tCase검증을 이용해 확인해 주세요.<br>\t\t\t\t\t\t\t(검색결과 "+_SL.formatNumber(a.total)+"건)\t\t\t\t\t\t\t(최대건수 "+_SL.formatNumber(h)+"건)"):void $("body").requestData(c.mode.action,$.extend({},_SL.serializeMap(b.form),{item_list_json:d}),{callback:function(a,b,c){_alert(c,{onAgree:function(){o(!0,a.top_code)}})}})}})},m=function(){d=[];for(var a=b.itemTable,c=a.find("tr").length-1,e=!0,f=0;f<c;f++){var g=$("[name=group_field]").eq(f).getSelectionOrder(),h=g.join(),i=$("[name=func]").eq(f).val(),j=$("[name=field_nm]").eq(f).val();if(!g.join())return _alert("기준필드를 선택해 주세요."),void(e=!1);if("count"!=i&&""==j)return _alert("통계필드를 선택해 주세요."),void(e=!1);d.push({item_seq:f+1,view_type:$.trim($("[name=view_type]").eq(f).data("sel-value")),group_fields:h,func:i,field_nm:j})}return e},n=function(){var c=1==$(this).data("after-close");_confirm("삭제하시겠습니까?",{onAgree:function(){$("body").requestData(a.urlDelete,{top_code:b.topCode.val()},{callback:function(a,b,d){_alert(d,{onAgree:function(){o(c)}})}})}})},o=function(a,c){var d=0;a&&(b.form.find("[data-layer-close=true]").click(),c&&(d=c,slapp.topstats.list.drawStatsInit(d)))},p=function(){var a=b.searchQuery,c=b.fieldSelBox;a.focus();var d=$.trim(a.val()),e=c.val();""!=e&&(d+=""==d?"":"+"==d.charAt(d.length-1)?"":" ",a.val(d+e+":"),c.val(""),a.focus())},q=function(){var a=b.searchQuery,c=b.operatorSelBox;a.focus();var d=$.trim(a.val()),e=c.val();""!=e&&(""!=d&&"AND,OR,NOT,+".indexOf(e)!=-1&&(e=" "+e),a.val(d+e),c.val(""),a.focus())},r=function(){var a=$(this).val(),c=b.searchQuery,d=$.trim(c.val());d+=""==d?"":"+"==d.charAt(d.length-1)?"":" ",c.val(d+"SYSVAR("+a+")"),$(this).val(""),b.sysValSelBox.trigger("chosen:updated")},s=function(){var c=_SL.formatDate(),d=_SL.formatDate.addMin(c,-60),e=b.searchQuery.val();if(""==e)return void _alert("검색어가 없습니다.");var f=b.form.find("[name='logSearchForm']");0==f.length&&(f=$('<form name="logSearchForm">'),f.append('<input type="hidden" name="start_time">'),f.append('<input type="hidden" name="end_time">'),f.append('<input type="hidden" name="filter_type">'),f.append('<input type="hidden" name="expert_keyword">'),f.append('<input type="hidden" name="template_id" value="popup">'),b.form.append(f)),$("[name=start_time]",f).val(d),$("[name=end_time]",f).val(c),$("[name=filter_type]",f).val("2"),$("[name=expert_keyword]",f).val(e);var g="logSearchWin_"+(new Date).getTime();f.attr({target:g,action:a.urlLogSearch}).submit()},t=function(){var c=b.itemTable.find("tbody"),d=$("<tr>");if(arguments[0]){var e=arguments[0],f=e.view_type,g=e.group_fields,h=e.func,j=e.field_nm;d.append($('<td>\t\t\t\t\t\t\t<input type="text" name="view_type" value="'+("L"==f?"TimeLine":"TOP")+'" data-sel-value="'+f+'" class="form-input form-block" readonly="readonly">\t\t\t\t\t\t</td>')),d.append($('<td>\t\t\t\t\t\t\t<select name="group_field" data-sel-value="'+g+'" class="form-select" multiple="multiple"></select>\t\t\t\t\t\t</td>')),d.append($('<td><div class="ranges-group">\t\t\t\t\t\t\t<div class="range-2"><select name="func" class="form-select" data-scroll="false">\t\t\t\t\t\t\t\t<option value="count"'+("count"==h?" selected":"")+'>Count</option>\t\t\t\t\t\t\t\t<option value="sum"'+("sum"==h?" selected":"")+'>SUM</option>\t\t\t\t\t\t\t\t<option value="avg"'+("avg"==h?" selected":"")+'>AVG</option>\t\t\t\t\t\t\t\t<option value="max"'+("max"==h?" selected":"")+'>MAX</option>\t\t\t\t\t\t\t\t<option value="min"'+("min"==h?" selected":"")+'>MIN</option>\t\t\t\t\t\t\t</select></div>\t\t\t\t\t\t\t<div class="range-8"><select name="field_nm" data-sel-value="'+j+'" data-ui="false" disabled="disabled">\t\t\t\t\t\t\t\t<option value="">[선택하세요]</option>\t\t\t\t\t\t\t</select></div>\t\t\t\t\t\t</div></td>')),"L"==f?d.append("<td></td>"):d.append('<td><button type="button" class="btn-basic btn-mini btn-minus"><i class="icon-minus"></i></button></td>'),d.appendTo(c)}else{d.append($('<td>\t\t\t\t\t\t\t<input type="text" name="view_type" value="Top" data-sel-value="T" class="form-input form-block" readonly="readonly">\t\t\t\t\t\t</td>')),d.append($('<td>\t\t\t\t\t\t\t<select name="group_field" data-sel-value="" class="form-select" multiple="multiple"></select>\t\t\t\t\t\t</td>')),d.append($('<td><div class="ranges-group">\t\t\t\t\t\t\t<div class="range-2"><select name="func" class="form-select" data-scroll="false">\t\t\t\t\t\t\t\t<option value="count">Count</option>\t\t\t\t\t\t\t\t<option value="sum">SUM</option>\t\t\t\t\t\t\t\t<option value="avg">AVG</option>\t\t\t\t\t\t\t\t<option value="max">MAX</option>\t\t\t\t\t\t\t\t<option value="min">MIN</option>\t\t\t\t\t\t\t</select></div>\t\t\t\t\t\t\t<div class="range-8"><select name="field_nm" data-sel-value="" data-ui="false" disabled="disabled">\t\t\t\t\t\t\t\t<option value="">[선택하세요]</option>\t\t\t\t\t\t\t</select></div>\t\t\t\t\t\t</div></td>')),d.append($('<td>\t\t\t\t\t\t\t<button type="button" class="btn-basic btn-mini btn-minus"><i class="icon-minus"></i></button>\t\t\t\t\t\t</td>')),d.appendTo(c);var k=d.find("[name=group_field]"),l=d.find("[name=field_nm]");i(k,"m"),i(l,"s")}d.parents(".nano").size()>0&&d.parents(".nano").nanoScroller(),slui.attach.setTransformSelect(a.formId)},u=function(){var a=$(this).val(),b=$(this).parents("tr");"count"==a?(b.find("[name=field_nm]").val(""),b.find("[name=field_nm]").prop("disabled",!0),b.find("[name=field_nm]").trigger("chosen:updated")):(b.find("[name=field_nm]").prop("disabled",!1),b.find("[name=field_nm]").trigger("chosen:updated"))};return{init:e}}(),$(function(){slapp.topStatsMng.form.init()});