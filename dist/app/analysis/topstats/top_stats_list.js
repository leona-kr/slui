"use strict";_SL.nmspc("topstats").list=function(){var a,b,c={urlList:gCONTEXT_PATH+"analysis/top_stats_list.json",urlMngUseList:gCONTEXT_PATH+"analysis/top_stats_manager_use_list.json",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlMngForm:gCONTEXT_PATH+"analysis/top_stats_manager_form.html",urlDelete:gCONTEXT_PATH+"analysis/top_stats_manager_delete.do",urlMngList:gCONTEXT_PATH+"analysis/top_stats_manager_list.html",urlMngCnt:gCONTEXT_PATH+"analysis/top_stats_manager_count.json",formId:"#searchTopStatsForm",etcFormId:"#topStatsEtcForm",letfSectionId:"#topStatsLetfSection",totalTimeContId:"#totalTimeContainer",btnMngId:"#btnSettingTopStats"},d={form:$(c.formId),etcForm:$(c.etcFormId),leftSection:$(c.letfSectionId),totalTimeCont:$(c.totalTimeContId),btnMng:$(c.btnMngId),areaBody:$(c.totalTimeContId).parent(),timeSet:$(c.formId+" [name=timeSet]"),sDay:$(c.formId+" [name=startDay]"),sHour:$(c.formId+" [name=startHour]"),sMin:$(c.formId+" [name=startMin]"),eDay:$(c.formId+" [name=endDay]"),eHour:$(c.formId+" [name=endHour]"),eMin:$(c.formId+" [name=endMin]"),schType:$(c.formId+" [name=search_type]")},e=function(){g(0),f(),_SL.formatNumber.Options.decimals=2},f=function(){d.form.find(".btn-submit").off().on("click",function(){var a=d.sDay.val()+d.sHour.val()+d.sMin.val(),b=d.eDay.val()+d.eHour.val()+d.eMin.val(),c=_SL.formatDate.diff(a,b)/36e5;if(c<=0)return void _alert("시작일이 종료일보다 큽니다.");var e="statistics"==d.form.find("[name=search_type]:checked").val();return c>2&&!e?void _alert("실시간 검색범위는 최대 2시간입니다.\n2시간 이상 조회는 '통계' 구분을 선택하세요."):void o()}),d.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var b=function(a,b){var c=a.siblings(".tform-select");c.find(".tform-select-t").text(b).end().find(".tform-select-option[data-value="+b+"]").addClass("selected").end(),a.val(b)},c=_SL.formatDate.addMin(d.form.find("[name=endDay]").val()+d.form.find("[name=endHour]").val()+d.form.find("[name=endMin]").val(),-a);b(d.form.find("[name=startDay]"),c.substring(0,8)),b(d.form.find("[name=startHour]"),c.substring(8,10)),b(d.form.find("[name=startMin]"),c.substring(10,12))}}),d.form.find("[name=startDay],[name=startHour],[name=startMin],[name=endDay],[name=endHour],[name=endMin]").change(function(){var a=d.form.find("[name=timeSet]"),b=a.siblings(".tform-select").find("[data-value=0]").text();a.val(0).siblings(".tform-select").find(".tform-select-t").text(b)}),d.schType.off().on("click",function(){var a="statistics"==$(this).val(),b=[{val:0,text:"[User Define]"},{val:5,text:"last 5 min"},{val:10,text:"last 10 min"},{val:30,text:"last 30 min"},{val:60,text:"last 1 Hour"},{val:360,text:"last 6 Hour"},{val:720,text:"last 12 Hour"},{val:1440,text:"last 1 Day"},{val:10080,text:"last 7 Day"},{val:43200,text:"last 30 Day"}],e=a?43200:120,f=a?60:5;d.form.find("[name=startMin],[name=endMin]").attr("disabled",a),d.timeSet.empty();for(var g in b)(e>=b[g].val&&f<=b[g].val||0==b[g].val)&&$("<option/>").val(b[g].val).text(b[g].text).appendTo(d.timeSet);var h=60*(a?24:1),i=_SL.formatDate(),j=i;j=a?_SL.formatDate.addMin(j,-60):j,i=_SL.formatDate.addMin(j,-h),d.timeSet.val("0"),d.sDay.val(i.substring(0,8)),d.sHour.val(i.substring(8,10)),d.eDay.val(j.substring(0,8)),d.eHour.val(j.substring(8,10)),slui.attach.setTransformSelect(c.formId)}),d.leftSection.off().on("click",".mngListLink",function(){return d.leftSection.find(".selected").removeClass("selected"),$(this).parent().addClass("selected"),i(),!1}),d.etcForm.find("[name=row]").change(o),d.leftSection.find(".btn-add").off().on("click",function(){$("body").requestData(c.urlMngCnt,{},{callback:function(a,b,d){return menuMaxCount<=a?void _alert("통계의 최대 등록개수는<br>"+menuMaxCount+"개 입니다."):void m(c.urlMngForm)}})}),d.leftSection.find(".btn-modify").off().on("click",function(){var a=d.leftSection.find(".selected").data("top-code");m(c.urlMngForm+"?top_code="+a)}),d.leftSection.find(".btn-delete").off().on("click",function(){var a=d.leftSection.find(".selected").data("top-code");_confirm("삭제하시겠습니까?",{onAgree:function(){$("body").requestData(c.urlDelete,{top_code:a},{callback:function(a,b,c){g(0),_alert(c)}})}})}),d.btnMng.off().on("click",function(){new ModalPopup(c.urlMngList,{width:450,height:450,onClose:function(){}})})},g=function(a){$("body").requestData(c.urlMngUseList,{},{callback:function(b,c,e){var f=d.leftSection.find(".defined-list");f.children().remove(),h(b,a),i()}})},h=function(a,b){var e=d.leftSection.find(".defined-list");for(var f in a){var g=a[f],h=$('<li data-top-code="'+g.top_code+'">');h.append($('<a class="mngListLink" href="#" data-top-code="'+g.top_code+'" title="'+g.top_name+'">'+g.top_name+"</a>")),0==b?0==f&&h.addClass("selected"):b==g.top_code&&h.addClass("selected"),e.append(h)}slui.sectionCols.userlist(c.letfSectionId)},i=function(){var e=d.leftSection.find(".selected").data("top-code"),f=$.extend({},_SL.serializeMap(d.form),{top_code:e,pageRow:d.etcForm.find("[name=row]").val()});$("body").requestData(c.urlList,f,{displayLoader:!0,callback:function(d,e,f){if(e.indexOf("SUC")==-1)return!1;if($(c.totalTimeContId).siblings(".item-board").remove(),d){var g=d.searchType;a=d.rsListByItemNo,b=d.topMng,"statistics"==g?j(d):k(d)}}})},j=function(b){if(d.totalTimeCont.show(),b.calcTimeTotal){var c=b.calcTimeTotal,e=b.totalCount;d.totalTimeCont.find(".sDayTime").text(c.sDayTime+":00"),d.totalTimeCont.find(".eDayTime").text(c.eDayTime+":00"),d.totalTimeCont.find(".totCnt").text(_SL.formatNumber(e)),d.totalTimeCont.find(".dayAvgCnt").text(_SL.formatNumber(c.day_avg_cnt)),d.totalTimeCont.find(".WDCnt1").text(_SL.formatNumber(c.weekday_cnt_1)),d.totalTimeCont.find(".WDCntRate1").text(_SL.formatNumber(0==e?0:c.weekday_cnt_1/e*100)),d.totalTimeCont.find(".WDCnt2").text(_SL.formatNumber(c.weekday_cnt_2)),d.totalTimeCont.find(".WDCntRate2").text(_SL.formatNumber(0==e?0:c.weekday_cnt_2/e*100)),d.totalTimeCont.find(".WDTotCnt").text(_SL.formatNumber(c.weekday_cnt_1+c.weekday_cnt_2)),d.totalTimeCont.find(".WDTotRate").text(_SL.formatNumber(0==e?0:(c.weekday_cnt_1+c.weekday_cnt_2)/e*100)),d.totalTimeCont.find(".WDTotAvg").text(_SL.formatNumber(c.weekday_avg_cnt)),d.totalTimeCont.find(".WECnt1").text(_SL.formatNumber(c.weekend_cnt_1)),d.totalTimeCont.find(".WECntRate1").text(_SL.formatNumber(0==e?0:c.weekend_cnt_1/e*100)),d.totalTimeCont.find(".WECnt2").text(_SL.formatNumber(c.weekend_cnt_2)),d.totalTimeCont.find(".WECntRate2").text(_SL.formatNumber(0==e?0:c.weekend_cnt_2/e*100)),d.totalTimeCont.find(".WETotCnt").text(_SL.formatNumber(c.weekend_cnt_1+c.weekend_cnt_2)),d.totalTimeCont.find(".WETotRate").text(_SL.formatNumber(0==e?0:(c.weekend_cnt_1+c.weekend_cnt_2)/e*100)),d.totalTimeCont.find(".WETotAvg").text(_SL.formatNumber(c.weekend_avg_cnt)),d.areaBody.append($('<div class="item-board">\t\t\t\t<div class="board-head">\t\t\t\t\t요일별현황\t\t\t\t\t<div class="btns-group">\t\t\t\t\t\t<button type="button" class="btn-toggle" data-toggle-handle="true" data-toggle-target="#weekContainer" data-toggle-class="hide"><i class="icon-chevron-up"></i></button>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="board-body" id="weekContainer">\t\t\t\t\t<div class="area-chart">\t\t\t\t\t\t<div id="weekChartContainer"></div>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>')),d.areaBody.append($('<div class="item-board">\t\t\t\t<div class="board-head">\t\t\t\t\t시간별현황\t\t\t\t\t<div class="btns-group">\t\t\t\t\t\t<button type="button" class="btn-toggle" data-toggle-handle="true" data-toggle-target="#timeContainer" data-toggle-class="hide"><i class="icon-chevron-up"></i></button>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="board-body" id="timeContainer">\t\t\t\t\t<div class="area-chart">\t\t\t\t\t\t<div id="timeChartContainer"></div>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>')),p=$.extend({},slui.chart.chartConfig,p),q=$.extend({},slui.chart.chartConfig,q);var f=(new FusionCharts({type:"column2d",renderAt:"weekChartContainer",width:"100%",height:200,dataFormat:"json",dataSource:{chart:p,data:[{label:"Mon",toolText:"Mon, "+_SL.formatNumber(c.week_1),value:c.week_1},{label:"Tue",toolText:"Tue, "+_SL.formatNumber(c.week_2),value:c.week_2},{label:"Wed",toolText:"Wed, "+_SL.formatNumber(c.week_3),value:c.week_3},{label:"Thu",toolText:"Thu, "+_SL.formatNumber(c.week_4),value:c.week_4},{label:"Fri",toolText:"Fri, "+_SL.formatNumber(c.week_5),value:c.week_5},{label:"Sat",toolText:"Sat, "+_SL.formatNumber(c.week_6),value:c.week_6},{label:"Sun",toolText:"Sun, "+_SL.formatNumber(c.week_0),value:c.week_0}]}}).render(),[]),g=_SL.formatNumber(c.eDayTime),h=a.time_list;for(var i in h){var j=h[i],k={};k.label=j.time.toString(),k.toolText=j.time+" , "+_SL.formatNumber(j.total),k.value=j.total,f.push(k),j.time==g&&(f.push({vline:!0,label:" 주간 ",dashed:"1",dashLen:"3",dashGap:"2",labelHAlign:"right"}),f.push({vline:!0,label:" 야간 ",dashed:"1",dashLen:"3",dashGap:"2",labelHAlign:"left"}))}var m=(new FusionCharts({type:"area2d",renderAt:"timeChartContainer",width:"100%",height:200,dataFormat:"json",dataSource:{chart:q,data:$.extend([],f)}}).render(),b.itemList),n=b.rsListByItemNo;l(m,n),slui.attach.setToggleLayer(".section-content")}},k=function(b){if(d.totalTimeCont.hide(),a){d.areaBody.append($('<div class="item-board item-board-wide">\t\t\t\t<div class="board-head">\t\t\t\t\t시간별현황\t\t\t\t\t<div class="btns-group">\t\t\t\t\t\t<button type="button" class="btn-toggle" data-toggle-handle="true" data-toggle-target="#timeContainer" data-toggle-class="hide"><i class="icon-chevron-up"></i></button>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="board-body" id="timeContainer">\t\t\t\t\t<div class="area-chart">\t\t\t\t\t\t<div id="timeChartContainer"></div>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t</div>'));var c=[],e=a.time_list;for(var f in e){var g=e[f],h={};h.label=_SL.formatDate(g.eqp_dt,"yyyyMMddHHmm","HH:mm"),h.toolText=_SL.formatDate(g.eqp_dt,"yyyyMMddHHmm","yyyy-MM-dd HH:mm")+" , "+_SL.formatNumber(g.total),h.value=g.total,c.push(h)}var i=(new FusionCharts({type:"area2d",renderAt:"timeChartContainer",width:"100%",height:200,dataFormat:"json",dataSource:{chart:$.extend({},q),data:$.extend([],c)}}).render(),b.itemList),j=b.rsListByItemNo;l(i,j)}},l=function(a,b){for(var c in a){var e=a[c],f=e.func.toUpperCase(),g=(e.func_field,e.group_fields),h=e.convtFuncFldNm?e.convtFuncFldNm:"",i=e.convtFldNm,j=e.item_seq,k="item_"+j+"_list",l=e.fieldNmArr;d.areaBody.append($('<div class="item-board">\t\t\t\t\t<div class="board-head">'+i+'별 순위<div class="btns-group">\t\t\t\t\t\t\t<button type="button" class="btn-toggle" data-toggle-handle="true" data-toggle-target="#'+c+'ItemContainer" data-toggle-class="hide"><i class="icon-chevron-up"></i></button>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<div class="board-body" id="'+c+'ItemContainer">\t\t\t\t\t\t<div class="area-chart">\t\t\t\t\t\t\t<div id="'+c+'ChartContainer"></div>\t\t\t\t\t\t</div>\t\t\t\t\t\t<div class="area-table">\t\t\t\t\t\t\t<div id="'+c+'ListContainer"></div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t</div>'));var m=d.etcForm.find("[name=row]").val(),n=[],o=b[k];for(var q in o){var r=o[q];if("기타"!=r[g]){var s={label:_SL.javascriptEscape(r[g]),toolText:_SL.javascriptEscape(r[g])+", "+_SL.formatNumber(r.func_value),link:"javascript:slapp.topstats.list.goSearchPopup('"+j+"', '"+q+"', '"+g+"')",value:r.func_value};n.push(s)}}new FusionCharts({type:"bar2d",renderAt:c+"ChartContainer",width:"100%",height:10!=m?200:250,dataFormat:"json",dataSource:{chart:$.extend({},p,{xAxisName:i,yAxisName:f+(h?"("+h+")":"")}),data:$.extend([],n)}}).render();var t=$("#"+c+"ListContainer"),u=$("<table class='board-table-group'></table>"),v=$("<thead />").appendTo(u),w=$("<tbody />").appendTo(u),x=$("<tr />"),y=15,z=e.convtFldNmArr;x.append($('<th width="10%">순번</th>'));for(var q in z)x.append($("<th>"+z[q]+"</th>"));if(x.append($('<th width="20%">'+f+(h?"("+h+")":"")+"</th>")).append($('<th width="20%">비율</th>')).appendTo(v),0==o.length){var A=$("<tr>");A.append($("<td class='align-center' colspan='"+y+"'>There is no Search Result</td>")),A.appendTo(u)}else for(var q in o){var A=$("<tr>"),r=o[q];"기타"!=r[g]?A.append($("<td class='align-center'>"+(parseInt(q)+1)+"</td>")):A.append($("<td class='align-center'>기타</td>"));for(var B in l){var C=l[B];r[C]?A.append($("<td><a href='#' onclick='slapp.topstats.list.goSearchPopup(\""+j+'","'+q+'","'+g+"\")'>"+r[C]+"</a></td>")):A.append($("<td>"))}A.append($("<td class='align-right'>"+_SL.formatNumber(r.func_value)+"</td>")),0==e.totalCount?A.append($("<td class='align-right'>"+_SL.formatNumber(e.totalCount)+"%</td>")):A.append($("<td class='align-right'>"+_SL.formatNumber(r.func_value/e.totalCount*100)+"%</td>")),A.appendTo(w)}u.appendTo(t)}},m=function(a){new ModalPopup(a,{width:850,height:400,onClose:function(){}})},n=function(e,f,g){var h,i="item_"+e+"_list",j=g.split(","),k=d.sDay.val()+d.sHour.val()+d.sMin.val(),l=d.eDay.val()+d.eHour.val()+d.eMin.val(),m="("+b.search_condition+")",n=a[i][f],o=/.*\[(\d+)\]$/;for(var p in j)if(h=n[j[p]],""!=m&&(m+=" AND "),"-"==h)m+="NOT "+j[p]+":*";else{var q=h.match(o);q&&q[1]&&(h=q[1]),m+=j[p]+":"+_SL.luceneValueEscape(h)}var r=d.form.find("[name='logSearchForm']");0==r.length&&(r=$('<form name="logSearchForm">\t\t\t\t\t<input type="hidden" name="start_time">\t\t\t\t\t<input type="hidden" name="end_time">\t\t\t\t\t<input type="hidden" name="filter_type">\t\t\t\t\t<input type="hidden" name="expert_keyword">\t\t\t\t\t<input type="hidden" name="template_id" value="popup">').appendTo(d.form)),$("[name=start_time]",r).val(k),$("[name=end_time]",r).val(l),$("[name=filter_type]",r).val("2"),$("[name=expert_keyword]",r).val(m);var s="logSearchWin_"+(new Date).getTime();r.attr({target:s,action:c.urlLogSearch}).submit()},o=function(){i()},p={paletteColors:"#89cf43,#dddddd,#dddddd,#dddddd,#dddddd,#dddddd,#dddddd,#dddddd,#dddddd,#dddddd",maxLabelWidthPercent:"20"},q={paletteColors:"#89cf43",showvalues:"0",plotfillalpha:"70"};return{init:e,goSearchPopup:n,drawStatsInit:g}}(),$(function(){slapp.topstats.list.init()});