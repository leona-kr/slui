"use strict";_SL.nmspc("bigFileData").form=function(){var a,b=null,c=[],d={"\\|":" ex> 53018000|80|20150202142523|192.168.1.1","\\s":" ex> 53018000 80 20150202142523 192.168.1.1","\\t":" ex> 53018000\t80\t20150202142523\t192.168.1.1",",":" ex> 53018000,80,20150202142523,192.168.1.1",Csv:' ex> "53018000","80","20150202142523","192.168.1.1"',Json:' ex> {"inst_cd":"53018000","port":"80","eqp_dt":"20150202142523","eqp_ip":"192.168.1.1"}',"Key&Value":' ex> inst_cd="53018000" port="80" eqp_dt="20150202142523" eqp_ip="192.168.1.1"',"Key&Value2":' ex> "inst_cd":"53018000","port":"80","eqp_dt":"20150202142523","eqp_ip":"192.168.1.1"'},e={urlFormData:gCONTEXT_PATH+"analysis/big_file_data_form.json",urlNormData:gCONTEXT_PATH+"analysis/big_file_data_normalize.json",urlForm:gCONTEXT_PATH+"analysis/big_file_data_form.html",urlAdd:gCONTEXT_PATH+"analysis/big_file_data_insert.do",urlNewForm:gCONTEXT_PATH+"management/log_parser_manager_form.html",formId:"#formBigFileData"},f={form:$(e.formId),rsTable:$(e.formId+" #result_table"),rsParser:$(e.formId+" #result_parser"),fileInfo:$(e.formId+" #file_info"),subContner:$(e.formId+" #sub_container"),fldSeprVw:$(e.formId+" [data-id=field_separator_view]"),logPsrVw:$(e.formId+" #log_psr_view"),seprTip:$(e.formId+" #separator_tip"),logPsrId:$(e.formId+" [name=log_psr_id]"),fldSepr:$(e.formId+" [name=field_separator]"),seprTyp:$(e.formId+" [name=separator_type]"),normizeTyp:$(e.formId+" [name=normalize_type]"),cutLineCnt:$(e.formId+" [name=cut_line_count]"),logFile:$(e.formId+" [name=log_file]"),fldList:$(e.formId+" [name=fld_list]"),fieldList:$(e.formId+" [name=field_list]"),logList:$(e.formId+" [name=log_list]"),fileChrset:$(e.formId+" [name=file_charset]"),btnLogPsr:$(e.formId+" .btn-log-psr-add")},g=function(){h(),k(),j(),m(),l()},h=function(){f.form.find(".btn-save").on("click",r),f.form.find(".btn-reset").on("click",s),i(),f.btnLogPsr.exModalPopup(e.urlNewForm,{width:800,height:500,onClose:function(){}});var a;f.form.find("[name=field_separator], [name=cut_line_count]").keyup(function(c){var d=$(this);a&&clearTimeout(a),a=setTimeout(function(){d.data("old",d.data("new")||""),d.data("new",d.val()),d.data("old")!=d.data("new")&&n(b),a=null},500)})},i=function(){f.normizeTyp.change(function(){m(),l()}),f.seprTyp.change(function(){var a=$(this).val();f.fldSepr.val($(this).val()),f.seprTip.html(d[a]),n(b)}),f.logFile.change(function(a){b=this.files[0],n(b)}),f.form.find("[name=file_charset], [name=log_psr_id]").change(function(a){n(b)})},j=function(){var b=function(b){var c=b.logParserList,d=b.fldListCodes,g=b.LIMIT_COUNT;a=null==g?10:g;for(var h in c){var i=c[h];f.logPsrId.append($("<option value='"+i.log_psr_id+"'>"+i.log_psr_nm+"</option>"))}f.logPsrId.trigger("chosen:updated");for(var j in d){var k=d[j];f.fldList.append($("<option value='"+j+"'>"+k+"("+j+")</option>"))}slui.attach.setTransformSelect(e.formId)};$("body").requestData(e.urlFormData,{},{callback:b})},k=function(){f.logPsrId.chosen({search_contains:!0})},l=function(){switch(f.fldSeprVw.hide(),f.logPsrVw.hide(),f.normizeTyp.val()){case"1":f.fldSeprVw.show();break;case"2":f.form.find("#separator_tip").html(""),f.logPsrVw.show()}slui.attach.setTransformSelect(e.formId)},m=function(){loading.hide(),b=null,f.form.find("#file_info, #result_table").empty(),f.form.find("[name=separator_type]").val("\\|"),f.fldSepr.val("\\|"),f.seprTip.html(d["\\|"]),f.cutLineCnt.val("0"),f.fileChrset.val("UTF-8"),f.logFile.val(""),slui.attach.setTransformSelect(e.formId)},n=function(b){if(b){if("1"==f.normizeTyp.val()&&!_SL.validate("[name=field_separator]")||!_SL.validate("[name=cut_line_count]"))return void m();if(f.rsTable.empty(),f.fileInfo.empty(),b){var c=new FileReader;c.onloadstart=function(a){loading.show()},c.onerror=function(a){loading.hide(),_alert(a.target.error.name+"\n"+a.target.error.message)},c.onloadend=function(b){var d=c.result.split("\n"),e=(d.length,[]),g=parseInt(f.cutLineCnt.val()),h=g+a;e=d.slice(g,h),e.length>0?(o(e),p(d.length,b.total)):(loading.hide(),_alert("미리보기 할 로그가 없습니다."))},c.onprogress=function(a){loading.show()},c.readAsText(b,f.form.find("[name=file_charset]").val())}}},o=function(a){loading.show();var b={log_list:a,normalize_type:f.normizeTyp.val()};"1"==f.normizeTyp.val()?b.field_separator=f.fldSepr.val():b.log_psr_id=f.logPsrId.val(),$("body").requestData(e.urlNormData,b,{callback:function(a){switch(a.RESULT_CODE){case"000":var b=f.form.find("#result_table").empty().show(),d=0,e=120,g=f.rsParser.width()-70,h=a.normalizeList,i=a.fieldNameList;d=i.length,e=parseInt(g>=e*d?g/d:e);var j,k=$("<tr></tr>");for(var l in i){var m=f.fldList.clone().show();m.removeClass("field_list").addClass("fld_list"),m.attr("id","fld_list_"+l),m.css("width",e-10),j=i[l],(j.match("^field")||$.inArray(j,c)==-1)&&(j="field"+l,$("<option>").val(j).text(j).appendTo(m));var n=$("<th></th>").append(m).css({width:e});k.append(n),k.appendTo(b),m.val(j)}f.form.find(".fld_list").chosen({search_contains:!0}),f.form.find(".fld_list").trigger("chosen:updated");var o;for(var p in h){o=h[p];var k=$("<tr></tr>");if(o.hasOwnProperty("normalize_result")&&"000"!=o.normalize_result){var q=$("<td></td>").attr("colspan",i.length).addClass("align_left").addClass("txt-elps");q.append("[Invalid Log Format] ").append(o.original_log),k.append(q),k.appendTo(b)}else{var l,r;for(var s in i){l=i[s],r=o[l];var q=$("<td></td>").append(r).attr("title",r).addClass("txt-elps");k.append(q)}k.appendTo(b)}}f.rsParser.css({"max-width":f.subContner.width()}).css("overflow-y","auto"),loading.hide();break;case"002":_alert("미리보기 할 로그가 없습니다.")}}})},p=function(a,b){b>0&&f.fileInfo.text("[ Total "+_SL.toComma(a)+" Lines, "+q(b)+" ]")},q=function(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Bytes";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return 0==c?a+" "+b[c]:(a/Math.pow(1024,c)).toFixed(1)+" "+b[c]},r=function(){1==$(this).data("after-close");if(_SL.validate(f.form)){if(f.fldList.val(""),"1"==f.normizeTyp.val()){var a=$.map($(".fld_list option:selected"),function(a){return a.value});f.fieldList.val(a.join(","))}f.form.attr({method:"POST",enctype:"multipart/form-data",encoding:"multipart/form-data",action:e.urlAdd}),f.form.ajaxSubmit({success:function(a,b,c,d){"SUC_COM_0001"==a?(_alert("처리 되었습니다."),t(!0)):_alert("처리 중 오류가 발생 하였습니다.")}})}},s=function(){l(),m()},t=function(a){a&&f.form.find("[data-layer-close=true]").click()};return{init:g}}(),$(function(){slapp.bigFileData.form.init()});