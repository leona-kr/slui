"use strict";_SL.nmspc("component").big_stats=function(a,b,c){var d=a,e=gCONTEXT_PATH+"component/last_complete_big_code.json",f=gCONTEXT_PATH+"component/big_stats_item_info.json",g=gCONTEXT_PATH+"component/big_stats_item_list.json",h=gCONTEXT_PATH+"component/big_stats_field_list.json",i=gCONTEXT_PATH+"analysis/big_stats_rs_timeline.json",j=gCONTEXT_PATH+"analysis/big_stats_rs_list.json",k=gCONTEXT_PATH+"monitoring/log_search.html",l=b,m=c,n=!1,o=!1,p={view_type:"L",chart_height:180,list_height:150,order_by:"DESC",series_rows:10,rows:10},q={body:$("#componentbody_"+d),chart:$("#chart_"+d),logTable:$("#list_table_"+d),config:$("#config_"+d),form:$("#config_"+d+" form")},r={oChart:null,DatasetList:[],dataList:[],FieldList:[],lastBigCode:0,bMultiGroup:!1,bChangeConfig:!1,bInitItemInfo:!1,bUserOnChange:!1},s=_SL.nmspc("CONTEXT_DATA"),t={A:{type:"area2d",height:180},MA:{type:"msarea",height:180},B:{type:"bar2d",height:180},MB:{type:"msbar2d",height:180},C:{type:"column2d",height:180},MC:{type:"mscolumn2d",height:180},L:{type:"line",height:180},ML:{type:"msline",height:180},S:{type:"column2d",height:180},MS:{type:"stackedcolumn2d",height:180},P:{type:"pie3d",height:180}},u=function(){gDFD.fldToCodes.ready(),this.config_param=l=$.extend({},p,l),ka=$.extend(this.chartstyles,ka),z(t.MA.type),$(".dnd_field_pannel>ul",q.form).sortable({opacity:.5,items:"li:not(.ui-state-disabled)",connectWith:".dnd_field_pannel>ul"}),$(".dnd_field_pannel>ul>li",q.form).disableSelection(),$("[name=item_key]",q.form).off("change").on("change",function(a){W($(":selected",this).text(),$(this).val())}),v()},v=function(){if(!n&&!o&&l.schedule_id){var a=$.Deferred();!r.bInitItemInfo&&l.schedule_id&&l.item_seq?a=w(l.schedule_id,l.item_seq):a.resolve(l.schedule_id),a.done(function(){x().done(A)})}},w=function(a,b){var c=$.Deferred();return $("body").requestData(f,{schedule_id:a,item_seq:b},{callback:function(a){if(a){if(r.bInitItemInfo=!0,!a.DatasetList)return;r.DatasetList=a.DatasetList,r.FieldList=a.FieldList,y(),c.resolve(a)}}}),c},x=function(){var a=$.Deferred();return $("body").requestData(e,{schedule_id:l.schedule_id},{callback:function(b){a.resolve(b)}}),a},y=function(a){var b=l,c=r.FieldList,d=c.length,e=["start","end"];if("T"==b.view_type&&(b.sub_view_type||(b.sub_view_type="L"),"S"==c[0].set_type))for(var f;f<e.length;f++)b[e[f]+"_time"]||(b[e[f]+"_time"]=c[0]["sch_"+e[f]+"_time"]);b.category_field_index||(b.category_field_index=[],b.category_field_index.push(0)),b.series_field_index||(b.series_field_index=[],d>2&&b.series_field_index.push(1)),z(t[J()].type)},z=function(a){"string"==typeof a&&a.indexOf("area")!=-1&&(ka.plotfillalpha="60");var b=r.oChart;b?(b.chartType(a),b.resizeTo("100%",l.chart_height)):FusionCharts.ready(function(){$.Dashboard.chartInstance[d]=r.oChart=new FusionCharts({type:a,renderAt:"chart_"+d,width:"100%",height:l.chart_height,dataFormat:"json",dataSource:{chart:ka,data:[]}}).render()})},A=function(a){var b,c,d=l,e=r.FieldList;if(a&&0!=r.DatasetList.length&&(r.last_big_code!=a||0!=r.bChangeConfig)){r.last_big_code=d.big_code=a,r.bChangeConfig&&(z(t[J()].type),r.bChangeConfig=!1);var f=B(),g=[];"T"==d.view_type?(g=[].concat(f),d.series_field_index.length>0&&"S"!=d.sub_view_type&&(g=g.concat(D())),b=i,c=1):("P"!=d.view_type&&(g=[].concat(f),d.series_field_index.length>0&&"S"!=d.view_type&&(g=g.concat(D()))),b=j,c=2);var h=$.extend({},l,{schedule_id:l.schedule_id,item_seq:l.item_seq,category_field:f,series_field:F()?D():[],category_field_nm:C(),series_field_nm:F()?E():[],dt_func:e[0].func,func:e[e.length-1].func,total_group_field:g});$("body").requestData(b,h,{callback:function(a,b,d){G(c,a)}})}},B=function(){for(var a=[],b=l.category_field_index,c=0;c<b.length;c++)a.push("field_value"+(b[c]+1));return a},C=function(){for(var a=[],b=l.category_field_index,c=0;c<b.length;c++)a.push(r.FieldList[b[c]].field_nm);return a},D=function(){for(var a=[],b=l.series_field_index,c=0;c<b.length;c++)a.push("field_value"+(b[c]+1));return a},E=function(){for(var a=[],b=l.series_field_index,c=0;c<b.length;c++)a.push(r.FieldList[b[c]].field_nm);return a},F=function(){return l.series_field_index.length>0&&"P"!=l.view_type},G=function(a,b){$("h5",q.body).text(l.item_nm),1==a?(r.dataList=b.list,H(b.list,b.totalAvg),L(b.list)):2==a&&(r.dataList=b.list,I(b.list,b.totalAvg),L(b.list))},H=function(a,b){I(a,b)},I=function(a,b){q.chart.show();var c=$.extend(K(a||[]),{chart:ka});b&&$.extend(c,{trendlines:[{line:[{startvalue:b,endvalue:"",color:"fda813",displayvalue:" ",tooltext:"Average : "+_SL.formatNumber(b),showontop:"1",thickness:"1"}]}]}),r.oChart&&r.oChart.setChartData(c,"json")},J=function(){var a="T"==l.view_type?l.sub_view_type:l.view_type;return F()&&(a="M"+a),a},K=function(a){a||(a=[]);for(var b,c=[],d=[],e=0;e<l.category_field_index.length;e++)c.push(r.FieldList[l.category_field_index[e]]);var f,g={},h={},i={},j=[];if(F()){for(var e=0;e<l.series_field_index.length;e++)d.push(r.FieldList[l.series_field_index[e]]);g={categories:[{category:[]}],dataset:[]}}else g={data:[]};b=c.concat(d),f=a.length;for(var k,m,n,o,p,q,s,t,e=0;e<f;e++)if(k=a[e],m={},n=[],o=[],p=[],F()){for(var u=0;u<c.length;u++)q=c[u],s=ja(k,q),n.push(s),o.push(ia(s,q,!0)),p.push(ia(s,q));m.value=n.join("/"),m.label=o.join("/"),m.toolText=p.join("/"),o=[],p=[];for(var u=0;u<d.length;u++)q=d[u],s=ja(k,q),o.push(ia(s,q,!0)),p.push(ia(s,q));t=o.join("/"),h[t]||(h[t]=[]),"undefined"==typeof i[m.value]&&(i[m.value]=j.length,j.push({label:m.label,toolText:m.toolText})),h[t][i[m.value]]={value:k.func_value,link:O(e,b)}}else{for(var u=0;u<c.length;u++)q=c[u],s=ja(k,q),o.push(ia(s,q,!0)),p.push(ia(s,q));m.label=o.join("/"),p=[p.join("/")],p.push(_SL.toComma(k.func_value)),m.toolText=p.join(", "),m.value=k.func_value,m.link=O(e,c),g.data.push(m)}if(F()){g.categories=[{category:j}];for(var v in h)g.dataset.push({seriesname:v,data:h[v]})}return g},L=function(a){var b,c,d,e=q.logTable.find("thead").empty(),f=q.logTable.find("tbody").empty();a||(a=[]),c=M(),d=c.length,b=$("<tr>");for(var g=0;g<d;g++)b.append("<th>"+ha(c[g])+"</th>");if(b.appendTo(e),0==a.length)f.append('<tr><td colspan="'+d+'1">There is no data.</td></tr>');else for(var h,i,j,k,m=70*l.wsize,g=0;g<a.length;g++){h=a[g],b=$("<tr>");for(var n=0;n<d;n++)i=c[n],k=ia(ja(h,i),i),j=$("<span>").attr("title",k),k&&k.length>m?j.text(k.substring(0,m-3)+"..."):j.text(k),b.append($("<td>").append(N(g,ga(i)?c:i,j)));b.appendTo(f)}},M=function(){for(var a=l.category_field_index,b=r.FieldList,c=[],d=0;d<a.length;d++)c.push(b[a[d]]);if(F()){a=l.series_field_index;for(var d=0;d<a.length;d++)c.push(b[a[d]])}return c.push(b[b.length-1]),c},N=function(a,b,c){var d=O(a,b);return null==d?c:$("<a>").attr("href",d).append(c)},O=function(a,b){var c=0,e=0,f=!1;$.isArray(b)?e=-1:(e=b.field_seq,b=[b]);for(var g=0;g<b.length;g++)if(!ga(b[g]))if(0==c){if(c=b[g].set_seq,"S"!=r.DatasetList[c-1].set_type){f=!1;break}f=!0}else if(c!=b[g].set_seq){f=!1;break}return f?"javascript:$.Dashboard.componentInstance['"+d+"'].goLogSearch("+a+","+e+")":null},P=function(a,b){var c,d=(r.dataList,M());if(b==-1)c=d.slice(0,d.length-1);else for(var e=0;e<d.length;e++)if(d[e].field_seq==b){c=[d[e]];break}if(!c)return void console.log("Error item_seq : %s, dataIdx : %s, fldSeq : %s",this.item_seq,a,b);for(var f,g,h=r.DatasetList[c[0].set_seq-1],i=r.dataList[a],j=null,l="("+h.sch_query+")",e=0;e<c.length;e++)f=c[e].field_nm,g=ja(i,c[e]),"eqp_dt"!=f?l+="-"==g?" NOT "+f+":*":" AND "+f+":"+_SL.luceneValueEscape(g):j=R(i,c[e]);null==j&&(j=Q(c[0].set_seq)),i.netJoinCd;var m=$("<form>").attr({target:"logSearchWin_"+(new Date).getTime(),action:k,method:"post"});m.append($("<input type='hidden' name='start_time'>").val(j.start_time)).append($("<input type='hidden' name='end_time'>").val(j.end_time)).append($("<input type='hidden' name='expert_keyword'>").val(l)).append($("<input type='hidden' name='template_id'>").val("popup")).appendTo("body").submit().remove()},Q=function(a){var b=r.DatasetList[a-1];return"S"==b.set_type?{start_time:b.sch_start_time+"00",end_time:b.sch_end_time+"00"}:(console.log("Error _getSearchPeriodFromDataset > DataSet Type is %s",b.set_type),null)},R=function(a,b){var c={start_time:ja(a,b),end_time:""};switch(b.func){case"8":c.start_time+="0000",c.end_time=_SL.formatDate.addDay(c.start_time,1);break;case"10":c.start_time+="00",c.end_time=_SL.formatDate.addHour(c.start_time,1);break;case"11":c.start_time=c.start_time+"0",c.end_time=_SL.formatDate.addMin(c.start_time,10);break;case"12":c.end_time=_SL.formatDate.addMin(c.start_time,1);break;default:return null}return c},S=function(){r.bUserOnChange=!1,_SL.setDataToForm(l,q.form),V()},T=function(){if(_SL.validate(q.form)){var a=$(".search-fieldset",q.form),b=$(".dnd_category>ul",q.form).sortable("toArray",{attribute:"field_index"}),c=($(".dnd_series>ul",q.form).sortable("toArray",{attribute:"field_index"}),$("[name=view_type]",q.form).val());if("T"==c){if($("[name=startDay]",a).val()+$("[name=startHour]",a).val()>=$("[name=endDay]",a).val()+$("[name=endHour]",a).val())return _alert("검색 시작시간이 종료시간보다 커야 합니다.",{onAgree:function(){$("[name=endHour]",a).focus()}}),!1}else if(0==b.length)return _alert("항목필드를 선택하세요."),!1;return!0}},U=function(){var a=_SL.serializeMap(q.form),b=r.FieldList,c=(b.length,a.item_key.split("_"));a.schedule_id=parseInt(c[0]),a.item_seq=parseInt(c[1]);var d=$(".dnd_category>ul",q.form).sortable("toArray",{attribute:"field_index"}),e=$(".dnd_series>ul",q.form).sortable("toArray",{attribute:"field_index"});a.category_field_index=[],"T"==a.view_type&&a.category_field_index.push(0);for(var f=0;f<d.length;f++)a.category_field_index.push(parseInt(d[f]));a.series_field_index=[];for(var f=0;f<e.length;f++)a.series_field_index.push(parseInt(e[f]));var g=$("[name=startDay]",q.form).val();g&&""!=g&&(a.start_time=$("[name=startDay]",q.form).val()+$("[name=startHour]",q.form).val(),a.end_time=$("[name=endDay]",q.form).val()+$("[name=endHour]",q.form).val()),l.item_key!=a.item_key&&(r.bInitItemInfo=!1),r.bChangeConfig=!0,this.config_param=l=a},V=function(){var a=l,b=a.schedule_id?a.schedule_id+"_"+a.item_seq:"",c=function(){var a,c,d,e,f,g=s.BigStatsItemData,h=q.form.find("[name=item_key]");h.empty().append($("<option>").text("[선택하세요]").val(""));for(var i in g)a=g[i],e=a.schedule_id+"_"+a.item_seq,null!=a&&a.schedule_id==d||(c=a.stats_nm,d=a.schedule_id,f=$("<optgroup>").attr("label",c),h.append(f)),f.append($("<option>").text(a.item_nm).val(e));h.val(b),h.trigger("change")};s.BigStatsItemData?c():$("body").requestData(g,{},{callback:function(a){s.BigStatsItemData=a,c()}})},W=function(a,b){var c=l,d=c.schedule_id+"_"+c.item_seq,e=X(b);if(!e)return _("",[]),void ba([]);if(d==b)Z(c.item_nm,c.view_type,r.FieldList,c.category_field_index,c.series_field_index);else{var f=Y(e);f.done(function(a){var b=[],c=[];b.push(0),a.length>2&&c.push(1),Z(e.stats_nm+"["+e.item_nm+"]",e.view_type,e.fieldList,b,c)})}},X=function(a){for(var b=s.BigStatsItemData,c=b.length,d=null,e=0;e<c;e++)if(a==b[e].schedule_id+"_"+b[e].item_seq){d=b[e];break}return d},Y=function(a){var b=$.Deferred();if(a)if(a.fieldList)b.resolve(a.fieldList);else{var c={schedule_id:a.schedule_id,item_seq:a.item_seq};$("body").requestData(h,c,{callback:function(c){a.fieldList=c,b.resolve(a.fieldList)}})}else b.resolve([]);return b},Z=function(a,b,c,d,e){var f=l;c.length;$("[name=item_nm]",q.form).val(a),"T"==b?(0==$("[name=view_type] [value=T]",q.form).length&&$("[name=view_type]",q.form).append($("<option value=T>Timeline</option>")),$("[name=view_type]",q.form).val("T"),$("[name=category_rows]",q.form).hide(),$("[name=view_type]",q.form).hide(),$("[name=sub_view_type]",q.form).show(),$("[name=rows]",q.form).hide()):($("[name=view_type] [value=T]",q.form).remove(),$("[name=category_rows]",q.form).show(),$("[name=view_type]",q.form).show(),$("[name=sub_view_type]",q.form).hide(),$("[name=rows]",q.form).show()),ba(c),0==r.bUserOnChange&&f.category_field_index?(_(f.view_type,c,f.category_field_index,f.series_field_index),_SL.setDataToForm(l,q.form),r.bUserOnChange=!0):_(b,c,d,e)},_=function(a,b,c,d){var e,f,g={};if($(".dnd_field_pannel>ul",q.form).empty(),b&&0!=b.length){e=$(".dnd_category>ul",q.form);for(var h=0;h<c.length;h++)f=c[h],g["idx_"+f]=f,aa(a,e,f,"["+b[f].set_seq+"]"+ha(b[f]));e=$(".dnd_series>ul",q.form);for(var h=0;h<d.length;h++)f=d[h],g["idx_"+f]=f,aa(a,e,f,"["+b[f].set_seq+"]"+ha(b[f]));e=$(".dnd_selectable>ul",q.form);for(var h=0;h<b.length;h++)"undefined"!=typeof g["idx_"+h]||ga(b[h])||aa(a,e,h,"["+b[h].set_seq+"]"+ha(b[h]))}},aa=function(a,b,c,d){b.append($("<li>").attr({field_index:c,title:d}).addClass("dnd_field ui-state-default"+(0==c&&"T"==a?" ui-state-disabled":"")).text(d))},ba=function(a){var b=a.length,c=$(".search-fieldset",q.form);$("div",c).remove();for(var d=0;d<b;d++)c.append(ca(a[d]));slui.attach.setTransformSelect(".page-config-area")},ca=function(a){return ga(a)?"":"eqp_dt"==a.field_nm?fa(a):da(a)},da=function(a){var b="base-search-field",c=q.config.find(".bigstats-tpl-search ."+b).clone().removeClass(b);return $(".sp-label",c).text("["+a.set_seq+"]"+ha(a)),ea($("select",c),a),$("input[type=text]",c).attr("name","field_value"+a.field_seq),c},ea=function(a,b){return a.attr({name:"field_value"+b.field_seq+"_op",title:"연산자"}),a.append($("<option>").text("=").val("=")),a.append($("<option>").text("!=").val("!=")),a.append($("<option>").text(">").val(">")),a.append($("<option>").text("<").val(">")),a.append($("<option>").text(">=").val(">=")),a.append($("<option>").text("<=").val("<=")),a.append($("<option>").text("starts with").val("SW")),a.append($("<option>").text("ends with").val("EW")),a.append($("<option>").text("like").val("LIKE")),a.append($("<option>").text("not like").val("NOT LIKE")),a.append($("<option>").text("in").val("IN")),a.append($("<option>").text("not in").val("NOT IN")),a},fa=function(a){var b=["start","end"],c=[],d=[],e=[],f=[],g="base-time-field",h=q.config.find(".bigstats-tpl-search ."+g).clone().removeClass(g);$(".sp-label",h).text("["+a.set_seq+"]"+ha(a));for(var i,j=0;j<2;j++){i=a["sch_"+b[j]+"_time"],i?(e[j]=i.substring(0,8),f[j]=i.substring(8,10)):(e[j]="",f[j]=""),c[j]=$("input[name="+b[j]+"Day]",h),d[j]=$("select[name="+b[j]+"Hour]",h);for(var k=0;k<24;k++)i=_SL.toFixedWidth(k,2,"0"),d[j].append($("<option/>").val(i).text(i));c[j].val(e[j]),d[j].val(f[j]),c[j].datepicker({dateFormat:"yymmdd",changeMonth:!0,changeYear:!0,showAnim:"fadeIn"})}return h},ga=function(a){return a.func&&/^\D/.test(a.func)},ha=function(a){var b=LogCaptionInfo[a.field_nm]||a.field_nm;return ga(a)&&(b=(LogCaptionInfo[a.func]||a.func)+("*"!=a.field_nm?"["+b+"]":"")),b},ia=function(a,b,c){var d,e=(b.field_seq,c?"":"yyyy-MM-dd");if(b.func)switch(b.func){case"8":d=_SL.formatDate(a,"yyyyMMdd","yyyy-MM-dd");break;case"10":d=_SL.formatDate(a,"yyyyMMddHH",e+" HH:mm");break;case"11":d=_SL.formatDate(a+"0","yyyyMMddHHmm",e+" HH:mm");break;case"12":d=_SL.formatDate(a,"yyyyMMddHHmm",e+" HH:mm");break;default:d=_SL.formatNumber(a)}else d=a,gDFD.fldToCodes.data[b.field_nm]&&gDFD.fldToCodes.data[b.field_nm][a]&&(d="["+a+"]"+gDFD.fldToCodes.data[b.field_nm][a]);return d},ja=function(a,b){var c=b.field_seq;if(!b.func)return a["field_value"+c];switch(b.func){case"8":case"10":case"11":case"12":return a["field_value"+c];default:return a.func_value}},ka={paletteColors:"89cf43,0099ff,ced2ff,9fa7ff,6dd0f7,dfbcfe,7dcbff,c07cfe,669933,dddddd",showValues:"0"};return{config_param:l,component_title:m,isOpenConfig:n,load:u,refresh:v,showConfig:S,validateConfig:T,beforeSaveConfig:U,goLogSearch:P}};