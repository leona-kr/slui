"use strict";_SL.nmspc("component").my_group_log_search=function(a,b,c){var d=a,e=gCONTEXT_PATH+"monitoring/myfilter_list.json",f=gCONTEXT_PATH+"monitoring/myfilter_keywords.json",g=gCONTEXT_PATH+"component/my_group_log_search.json",i=gCONTEXT_PATH+"monitoring/log_search.html",j=b,k=j.component_nm?j.component_nm:c,l=!1,m={ok:"highlight-success",low:"highlight-attention",middle:"highlight-warning",high:"highlight-danger"},n={limit_period_min:_SL.ifNull(slapp.component.my_group_log_search.admin_config.limit_period_min,60),limit_row:_SL.ifNull(slapp.component.my_group_log_search.admin_config.limit_row,1e4),limit_chart_row:_SL.ifNull(slapp.component.my_group_log_search.admin_config.limit_chart_row,10)},o={component_nm:c,myFilterName:"",viewFields:["src_ip","dstn_ip","dstn_port"],searchRows:10,strQuery:"",limitRow:n.limit_row,limitMin:30,chart_yn:"N",chart_type:"msline",low:0,middle:0,high:0,delay:1},p={},q={tit:$("#componentcontainer_"+d+" .area-title"),body:$("#componentbody_"+d),chart:$("#chart_"+d),listTable:$("#list_table_"+d),form:$("#config_"+d+" form")},r={oChart:null},s=function(){if(H=$.extend(this.chartstyles,H),$.extend(p,o),q.form.find("[name=limitMin] option").each(function(){parseInt(this.value)>n.limit_period_min&&$(this).remove()}),q.listTable.find(".mylogdata-td").off("click").on("click",function(a){a.preventDefault()}),j?$.extend(p,j):this.config_param=j={},t(p.chart_type),p.myfilter_type){if("1"==p.myfilter_type)return void console.log("미지원 myfilter_type[1]!!!");var a=this;return void $("body").requestData(f,{myfilter_id:p.myfilter_id},{callback:function(b){return"1"==p.myfilter_type?void console.log("미지원 myfilter_type[1]!!!"):(b.keywords&&(p.strQuery=b.keywords,p.myFilterName=j.myfilter_name,b.view_fields&&(p.viewFields=b.view_fields.replace(",eqp_dt","").replace("eqp_dt,","").split(","),j.viewFields||(a.config_param.viewFields=j.viewFields=p.viewFields))),z(),u(),void v())}})}z(),u(),v()},t=function(a){"Y"==j.chart_yn&&(r.oChart?r.oChart.chartType(a):(q.chart.show(),FusionCharts.ready(function(){$.Dashboard.chartInstance[d]=r.oChart=new FusionCharts({renderAt:"chart_"+d,type:a,width:"100%",height:180,dataFormat:"json",dataSource:{chart:H,categories:[{category:[]}],dataset:[]}}).render(),r.oChart.setTransparent(!0)})))},u=function(){var a=1,b=p.limitMin,c=Math.min(b,360);b>60&&(a=b<360?b/60:360==b?5:10),p.periodUnit=a;var d=_SL.formatDate.addMin(gGetServerTime(),-p.delay),e=parseInt(d.substring(10,12),10)%a;0!=e&&(d=_SL.formatDate.addMin(d,a-e)),p.schEndTime=d,p.schStartTime=_SL.formatDate.addMin(d,-c)},v=function(a){if((p.component_nm||""==p.component_nm)&&q.tit.text(p.component_nm),!l)if(""==p.myFilterName||""==p.strQuery)A({});else{p.schEndTime<_SL.formatDate.addMin(gGetServerTime(),-p.delay)&&(p.schEndTime=_SL.formatDate.addMin(p.schEndTime,p.periodUnit),p.schStartTime<=_SL.formatDate.addMin(p.schEndTime,-p.limitMin)&&(p.schStartTime=_SL.formatDate.addMin(p.schStartTime,p.periodUnit)));var b={query:p.strQuery,pageRow:p.searchRows,limitMin:p.limitMin,chartYn:p.chart_yn,schStartTime:p.schStartTime,schEndTime:p.schEndTime,periodUnit:p.periodUnit,delay:p.delay,viewFields:p.viewFields.join(",")};$("body").requestData(g,b,{callback:function(a){p.limitMin=a.limit_min,p.limitRow=a.limit_row;var b=q.body.find(".sp-title h5"),c="["+_SL.formatDate(p.schStartTime,"yyyyMMddHHmm","MM-dd HH:mm");c+=" ~ ",c+=_SL.formatDate(p.schEndTime,"yyyyMMddHHmm","MM-dd HH:mm")+"]",q.body.find(".list_row").html(_SL.toComma(p.limitRow)),""==p.myFilterName&&(p.myFilterName="검색조건 없음"),b.html(p.myFilterName+" - "+c).attr("data-ui","tooltip").data("text","검색조건 : "+p.strQuery),A(a),"Y"==p.chart_yn?(q.chart.show(),C(a)):q.chart.hide(),slui.attach.tooltip("#componentcontainer_"+d)}})}},w=function(){this.isOpenConfig=l=!0;var a=j.myfilter_id;q.form.find("[name=component_nm]").val(p.component_nm),q.form.find("[name=limitMin]").val(p.limitMin),q.form.find("[name=searchRows]").val(p.searchRows),q.form.find("[name=low]").val(p.low),q.form.find("[name=middle]").val(p.middle),q.form.find("[name=high]").val(p.high),q.form.find("[name=chart_yn]:input[value="+p.chart_yn+"]").prop("checked",!0),q.form.find("[name=chart_type]:input[value="+p.chart_type+"]").prop("checked",!0),$("body").requestData(e,{},{callback:function(b){for(var c=q.form.find("[name=myFilterInfo]").html("<option value=''>[선택하세요]</option>"),d=0,e=b.length;d<e;d++)$("<option />").attr(a==b[d].myfilter_id?{selected:!0}:{}).val(JSON.stringify(b[d])).text(b[d].myfilter_name).appendTo(c)}}),(p.component_nm||""==p.component_nm)&&$("#config_"+d).find("h4").text(p.component_nm)},x=function(){var a,b;j.component_nm=q.form.find("[name=component_nm]").val(),j.limitMin=q.form.find("[name=limitMin]").val(),j.searchRows=q.form.find("[name=searchRows]").val(),j.low=q.form.find("[name=low]").val(),j.middle=q.form.find("[name=middle]").val(),j.high=q.form.find("[name=high]").val(),j.chart_yn=q.form.find("[name=chart_yn]:checked").val(),j.chart_type=q.form.find("[name=chart_type]:checked").val(),a=q.form.find("[name=myFilterInfo]").val(),""==a||null==a?(delete j.myfilter_id,delete j.myfilter_type,delete j.myfilter_name):""!=a&&(b=$.parseJSON(a),j.myfilter_id=b.myfilter_id,j.myfilter_type=b.myfilter_type,j.myfilter_name=b.myfilter_name),this.config_param=j},y=function(){this.isOpenConfig=l=!1,this.load()},z=function(){var a=(q.body.find(".sp_title"),q.listTable),b="";""==p.myFilterName&&(p.myFilterName="검색조건 없음"),p.schStartTime&&(b+=" - [",b+=_SL.formatDate(p.schStartTime,"yyyyMMddHHmm","yyyy-MM-dd HH:mm")+" ~ "+_SL.formatDate(p.schEndTime,"yyyyMMddHHmm","yyyy-MM-dd HH:mm"),b+="]");var c=j.viewFields?j.viewFields.join(","):"",d=p.viewFields?p.viewFields.join(","):"",e=a.find("thead"),f=a.find("tbody");if(c!=d&&(j.viewFields=p.viewFields,e.empty(),f.empty()),0==e.find("th").length){var g=$("<tr>").append("<th width='40'>번호</th>").append("<th width='60'>위험도</th>").append("<th>최근발생시간</th>");for(var h in p.viewFields)"eqp_dt"!=p.viewFields[h]&&g.append("<th>"+_SL.ifNull(LogCaptionInfo[p.viewFields[h]],p.viewFields[h])+"</th>");g.append("<th>건수</th>"),e.append(g)}0==f.find("td").length&&f.append('<tr><td colspan="'+p.viewFields.length+'4">검색중입니다...</td></tr>')},A=function(a){var b,c,d,e,f,g,i,j,k=_SL.ifNull(a.rsList,{}),l=_SL.ifNull(a.assetMap,{}),n=q.listTable,o=n.find("tbody").empty();if(k&&k.length>0){for(var r in k){b=k[r],i=b.group_by_count,f=$("<tr>").addClass("row-link"),f.append("<td class='mylogdata-td'>"+parseInt(r)+"1</td>"),j=B(i),f.append("<td class='mylogdata-td '"+m[j]+">"+j+"</td>"),g=$("<td>").addClass("mylogdata-td"),d=b.max_eqp_dt+"",e=_SL.formatDate(d,"yyyyMMddHHmm"),d=_SL.formatDate(d,"yyyyMMddHHmm","yyyy-MM-dd HH:mm"),g.attr("title",d).attr("data-value",e).append(d).appendTo(f);for(var s=0,t=p.viewFields.length;s<t;s++)if(c=p.viewFields[s],d=b[c]+"",g=$("<td class='mylogdata-td'>"),"eqp_dt"!=c){if(c.indexOf("ip")>-1&&"-"!=d){var u="* 자산정보",v=l[d];v?(u+="<br> - 자산명 : "+v.asset_nm,u+="<br> - 아이피 : "+v.sip+"~"+v.eip,u+="<br> - 직급 : "+_SL.ifNull(v.grade,""),u+="<br> - 본부 : "+_SL.ifNull(v.division,""),u+="<br> - 부서 : "+_SL.ifNull(v.department,""),u+="<br> - 관리자 : "+_SL.ifNull(v.manager,"")):u+="가 없습니다.",g.attr({"data-value2":d,"data-ui":"tooltip"}).data("text",u).append(d)}else if("recv_time"==c)g.attr("data-value2",d).append(_SL.formatDate(d,"yyyyMMddHHmmss","yyyy-MM-dd HH:mm:ss"));else if("dstn_country_code"==c||"src_country_code"==c){g.attr("data-value2",d);var w=c.matc;h(/^[^_]+_/);var x=b[w+"country_code"];x&&("PRN"==x?x="PR-N":"N/A"==b[w+"country_name"]&&(x="N-A"),g.append("<img src='/resources/images/flag/"+x+".png' style='margin-right:5px;'>")),g.append(d)}else g.attr("data-value2",d),d.length>55&&(g.attr("title",d),d=_SL.htmlEscape(d),d=d.substring(0,55)+"..."),g.append(d);f.append(g)}f.append("<td class='mylogdata-td'>"+_SL.toComma(i)+"</td>").appendTo(o).hide().fadeIn(1500)}}else f=$("<tr>").append("<td colspan='"+p.viewFields.length+"4'>검색 결과가 없습니다.</td>").appendTo(o).hide().fadeIn(1500)},B=function(a){var b=p.low,c=p.middle,d=p.high;return 0==b&&(b=a+1),0==c&&(c=a+1),0==d&&(d=a+1),a>=b&&a<c?"low":a>=c&&a<d?"middle":a>=d?"high":"ok"},C=function(a){for(var b=((new Date).getTime(),a.chartDataMap?a.chartDataMap:{}),c={chart:H,categories:[],dataset:[]},d=[],e=p.schStartTime,f=p.schEndTime,g=e;g<f;g=_SL.formatDate.addMin(g,p.periodUnit))d.push(_SL.formatDate(g,"MM-dd HH:mm"));var h,i,j,k,l,m=[],n=[],o={};for(var q in d)n.push({label:d[q]});for(var q in b){h=b[q],i=[],k=JSON.parse(q),j=h.length,o={};for(var s=0;s<j;s++)o[_SL.formatDate(h[s].eqp_dt,"MM-dd HH:mm")]=h[s];for(var t in d)l=D(o,d[t],k),i.push(l);m.push({seriesname:E(k),data:i})}m.sort(function(a,b){var c=parseInt(a.seriesname.split(" ")[0]),d=parseInt(b.seriesname.split(" ")[0]);return c==d?0:c>d?1:-1}),c.categories.push({category:n}),c.dataset=m,r.oChart.setChartData(c,"json")},D=function(a,b,c){var e={value:0},f=a[b];return f&&(e.link="JavaScript:$.Dashboard.componentInstance['"+d+"'].goLogSearchChart("+c.rank+",'"+f.eqp_dt+"')",e.value=f.group_by_count),e},E=function(a){return a.rank+" 순위"},F=function(a,b){var c=q.listTable.find("tbody tr:eq("+a+")"),d=_SL.formatDate.addMin(b,p.periodUnit);G(c,b,d)},G=function(a,b,c){var d,e,f,g=p.viewFields,h=[],j=[],k="("+p.strQuery+")",l=a.find("td");for(var m in g)e=parseInt(m),f=g[e],d=$.trim(l.eq(e+3).attr("data-value2")),"eqp_dt"!=f&&("-"==d||""==d?j.push(f+":*"):h.push(f+":"+_SL.luceneValueEscape(d)));k+=" AND "+h.join(" AND "),j.length>0&&(k+=" NOT "+j.join(" NOT ")),$("<form>").attr({target:"MyGrouplogSearchWin_"+(new Date).getTime(),action:i,method:"post"}).append($("<input type='hidden' name='start_time'>").val(_SL.ifNull(b,p.schStartTime))).append($("<input type='hidden' name='end_time'>").val(_SL.ifNull(c,p.schEndTime))).append($("<input type='hidden' name='expert_keyword'>").val(k)).append($("<input type='hidden' name='template_id'>").val("popup")).appendTo("body").submit().remove()},H={paletteColors:"89cf43,0099ff,ced2ff,9fa7ff,6dd0f7,dfbcfe,7dcbff,c07cfe,669933,dddddd",showValues:"0"};return{config_param:j,component_title:k,isOpenConfig:l,load:s,refresh:v,showConfig:w,beforeSaveConfig:x,afterSaveConfig:y,goLogSearchChart:F}};