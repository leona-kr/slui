"use strict";_SL.nmspc("slapp.component").search_event=function(a,b,c){var d,e,f,g=a,h=$("#componentheader_"+g),i=$("#componentbody_"+g),j=$("#config_"+g+" form"),k=i.find(".grid-table-group"),l=i.find(".chart-group"),m=h.find(".area-title"),n=j.find("[name=ruleset_id]"),o=j.find("[name=ruleset_id_list]"),p=j.find("[name=group_cd]"),q=j.find("[name=event_cate_cd]"),r=j.find("[name=event_level]"),s=j.find("[name=group_field]"),t=j.find("[name=last_period]"),u=j.find("[name=view_field]"),v=j.find("[name=rows]"),w=(j.find("[name=chart_yn]"),gCONTEXT_PATH+"sysdata/comcode_map.json"),x=gCONTEXT_PATH+"component/search_event_config.json",y=gCONTEXT_PATH+"component/search_event_list.json",z=gCONTEXT_PATH+"event/search_event_list.html",A={ruleset_id:"",group_cd:"",event_cate_cd:"",event_level:"",group_field:"",event_seq:"",last_period:"60",rows:"5",chart_yn:"N",view_fields:["event_nm","group_field","event_cate_cd","event_level","cnt","event_time"]},B=b,C=c,D=1,E=null,F={grpFields:["ruleset_id","open_time","group_field","field_val"],timeField:"event_time",sumField:"cnt",sumFieldList:["distinct_cnt"],maxBuffers:1e4,period:60},G=function(){this.config_param=B=$.extend({},A,B),U=$.extend(this.chartstyles,U),U.paletteColors="#89cf43,#ffc000,#ff0000",L(),j.on("click",".btn-add",function(){var a=n.find("option:selected").val(),b=n.find("option:selected").text();return""==a?void _alert("이벤트를 선택하세요."):o.find("option").is(function(){return this.value==a})?void _alert("동일한 이벤트가 존재합니다."):void o.append(new Option(b,a))}).on("click",".btn-del",function(){o.find(":selected").remove()}),k.on("click","a[name=search_event]",function(a){return V($(a.target)),!1}),S(),F.period=B.last_period,E=_SL.getDataTicker(F),E.setBaseTime(_SL.formatDate.addMin(gGetServerTime(),-F.period)),B.event_seq="",H()},H=function(a){var b=function(b){var c=b&&b.rsList?b.rsList:[],d=b.isInit;if(!(c.length<1)||d){var e=GroupCaptionInfo[B.group_cd],f=ComCodes.CS0051[B.event_cate_cd],g=ComCodes.CS0005[B.event_level],h=LogCaptionInfo[B.group_field],i="일반 이벤트";if(""!=B.group_cd&&(i=i+"/"+e),""!=B.event_cate_cd&&(i=i+"/"+f),""!=B.event_level&&(i=i+"/"+g),""!=B.group_field&&(i=i+"/"+h),m.text(i),"Y"==B.chart_yn){E.addChartList(c);var j=E.getChartList();l.is(":hidden")?(T(b,j),l.show()):T(b,j,a)}else l.hide();var n=B.event_seq;c.length>0&&(n=c[0].event_seq),E.addList(c);var o=E.getList(),p=k.find("tbody").empty(),q=o.length;if(q>B.rows&&(q=B.rows),q&&0!=q.length)for(var r,s,t,u,v=B.view_fields,w=["Low","Middle","High"],x=["label-success","label-attention","label-danger"],y=["src_country_name","src_country_code","dstn_country_name","dstn_country_code"],z=0;z<q;z++){t=o[z],r=$("<tr>").append($("<td>").text(z+1));for(var A in v){s=$("<td>");var C=v[A];switch(u=t[C],C){case"event_nm":$("<a />").attr({href:"#",name:"search_event"}).text(u).data({event_nm:u,event_time:t.event_time,s_event_time:t.s_event_time,ruleset_id:o[z].ruleset_id,event_cate_cd:o[z].event_cate_cd,event_level:o[z].event_level,group_cd:o[z].group_cd}).appendTo(s);break;case"group_field":if(u){var F,G=u.split(","),H=(t.field_val.split(","),"");for(var A in G)y.indexOf(G[A])>-1&&(F=t.flag_code?t.flag_code:t[G[A]],"N/A"==t[G[A]]&&(F="N-A"),H="PRN"!=F?'<img src="/resources/images/flag/'+F+'.png" alt="'+F+'" width="16" height="11">':'<i class="icon-lock"></i>'),A==G.length-1?s.append(LogCaptionInfo[G[A]]+" : "+H+t[G[A]]):(s.append(LogCaptionInfo[G[A]]+" : "+H+t[G[A]]+"\n"),s.append($("<br>")))}else s.append("전체");break;case"event_cate_cd":s.append(t.event_cate_cd_nm);break;case"event_level":0==u?s.append("-"):s.append('<span class="'+x[u-1]+'">'+w[u-1]+"</span>");break;case"event_time":s.text(_SL.formatDate(t.s_event_time,"MM-dd HH:mm")+"~"+_SL.formatDate(t.event_time,"MM-dd HH:mm")),s.attr("title",_SL.formatDate(t.s_event_time,"yyyy-MM-dd HH:mm")+" ~ "+_SL.formatDate(t.event_time,"yyyy-MM-dd HH:mm"));break;case"handling_type_cd":t.handling_type_cd_nm?s.append(t.handling_type_cd_nm):s.append("-");break;case"group_cd":s.append(t.group_cd_nm);break;case"cnt":s.append(_SL.toComma(u+"/"+E.getEventCount(t.key)+"건"));break;case"distinct_cnt":case"limit_distinct_count":case"limit_count":u=_SL.formatNumber(u),s.append(u);break;default:s.append(u)}r.append(s)}r.appendTo(p)}else p.append("<tr><td colspan="+D+">There is no Event.</td></tr>");B.event_seq=n}};$("body").requestData(y,B,{callback:b})},I=function(){var a=B?B.ruleset_id:"",b=B?B.view_fields:[];n.val(""),p.val(B.group_cd),q.val(B.event_cate_cd),r.val(B.event_level),s.val(B.group_field),t.val(B.last_period),v.val(B.rows),j.find("[name=chart_yn]:input[value="+B.chart_yn+"]").prop("checked",!0),o.empty();var c=a.split(",");for(var e in c){var f=c[e];null!=f&&""!=f&&o.append('<option value="'+f+'">'+d[f]+"</option>")}u.setSelectionOrder(b,!0)},J=function(){for(var a=[],b=o.find("option"),c=0;c<b.length;c++)a.push(b.eq(c).val());B.ruleset_id=a.join(","),B.group_cd=p.val(),B.event_cate_cd=q.val(),B.event_level=r.val(),B.group_field=s.val(),B.last_period=t.val(),B.rows=v.val(),B.chart_yn=j.find("[name=chart_yn]:checked").val(),B.view_fields=u.getSelectionOrder(),F.period=B.last_period,E=_SL.getDataTicker(F),E.setBaseTime(_SL.formatDate.addMin(gGetServerTime(),-F.period)),B.event_seq=""},K=function(){S(),H(!0)},L=function(){var a=function(a,b,c){ComCodes.CS0051=a,M()},b=function(a,b,c){ComCodes.CS0005=a,N()},c=function(a,b,c){d=a.eventNames,e=a.groups,f=a.groupFields,P(d),O(e),Q(f),R(f)};ComCodes.CS0051?M():$("body").requestData(w,{code_type:"CS0051"},{callback:a}),ComCodes.CS0005?N():$("body").requestData(w,{code_type:"CS0005"},{callback:b}),$("body").requestData(x,{},{callback:c})},M=function(){q.html('<option value="">[선택하세요]</option>');for(var a in ComCodes.CS0051)q.append('<option value="'+a+'">'+ComCodes.CS0051[a]+"</option>")},N=function(){r.html('<option value="">[선택하세요]</option>');for(var a in ComCodes.CS0005)r.append('<option value="'+a+'">'+ComCodes.CS0005[a]+"</option>")},O=function(a){p.html('<option value="">[선택하세요]</option>');for(var b in a)p.append('<option value="'+b+'">'+a[b]+"</option>")},P=function(a){n.html('<option value="">[선택하세요]</option>');for(var b in a)n.append('<option value="'+b+'">'+a[b]+"</option>")},Q=function(a){s.html('<option value="">[선택하세요]</option>');for(var b in a){var c=a[b];s.append('<option value="'+c+'">'+LogCaptionInfo[c]+"("+c+")</option>")}},R=function(a){u.empty(),delete EventCaptionInfo.dashboard_yn;for(var b in EventCaptionInfo)u.append('<option value="'+b+'">'+EventCaptionInfo[b]+"("+b+")</option>");for(var c in a){var d=a[c];u.append('<option value="'+d+'">'+LogCaptionInfo[d]+"("+d+")</option>")}var e=B?B.view_fields:[];for(var c in e){var f=e[c];!EventCaptionInfo[f]&&a.indexOf(f)<0&&u.append('<option value="'+f+'">undefined('+f+")</option>")}u.chosen({search_contains:!0,placeholder_text_multiple:"[선택하세요]",width:"100%",max_selected_options:30}),u.siblings(".chosen-container").find(".chosen-results").css("max-height","100px"),u.siblings(".chosen-container").find(".chosen-choices").css({"max-height":"55px","min-height":"55px","overflow-y":"auto"})},S=function(){var a,b,c=k.find("thead").empty(),d=B.view_fields;b=$("<tr />"),b.append('<th scope="col">번호</th>');for(var e in d){a=EventCaptionInfo[d[e]],a||(a=LogCaptionInfo[d[e]]);var f=$('<th scope="col" />');"cnt"==d[e]&&f.attr("title","로그건수/이벤트건수"),b.append(f.append(a?a:d[e])),D++}c.append(b)},T=function(a,b,c){var d=b,e={chart:U,categories:[],dataset:[]},f=[],h=[],i=ComCodes.CS0005,j=a.groupByPeriod,k=a.categorys,l="";for(var m in k)h.push({label:_SL.formatDate(k[m].event_time,"MM-dd HH:mm")});var n,o,p={},q={};for(var r in i){var s=i[r];q[s]=0}if(j>1){for(var m in k){var q={};for(var r in i){var s=i[r];q[s]=0}n=k[m].event_time,o=_SL.formatDate.addMin(n,j),p[n]=q;for(var r=0;r<j;r++){var t;if(t=0==r?n:_SL.formatDate.addMin(n,r),d[t])for(var u in i){var s=i[u];d[t][s]&&(p[n][s]+=d[t][s])}}}d=p}for(var r in i){var s=i[r],v={seriesname:s,data:[]};for(var u in k){l=k[u].event_time;var w=0,x=k[u].event_time,y=_SL.formatDate.addMin(x,j),z='javascript:$.Dashboard.componentInstance["'+g+'"].chartSearchEvent("'+r+'","'+x+'","'+y+'")';d[l]&&d[l][s]&&(w=d[l][s]),v.data.push({value:w,link:z})}f.push(v)}e.categories.push({category:h}),e.dataset=f,c===!0&&void 0!=$.Dashboard.chartInstance[g]?$.Dashboard.chartInstance[g].setJSONData(e):FusionCharts.ready(function(){$.Dashboard.chartInstance[g]=new FusionCharts({type:"stackedcolumn2d",renderAt:"chart-container_"+g,width:"100%",height:"240",dataFormat:"json",dataSource:e}).render()})},U={caption:"",subCaption:"",numberPrefix:"",showValues:"0"},V=function(a){var b=i.find("[name=listForm]"),c=a.data("s_event_time"),d=_SL.formatDate.addMin(a.data("event_time"),1);$("[name=start_time]",b).val(c),$("[name=end_time]",b).val(d),$("[name=s_ruleset_id]",b).val(a.data("ruleset_id")),$("[name=s_group_cd]",b).val(a.data("group_cd")),$("[name=s_event_cate_cd]",b).val(a.data("event_cate_cd")),$("[name=s_event_nm]",b).val(a.data("event_nm")),$("[name=s_event_level]",b).val(a.data("event_level"));var e="searchEventSearchWin_"+(new Date).getTime();b.attr({action:z,target:e,method:"post"}).submit()},W=function(a,b,c){var d=i.find("[name=listForm]");$("input[type=hidden]",d).val(""),$("[name=start_time]",d).val(b),$("[name=end_time]",d).val(c),$("[name=s_event_level]",d).val(a);var e="searchEventSearchWin_"+(new Date).getTime();d.attr({action:z,target:e,method:"post"}).submit()};return{config_param:B,component_title:C,load:G,refresh:H,showConfig:I,beforeSaveConfig:J,afterSaveConfig:K,chartSearchEvent:W}};