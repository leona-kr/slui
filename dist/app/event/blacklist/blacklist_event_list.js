"use strict";_SL.nmspc("blacklistEvent").list=function(){var a={urlList:gCONTEXT_PATH+"event/blacklist_event_list.json",urlChartData:gCONTEXT_PATH+"event/blacklist_event_main_chart_data.json",urlSubChartForm:gCONTEXT_PATH+"event/blacklist_event_sub_chart_form.html",urlSubChartData:gCONTEXT_PATH+"event/blacklist_event_sub_chart_data.json",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlHandlingUdate:gCONTEXT_PATH+"event/blacklist_event_update.json",formId:"#searchBlackListEventList",gridId:"#gridBlacklistEventList",pieChartId:"pieChartContainer",areaChartId:"areaChartContainer",subPieChartId:"subPieChartContainer",subAreaChartId:"subAreaChartContainer"},b={form:$(a.formId),grid:$(a.gridId),sDay:$(a.formId+" [name=startDay]"),sHour:$(a.formId+" [name=startHour]"),sMin:$(a.formId+" [name=startMin]"),eDay:$(a.formId+" [name=endDay]"),eHour:$(a.formId+" [name=endHour]"),eMin:$(a.formId+" [name=endMin]"),type:$(a.formId+" [name=s_type]"),blackIp:$(a.formId+" [name=s_blacklist_ip]"),domain:$(a.formId+" [name=s_domain]"),nation:$(a.formId+" [name=s_nation]"),hType:$(a.formId+" [name=s_handling_type_cd]")},c=function(){d(b.grid),e(),g()},d=function(b){var c={datatype:"json",datafields:[{name:"blacklist_ip",type:"string"},{name:"domain",type:"string"},{name:"type_nm",type:"string"},{name:"nation",type:"string"},{name:"ip_type",type:"string"},{name:"cnt",type:"string"},{name:"event_time",type:"string"},{name:"handling_type_nm",type:"string"}],root:"rows",beforeprocessing:function(a){null!=a&&(c.totalrecords=a.totalRows)},cache:!1,url:a.urlList},d=new $.jqx.dataAdapter(c,{beforeLoadComplete:function(a){for(var b in a)a[b].start_time=a[b].event_time,a[b].event_time=_SL.formatDate(a[b].event_time,"yyyyMMddHHmm","yyyy-MM-dd HH:mm");return a},formatData:function(b){var c,d={},e=$(a.formId).serializeArray();for(c in e)d[e[c].name]=e[c].value;return $.extend(b,d),b},loadError:function(a,b,c){_alert(c)}});b.jqxGrid({source:d,width:"100%",virtualmode:!0,selectionmode:"checkbox",enablehover:!1,rendergridrows:function(a){return a.data},columns:[{text:"No",columntype:"number",width:40,cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).text(c+1)[0].outerHTML}},{text:"유해IP",datafield:"blacklist_ip",width:"15%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){return $(d).html('<button type="button" class="btn-link">'+c+"</button>")[0].outerHTML}},{text:"유형",datafield:"type_nm",cellsalign:"center",width:"12%",cellsrenderer:function(a,b,c,d,e,f){if(""==c)return $(d).text("-")[0].outerHTML}},{text:"도메인",datafield:"domain",cellsrenderer:function(a,b,c,d,e,f){if(""==c)return $(d).text("-")[0].outerHTML}},{text:"국가",datafield:"nation",width:"12%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){if(""==c)return $(d).text("-")[0].outerHTML}},{text:"출발지/목적지",datafield:"ip_type",width:"10%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g;return g="1"==c?"SRC":"DSTN",$(d).text(g)[0].outerHTML}},{text:"발생건수",datafield:"cnt",width:"8%",cellsalign:"center"},{text:"발생시간",datafield:"event_time",width:"13%",cellsalign:"center"},{text:"상태",datafield:"handling_type_nm",width:"8%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){if(!c)return $(d).text("-")[0].outerHTML}}]}),b.on("cellclick",function(a){if("blacklist_ip"===a.args.datafield){var b=a.args.row.bounddata.blacklist_ip,c=a.args.row.bounddata.start_time,d=a.args.row.bounddata.ip_type;f(b,c,d)}})},e=function(){b.form.find(".form-submit").off().on("click",function(){p()}),b.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var c=function(a,b){var c=a.siblings(".tform-select");c.find(".tform-select-t").text(b).end().find(".tform-select-option[data-value="+b+"]").addClass("selected").end(),a.val(b)},d=_SL.formatDate.addMin(b.form.find("[name=endDay]").val()+b.form.find("[name=endHour]").val()+b.form.find("[name=endMin]").val(),-a);c(b.form.find("[name=startDay]"),d.substring(0,8)),c(b.form.find("[name=startHour]"),d.substring(8,10)),c(b.form.find("[name=startMin]"),d.substring(10,12))}}),b.form.find("[name=startDay],[name=startHour],[name=startMin],[name=endDay],[name=endHour],[name=endMin]").change(function(){var a=b.form.find("[name=timeSet]"),c=a.siblings(".tform-select").find("[data-value=0]").text();a.val(0).siblings(".tform-select").find(".tform-select-t").text(c)});var a=b.grid.parent().siblings(".grid-bottom").find(".btn-handling");a.on("click",m)},f=function(c,d,e){var f=_SL.formatDate.addMin(d,1),g="1"==e?"src_ip:":"dstn_ip:",h=b.form.find("[name='logSearchForm']");0==h.length&&(h=$('<form name="logSearchForm">\t\t\t\t<input type="hidden" name="start_time">\t\t\t\t<input type="hidden" name="end_time">\t\t\t\t<input type="hidden" name="filter_type">\t\t\t\t<input type="hidden" name="expert_keyword">\t\t\t\t<input type="hidden" name="template_id" value="popup">').appendTo(b.form)),$("[name=start_time]",h).val(d),$("[name=end_time]",h).val(f),$("[name=filter_type]",h).val("2"),$("[name=expert_keyword]",h).val(g+c);var i="logSearchWin_"+(new Date).getTime();h.attr({target:i,action:a.urlLogSearch}).submit()},g=function(){$.getJSON(a.urlChartData,{start_time:b.sDay.val()+b.sHour.val()+b.sMin.val(),end_time:b.eDay.val()+b.eHour.val()+b.eMin.val(),s_type:b.type.val(),s_blacklist_ip:b.blackIp.val(),s_domain:b.domain.val(),s_nation:b.nation.val(),s_handling_type_cd:b.hType.val()},function(c){h.groupByPeriod=c.groupByPeriod;var d=c.labels,e=c.pieChartDataList,f=c.areaChartDataList,g=c.categorys;""!=b.type.val()&&(d=[b.type.find("option:selected").text()]),n.dataSource.chart=$.extend({},slui.chart.chartConfig,n.dataSource.chart),o.dataSource.chart=$.extend({},slui.chart.chartConfig,o.dataSource.chart);var i=n,j=o;i.renderAt=a.pieChartId,j.renderAt=a.areaChartId,i.dataSource.data=[],j.dataSource.categories=[],j.dataSource.dataset=[],j.dataSource.categories.push({category:g});for(var l in d){i.dataSource.data.push(h.getData(d[l],e,!1)),j.dataSource.dataset.push({seriesname:d[l],data:[]});for(var m in g)j.dataSource.dataset[l].data.push(h.getDataset(d[l],g[m].label,f,!1))}k(i,j)})},h={top_limit:10,groupByPeriod:1,getDataset:function(a,b,c,d){var e={value:0};for(var f in c)if(a==c[f].label&&b==c[f].category){e=d?{value:c[f].value,link:"javascript:slapp.blacklistEvent.list.goSearchPopup('"+c[f].label+"', '"+c[f].category+"')"}:{value:c[f].value,link:"javascript:slapp.blacklistEvent.list.subChartInit('"+c[f].category+"', '"+c[f].type+"', '"+_SL.htmlEscape(c[f].label)+"')"};break}return e},getData:function(a,b,c){var d={label:a,value:0};for(var e in b)if(a==b[e].label){d=c?{label:b[e].label,value:b[e].value,link:"javascript:slapp.blacklistEvent.list.goSearchPopup('"+b[e].label+"', '')"}:{label:b[e].label,value:b[e].value,link:"javascript:slapp.blacklistEvent.list.subChartInit('', '"+b[e].type+"', '"+_SL.htmlEscape(b[e].label)+"');"};break}return d}},i=function(b,c,d){new ModalPopup(a.urlSubChartForm,{width:1e3,height:350,onOpen:j(b,c,d)})},j=function(c,d,e){c=c.replace(/\D/gi,""),h.ip_type=d;var f=$.extend(!0,{},n),g=$.extend(!0,{},o);f.dataSource.chart.showBorder="1",g.dataSource.chart.showBorder="1",f.renderAt=a.subPieChartId,g.renderAt=a.subAreaChartId,f.dataSource.chart.caption="["+decodeURIComponent(e)+"]TOP "+h.top_limit+" 현황",g.dataSource.chart.caption="["+decodeURIComponent(e)+"]시간대별 TOP "+h.top_limit+" 현황";var i=b.sDay.val()+b.sHour.val()+b.sMin.val(),j=b.eDay.val()+b.eHour.val()+b.eMin.val();""!=c&&(j=_SL.formatDate.addMin(c,h.groupByPeriod),i=c),$.getJSON(a.urlSubChartData,{top_limit:h.top_limit,start_time:i,end_time:j,s_type:d,s_blacklist_ip:b.blackIp.val(),s_domain:b.domain.val(),s_nation:b.nation.val(),s_handling_type_cd:b.hType.val()},function(a){h.groupByPeriod=a.groupByPeriod;var b=a.labels,c=a.pieChartDataList,d=a.areaChartDataList,e=a.categorys;f.dataSource.data=[],g.dataSource.categories=[],g.dataSource.dataset=[],g.dataSource.categories.push({category:e});for(var i in b){f.dataSource.data.push(h.getData(b[i],c,!0)),g.dataSource.dataset.push({seriesname:b[i],data:[]});for(var j in e)g.dataSource.dataset[i].data.push(h.getDataset(b[i],e[j].label,d,!0))}0==$("#subAreaChartContainer").size()?setTimeout(function(){k(f,g)},1e3):k(f,g)})},k=function(a,b){FusionCharts.ready(function(){new FusionCharts(a).render()}),FusionCharts.ready(function(){new FusionCharts(b).render()})},l=function(c,d){d=d.replace(/\D/gi,"");var e=b.sDay.val()+b.sHour.val()+b.sMin.val(),f=b.eDay.val()+b.eHour.val()+b.eMin.val();""!=d&&(f=_SL.formatDate.addMin(d,h.groupByPeriod),e=d);var g=b.form.find("[name='logSearchForm']");0==g.length&&(g=$('<form name="logSearchForm">\t\t\t\t<input type="hidden" name="start_time">\t\t\t\t<input type="hidden" name="end_time">\t\t\t\t<input type="hidden" name="filter_type">\t\t\t\t<input type="hidden" name="expert_keyword">\t\t\t\t<input type="hidden" name="template_id" value="popup">').appendTo(b.form)),$("[name=start_time]",g).val(e),$("[name=end_time]",g).val(f),$("[name=filter_type]",g).val("2"),$("[name=expert_keyword]",g).val("src_ip:"+c+" OR dstn_ip:"+c);var i="logSearchWin_"+(new Date).getTime();g.attr({target:i,action:a.urlLogSearch}).submit()},m=function(){var c=$(this).data("handle-type"),d=$(this).text(),e=b.grid.jqxGrid("selectedrowindexes"),f=b.grid.jqxGrid("getdisplayrows"),g=[];for(var h in f)for(var i=0,j=e.length;i<j;i++)e[i]==f[h].boundindex&&g.push(f[h].boundindex);return g.length<1?void _alert(d+"할 이벤트를 체크해주세요."):void _confirm("이벤트를 "+d+" 하시겠습니까?",{onAgree:function(){var d=g.length,e=0,f={};for(var h in g){var i=b.grid.jqxGrid("getrowdata",g[h]);if(!i){p();break}var j=i.blacklist_ip,k=i.event_time,l=i.ip_type;k=_SL.formatDate(k,"yyyy-MM-dd HH:mm","yyyyMMddHHmm"),f={handling_type_cd:c,blacklist_ip:j,event_time:k,ip_type:l},$("body").requestData(a.urlHandlingUdate,f,{callback:function(a,b,c){e++,e==d&&p()}})}}})},n={type:"pie3d",renderAt:a.pieChartId,width:"100%",height:"300",dataFormat:"json",dataSource:{chart:{caption:"유형별 현황",pieRadius:"130",showpercentintooltip:"0",startingangle:"125"},data:[]}},o={type:"msline",renderAt:a.areaChartId,width:"100%",height:"300",dataFormat:"json",dataSource:{chart:{caption:"유형별 시간대별 현황",numvdivlines:"10",showlabels:"0",showvalues:"0"},categories:[],dataset:[]}},p=function(){_SL.validate(b.form)&&(b.grid.jqxGrid("updatebounddata"),b.grid.jqxGrid("clearselection"),g())};return{init:c,subChartInit:i,goSearchPopup:l}}(),$(function(){slapp.blacklistEvent.list.init(),$("#btnSettingBlacklist").togglePage(gCONTEXT_PATH+"event/blacklist_list.html")});