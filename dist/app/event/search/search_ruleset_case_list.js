"use strict";_SL.nmspc("searchRuleset").caseList=function(){var a=[],b={urlList:gCONTEXT_PATH+"event/search_ruleset_case_list.json",urlForm:gCONTEXT_PATH+"event/search_ruleset_case_form.html",urlAdd:gCONTEXT_PATH+"event/search_ruleset_case_add.do",urlDelete:gCONTEXT_PATH+"event/search_ruleset_case_delete.do",urlProcPct:gCONTEXT_PATH+"event/search_ruleset_case_prcs_pct.json",urlResult:gCONTEXT_PATH+"event/search_ruleset_case_result.html",formId:"#searchSearchRulesetCase",gridId:"#gridRulesetCaseList"},c={form:$(b.formId),grid:$(b.gridId)},d=function(){e(c.grid),f(),setInterval(j,1e4)},e=function(c){var d={datatype:"json",datafields:[{name:"case_id",type:"string"},{name:"case_nm",type:"string"},{name:"case_start_time",type:"string"},{name:"case_check_time",type:"string"},{name:"case_end_time",type:"string"},{name:"search_query",type:"string"},{name:"time_type",type:"string"},{name:"times",type:"string"},{name:"group_field",type:"string"},{name:"group_field_nm",type:"string"},{name:"cvt_group_field",type:"string"},{name:"func",type:"string"},{name:"func_field",type:"string"},{name:"limit_count",type:"string"},{name:"distinct_field",type:"string"},{name:"distinct_count",type:"string"},{name:"status",type:"string"},{name:"proc_pct",type:"string"},{name:"proc_dt",type:"string"},{name:"detect_cnt",type:"string"},{name:"str_stat",type:"string"}],root:"rows",beforeprocessing:function(a){null!=a&&(d.totalrecords=a.totalRows)},cache:!1,url:b.urlList},e=new $.jqx.dataAdapter(d,{beforeLoadComplete:function(b){for(var c in b)a.push(b[c].case_id);return b},formatData:function(a){var c,d={},e=$(b.formId).serializeArray();for(c in e)d[e[c].name]=e[c].value;return $.extend(a,d),a},loadError:function(a,b,c){_alert(c)}});c.jqxGrid({source:e,sortable:!0,width:"100%",virtualmode:!0,selectionmode:"checkbox",enablehover:!1,rendergridrows:function(a){return a.data},columns:[{text:"No",columntype:"number",width:40,cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).text(c+1)[0].outerHTML}},{text:"검증명",datafield:"case_nm",width:"25%",cellsrenderer:function(a,b,c,d,e,f){return $(d).html("<button type='button' class='btn-link'>"+c+"</button>")[0].outerHTML}},{text:"기준필드",datafield:"cvt_group_field",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){return $(d).text(c)[0].outerHTML}},{text:"임계치",datafield:"limit_count",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g=f.distinct_count,h=c;return""!=g&&(h+="/"+g),$(d).text(h)[0].outerHTML}},{text:"검증대상 기간",datafield:"case_time",cellsalign:"center",width:"23%",cellsrenderer:function(a,b,c,d,e,f){var g=_SL.formatDate(f.case_start_time,"yyyyMMddHHmm","yyyy-MM-dd HH:mm"),h=_SL.formatDate(f.case_end_time,"yyyyMMddHHmm","yyyy-MM-dd HH:mm");return $(d).text(g+" ~ "+h)[0].outerHTML}},{text:"진행률",datafield:"proc_pct",width:"12%",cellsrenderer:function(a,b,c,d,e,f){var g=f.case_id,h=f.proc_dt,i=f.proc_pct,j='<div id="'+g+'" data-proc_date="'+h+'" style="position:relative;width:100px;height:16px;margin:5px auto;border:1px solid #000;background:#fff;"><div class="prcsPctB" style="position:absolute;left:0;top:0;bottom:0;width:'+i+'%;background-color:#89cf43;"></div><div class="prcsPctT" style="position:absolute;width:100%;height:100%;text-align:center;color:#000;" >'+c+"%</div></div>";return j}},{text:"탐지건수",datafield:"detect_cnt",cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).html('<button type="button" class="btn-link"><span class="detectCnt">'+c+"건</span></button>")[0].outerHTML}},{text:"상태",datafield:"str_stat",cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).html('<span class="mngStatus">'+c+"</span>")[0].outerHTML}}]}),c.on("cellclick",function(a){if("case_nm"===a.args.datafield){var c=(a.args.originalEvent.toElement.className,a.args.row.bounddata),d=c.case_id,e=c.status;h(b.urlForm+"?case_id="+d+"&status="+e)}else if("detect_cnt"===a.args.datafield){var c=a.args.row.bounddata,d=c.case_id,f=c.case_start_time,g=c.case_end_time,i=c.time_type,j=c.times,k=b.urlResult+"?case_id="+d+"&start_time="+f+"&end_time="+g+"&time_type="+i+"&times="+j;$(this).addModalPage(k)}})},f=function(){var a=c.grid.parent().siblings(".grid-bottom").find(".btn-add"),d=c.grid.parent().siblings(".grid-bottom").find(".btn-delete");c.form.find(".form-submit").off().on("click",function(){g()}),a.off().on("click",function(){h(b.urlForm)}),d.off().on("click",function(){var a=[],b=c.grid.jqxGrid("selectedrowindexes"),d=c.grid.jqxGrid("getdisplayrows"),e=[];for(var f in d)for(var g=0,h=b.length;g<h;g++)b[g]==d[f].boundindex&&e.push(d[f].boundindex);if(e.length>0){for(var g in e){var j=c.grid.jqxGrid("getrowdata",e[g]);if(!j)break;a.push(j.case_id)}i(a)}else _alert("선택한 이벤트가 없습니다.")})},g=function(){c.grid.jqxGrid("updatebounddata"),c.grid.jqxGrid("clearselection")},h=function(a){new ModalPopup(a,{width:800,height:550,autoScroll:!0,onClose:function(){g()}})},i=function(a){_confirm("삭제하시겠습니까?",{onAgree:function(){$("body").requestData(b.urlDelete,{del_case_list:a},{callback:function(a){g()}})}})},j=function(){if(!(a.length<1)){var d={case_id_arr:a},e=function(a){for(var b in a){var d=a[b],e=d.case_id,f=d.proc_pct,g=c.grid.find("#"+e),h=g.data("proc_date"),i=d.proc_dt;h==i&&f+"%"!=g.find(".prcsPctT").text()&&($(".mngStatus").eq(b).text(d.str_stat),$(".detectCnt").eq(b).text(d.detect_cnt+"건"),$(".prcsPctB").eq(b).width(f+"%"),$(".prcsPctT").eq(b).text(f+"%"))}};$("body").requestData(b.urlProcPct,d,{callback:e})}};return{init:d}}(),$(function(){slapp.searchRuleset.caseList.init()});