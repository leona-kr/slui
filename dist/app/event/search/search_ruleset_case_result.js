"use strict";_SL.nmspc("searchRuleset").caseResult=function(){var a={},b={urlList:gCONTEXT_PATH+"event/search_ruleset_case_result.json",urlForm:gCONTEXT_PATH+"event/search_ruleset_case_form.html",urlRulesForm:gCONTEXT_PATH+"event/search_ruleset_form.html",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlChartData:gCONTEXT_PATH+"event/eventCaseChartData.json",formId:"#searchRulesetCaseResult",tableHeadId:"#caseResultTableHead",tableListId:"#caseResultTableList",tableViewId:"#schRuleCaseResultView",lineChartId:"lineChartContainer",chartId:"#chartContainer",btnForm:".grid-bottom"},c={form:$(b.formId),tableHead:$(b.tableHeadId),currPage:$(b.tableHeadId+" [name=currPage]"),tableTitle:$(b.tableListId+" thead"),tableList:$(b.tableListId+" tbody"),tableView:$(b.tableViewId),caseId:$(b.formId+" [name=case_id]"),sTime:$(b.formId+" [name=start_time]"),eTime:$(b.formId+" [name=end_time]"),sDay:$(b.formId+" [name=startDay]"),sHour:$(b.formId+" [name=startHour]"),sMin:$(b.formId+" [name=startMin]"),eDay:$(b.formId+" [name=endDay]"),eHour:$(b.formId+" [name=endHour]"),eMin:$(b.formId+" [name=endMin]"),timeType:$(b.formId+" [name=time_type]"),times:$(b.formId+" [name=times]")},d=function(){e(),f(),g()},e=function(){var d=$.extend({},_SL.serializeMap(c.form),{pagesize:c.tableHead.find("[name=pageRow]").val(),currPage:c.tableHead.find("[name=currPage]").val()});$("body").requestData(b.urlList,d,{callback:function(d,e,f){if(d){_SL.setDataToForm(d,c.form),_SL.setDataToForm(d,c.tableHead),$("#rsTotalCnt").text(_SL.formatNumber(d.totalCount)),$("#rsSpanTotalPage").text(_SL.formatNumber(d.totalPage)),c.currPage.data("total-page",d.totalPage),c.sDay.val(d.startDay),c.sHour.val(d.startHour),c.sMin.val(d.startMin),c.eDay.val(d.endDay),c.eHour.val(d.endHour),c.eMin.val(d.endMin);var g=d.splitFieldVal,h=d.data,i=d.list,j=[];h.group_field.length>0&&(j=h.group_field.split(",")),g=$.extend({},g),a=$.extend({},i);var k=c.tableView;if(k.empty(),null!=h){var l,m,n=$("<tr>"),o=$("<tr>"),p=$("<tr>"),q=$("<tr>"),r=$("<tr>"),s="",t="",u="",v="";if(n.append('<th scope="row">탐지명</th>'),n.append('<td><span="">'+h.case_nm+"</span></td>"),n.append('<th scope="row">검증기간</th>'),n.append("<td>"+_SL.formatDate(h.case_start_time,"yyyyMMddHHmm","yyyy-MM-dd HH:mm")+" ~ "+_SL.formatDate(h.case_end_time,"yyyyMMddHHmm","yyyy-MM-dd HH:mm")+"</td>"),o.append('<th scope="row">룰셋</th>'),o.append('<td colspan="3"><pre name="search_query">'+h.search_query+'</pre><textarea name="tx_search_query" class="form-area" style="width:500px; display: none;" rows="3" wrap="hard">'+h.search_query+"</textarea></td>"),l=1==h.time_type?" Minute":" Hour",0==j.length)s="전체";else for(var w in j)for(var x in g)x==j[w]&&(s+=0==w?g[x]:", "+g[x]);if(p.append('<th scope="row">기준시간</th>'),p.append("<td>"+h.times+l+"</td>"),p.append('<th scope="row">기준필드</th>'),p.append("<td>"+s+"</td>"),m=h.func?"COUNT":"SUM",null!=h.func_field)for(var x in g)x==h.func_field&&(t=" ["+g[x]+"]");if(q.append('<th scope="row">함수</th>'),q.append("<td>"+m+t+"</td>"),q.append('<th scope="row">임계치</th>'),q.append("<td>"+h.limit_count+"</td>"),""!=h.distinct_field){var y=h.distinct_field.split(",");for(var w in y)for(var x in g)x==y[w]&&(u+=0==w?g[x]:", "+g[x])}0!=h.distinct_count&&(v=h.distinct_count),r.append('<th scope="row">유일필드</th>'),r.append("<td>"+u+"</td>"),r.append('<th scope="row">유일필드 임계치</th>'),r.append("<td>"+v+"</td>"),k.append(n,o,p,q,r)}var z=c.tableTitle,A=c.tableList;if(z.children().remove(),A.children().remove(),i.length>0)for(var w in i){var B=$("<tr>"),C=$("<tr>"),D=i[w];if(0==w){if(B.append('<th scope="col" width="40">번호</th>'),B.append('<th scope="col">발생시간</th>'),B.append('<th scope="col">탐지시간</th>'),j.length>0)for(var E in j)for(var x in g)x==j[E]&&B.append('<th scope="col">'+g[x]+"</th>");1==h.func?B.append('<th scope="col">COUNT</th>'):B.append('<th scope="col">SUM</th>'),""!=h.distinct_field&&B.append('<th scope="col">유일필드 건수</th>'),B.appendTo(z)}if(C.append($('<td class="align-center">'+(parseInt(w)+1+d.recordstartindex)+"</td>")),C.append($('<td class="align-center">'+_SL.formatDate(D.event_time,"yyyyMMddHHmm","MM-dd HH:mm")+"</td>")),C.append($('<td class="align-center">'+_SL.formatDate(D.sdt,"yyyyMMddHHmm","MM-dd HH:mm")+" ~ "+_SL.formatDate(D.ddt,"yyyyMMddHHmm","MM-dd HH:mm")+"</td>")),j.length>0)for(var E in j)C.append('<td class="align-center">'+D.splitFieldVal[E]+"</td>");C.append($("<td class='align-center'><a href='#' onclick='slapp.searchRuleset.caseResult.goSearchPopup(\""+(parseInt(w)+1+d.recordstartindex)+'","'+h.group_field+"\");'>"+D.cnt+"</a></td>")),null!=D.distinct_field&&C.append($('<td class="align-center">'+D.distinct_cnt+"건</td>")),C.appendTo(A)}else z.children().remove(),z.append($('<tr><th scope="col">번호</th><th scope="col">발생시간</th><th scope="col">탐지시간</th><th scope="col">COUNT</th></tr>')),A.children().remove(),A.append($('<tr><td class="list-empty" colspan="4">There is no Search Result</td></tr>'));slui.attach.setTransformSelect(b.formId)}}})},f=function(){var a=c.tableList.parent().siblings(".grid-bottom").find(".btn-add");a.off().on("click",function(){var a=b.urlRulesForm+"?case_id="+c.caseId.val();new ModalPopup(a,{width:800,height:510,onClose:function(){n()}})}),c.form.find(".form-submit").off().on("click",function(){var a=c.sDay.val()+c.sHour.val()+c.sMin.val(),d=c.eDay.val()+c.eHour.val()+c.eMin.val(),e=_SL.formatDate.diff(a,d);return e<=0?void _alert("시작일이 종료일보다 큽니다."):e/6e4>$(b.formId+" option:last-child").val()?void _alert("검색 기간 초과입니다."):void(_SL.validate(c.form)&&(c.sTime.val(a),c.eTime.val(d),n()))}),c.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var b=function(a,b){var c=a.siblings(".tform-select");c.find(".tform-select-t").text(b).end().find(".tform-select-option[data-value="+b+"]").addClass("selected").end(),a.val(b)},d=_SL.formatDate.addMin(c.form.find("[name=endDay]").val()+c.form.find("[name=endHour]").val()+c.form.find("[name=endMin]").val(),-a);b(c.form.find("[name=startDay]"),d.substring(0,8)),b(c.form.find("[name=startHour]"),d.substring(8,10)),b(c.form.find("[name=startMin]"),d.substring(10,12))}}),c.form.find("[name=startDay],[name=startHour],[name=startMin],[name=endDay],[name=endHour],[name=endMin]").change(function(){var a=c.form.find("[name=timeSet]"),b=a.siblings(".tform-select").find("[data-value=0]").text();a.val(0).siblings(".tform-select").find(".tform-select-t").text(b)}),c.tableHead.find(".btn-prev").off().on("click",function(){i()}),c.tableHead.find(".btn-next").off().on("click",function(){j()}),c.currPage.off().on("keydown",function(){k()}),c.tableHead.find("[name=pageRow]").change(function(){n()})},g=function(){$.getJSON(b.urlChartData,{case_id:c.caseId.val(),start_time:c.sTime.val(),end_time:c.eTime.val(),time_type:c.timeType.val(),times:c.times.val()},function(a){var b=m,c=a.linearScale,d=a.chartData;for(var e in d)0==e?d[e].showLabel=0:d[e-1].label!=d[e].label&&(d[e].showLabel=1);b.dataSource.data=d,b.dataSource.chart=$.extend({},slui.chart.chartConfig,b.dataSource.chart),b.dataSource.chart.subCaption="Linear scale : "+c,h(b)})},h=function(a){FusionCharts.ready(function(){new FusionCharts(a).render()})},i=function(){var a=parseInt(c.currPage.val());if(1!=a){if(0==c.currPage.data("total-page"))return void c.currPage.val(1);c.currPage.val(a-1),n()}},j=function(){var a=parseInt(c.currPage.val());if(a!=c.currPage.data("total-page")){if(0==c.currPage.data("total-page"))return void c.currPage.val(1);c.currPage.val(a+1),n()}},k=function(){var a=(event.srcElement||event.target).value,b=parseInt(c.currPage.data("total-page"));if(13==event.keyCode){if(isNaN(a)||parseInt(a)<1||parseInt(a)>b)return;$("#currPage").val(a),n()}},l=function(d,e){var f=c.form.find("[name='logSearchForm']");0==f.length&&(f=$('<form name="logSearchForm">'),f.append('<input type="hidden" name="start_time">'),f.append('<input type="hidden" name="end_time">'),f.append('<input type="hidden" name="filter_type">'),f.append('<input type="hidden" name="expert_keyword">'),f.append('<input type="hidden" name="template_id" value="popup">'),c.form.append(f)),d-=1;var g=a[d].sdt,h=a[d].ddt,i=e.split(","),j="("+$("[name=tx_search_query]").val()+")",k=a[d].splitFieldVal,l=/.*\[(\d+)\]$/,m="";for(var d in i){try{m=k[d]}catch(n){m="-"}if(""!=j&&(j+=" AND "),"-"!==m){var o=m.match(l);o&&o[1]&&(m=o[1]),j+=i[d]+":"+_SL.luceneValueEscape(m)}else j+="NOT "+i[d]+":*"}$("[name=logSearchForm] [name=start_time]").val(g),$("[name=logSearchForm] [name=end_time]").val(h),$("[name=logSearchForm] [name=filter_type]").val(2),$("[name=logSearchForm] [name=expert_keyword]").val(j);var p="logSearchWin_"+(new Date).getTime();return f.attr({target:p,action:b.urlLogSearch}).submit(),!1},m={type:"area2d",renderAt:b.lineChartId,width:"100%",height:"200",dataFormat:"json",dataSource:{chart:{yAxisName:"Event Count"},data:[]}},n=function(){e(),g()};return{init:d,goSearchPopup:l}}(),$(function(){slapp.searchRuleset.caseResult.init()});