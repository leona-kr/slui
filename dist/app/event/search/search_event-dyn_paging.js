"use strict";_SL.nmspc("searchEvent").dynPaging=function(){var a,b=gCONTEXT_PATH+"event/",c={DOM:{formId:"#searchSearchEventList",searchEventListTable:"#searchEventListTable",pageRow:"#pageRow",currPage:"#currPage",divPaging:"#divPaging",divTotal:"#divTotal",classMore:"btn-basic btn-more",classPcap:"btn-basic btn-pcap",classFieldName:"field-name",classFieldValue:"field-value"},URL:{list:b+"search_event_list.json",logSearch:gCONTEXT_PATH+"monitoring/log_search.html"},timeUnit:{min:6e4,hour:36e5,day:864e5,week:6048e5,month:2592e6},schTimeUnit:{hour:60},pageRowUnit:[10,15,20,30,50,100],fixedSizeField:{event_time:130,event_option:180,standard_time:90,limit_count:80,limit_distinct_count:80,cnt:80,event_cate_cd:50,event_level:100,handling_type_cd:50},alignLeftFieldRegExp:/(event_nm)/},d={form:$(c.DOM.formId),searchEventListTable:$(c.DOM.searchEventListTable),pageRow:$(c.DOM.pageRow),currPage:$(c.DOM.currPage),divPaging:$(c.DOM.divPaging),divTotal:$(c.DOM.divTotal),sDay:$(c.DOM.formId+" [name=startDay]"),sHour:$(c.DOM.formId+" [name=startHour]"),sMin:$(c.DOM.formId+" [name=startMin]"),eDay:$(c.DOM.formId+" [name=endDay]"),eHour:$(c.DOM.formId+" [name=endHour]"),eMin:$(c.DOM.formId+" [name=endMin]"),groupCd:$(c.DOM.formId+" [name=s_group_cd]"),eventCateCd:$(c.DOM.formId+" [name=s_event_cate_cd]"),eventNm:$(c.DOM.formId+" [name=s_event_nm]"),eventLevel:$(c.DOM.formId+" [name=s_event_level]"),fieldVal:$(c.DOM.formId+" [name=s_field_val]"),handlingTypeCd:$(c.DOM.formId+" [name=s_handling_type_cd]"),dashboardYn:$(c.DOM.formId+" [name=s_dashboard_yn]"),eventViewFields:$(c.DOM.formId+" [name=event_view_fields]")},e={field_idx_at_TH:1,view_fields:["eqp_dt","src_ip","dstn_ip","dstn_port","eqp_ip","attack_nm","src_country_name","prtc"],start_time:0,end_time:0,pageRow:0,currPage:1,startIndex:0,totalPage:1,groupCd:"",eventCateCd:"",eventNm:"",eventLevel:"",fiedlVal:"",handlingTypeCd:"",dashboardYn:"",total:0,rows:0,listData:[]},f=function(){a=slapp.searchEvent.dlgViewField,""!=gSearchEventParam.event_view_fields&&(e.viewFields=gSearchEventParam.event_view_fields,g()),i();for(var b in c.pageRowUnit)d.pageRow.append("<option value='"+c.pageRowUnit[b]+"'>"+c.pageRowUnit[b]+"per Page</option>");$("option",d.pageRow).filter("[value="+e.pageRow+"]").prop("selected",!0),d.searchEventListTable.on("click",".tr-toggler",function(a,b){$(a.target).toggleClass("open").closest("tr").next().toggle()}),d.searchEventListTable.on("click",".btn-loglist-toggle",function(a,b){$(this).hasClass("active")?($(this).removeClass("active"),$(this).parents("tr").find(".log-lists").addClass("list-inline")):($(this).addClass("active"),$(this).parents("tr").find(".log-lists").removeClass("list-inline"))}),d.pageRow.change(function(a){var b=d.pageRow.val();x(1,b)}),d.currPage.keydown(function(a){if(13==a.keyCode){if(/[^\d]/.test(d.currPage.val())||d.currPage.val()>e.totalPage)return;setTimeout(function(){x(d.currPage.val(),e.pageRow)},1)}}),$(".btn-next",d.divPaging).on("click",function(){var a=e.currPage+1;x(a,e.pageRow)}),$(".btn-prev",d.divPaging).on("click",function(){var a=e.currPage-1;x(a,e.pageRow)}),d.searchEventListTable.on("change","#chk_all",function(){var a=this.checked;$("[name=chk_idx]").each(function(b){this.checked=a})}),d.searchEventListTable.on("click",".view-field-setter",function(){a.open(e.viewFields)}),setTimeout(function(){d.searchEventListTable.colResizable({liveDrag:!0,minWidth:30,marginLeft:"3px",postbackSafe:!1})},1e3);var f=setInterval(function(){d.searchEventListTable.find("td").size()>0&&($(window).trigger("resize"),clearInterval(f))},1e3);d.searchEventListTable.on("click",".event-nm",function(a,b){var c=$(this).data("aria"),d=c.split(","),e=d[0];y(e)})},g=function(){d.eventViewFields.val(JSON.stringify(e.viewFields))},h=function(){e.total=0,e.currPage=1,e.startIndex=0,e.listData=[]},i=function(){var a,b,f;e.field_idx_at_TH=1,f=$("<tr></tr>"),f.append("<th width='30'><input type='checkbox' name='chk_all' id='chk_all' class='form-transform' tabindex='-1'><span class='form-clone' tabindex='0'></span></th>"),e.field_idx_at_TH++,f.append("<th width='35'>번호</th>");for(var g in e.viewFields)a=c.fixedSizeField[e.viewFields[g]],b=gFieldCaptions[e.viewFields[g]],b||(b=gFieldJson[e.viewFields[g]]),f.append($("<th>").css("width",a?a+"px":"").addClass("slui-droppable").data("field_index",g).append($("<span>").addClass("slui-draggable").data("field_index",g).append(b?b:e.viewFields[g])));f.append("<th class='slui-droppable' width='30'><span class='view-field-setter icon-cog-full'></span></th>"),d.searchEventListTable.append($("<thead>").append(f)).append($("<tbody>")),s(),f=null},j=function(){var a=d.searchEventListTable.children().detach();setTimeout(function(){a.remove(),a=null},1e3)},k=function(){var a=$("tbody",d.searchEventListTable).detach();d.searchEventListTable.append($("<tbody>")),setTimeout(function(){a.remove(),a=null},1e3)},l=function(){m()},m=function(){e.start_time=d.sDay.val()+d.sHour.val()+d.sMin.val(),e.end_time=d.eDay.val()+d.eHour.val()+d.eMin.val(),e.pageRow=parseInt(d.pageRow.val())||15,e.startIndex=(e.currPage-1)*e.pageRow,e.groupCd=d.groupCd.val(),e.eventCateCd=d.eventCateCd.val(),e.eventNm=d.eventNm.val(),e.eventLevel=d.eventLevel.val(),e.fiedlVal=d.fieldVal.val(),e.handlingTypeCd=d.handlingTypeCd.val(),e.dashboardYn=d.dashboardYn.val(),d.divPaging.hide(),h(),k(),n()},n=function(){$("body").requestData(c.URL.list,{start_time:e.start_time,end_time:e.end_time,pageRow:e.pageRow,startIndex:e.startIndex,s_group_cd:e.groupCd,s_event_cate_cd:e.eventCateCd,s_event_nm:e.eventNm,s_event_level:e.eventLevel,s_field_val:e.fiedlVal,s_handling_type_cd:e.handlingTypeCd,s_dashboard_yn:e.dashboardYn},{callback:o})},o=function(a,b,c){a.rsList.length>0&&(e.listData=a.rsList,p(a.rsList)),e.total=a.total,r()},p=function(a){var b,c,f,g,h,i,j,k=1;for(var l in a){b=a[l],k=e.startIndex+parseInt(l)+1,h=$("<tr></tr>"),h.append("<td><input type='checkbox' name='chk_idx' data-num='"+l+"' data-key='"+b.event_seq+"' value="+k+" class='form-transform'><span class='form-clone'></span></td>"),h.append("<td>"+_SL.formatNumber(k)+"</td> ");for(var m in e.viewFields)f=e.viewFields[m],i=$("<td></td>"),h.append(q(i,parseInt(l),f,b[f],!0));$("<td></td>").append("<button type=\"button\" class='tr-toggler btn-toggle'></span>").appendTo(h),h.appendTo(d.searchEventListTable),h=$("<tr style='display:none'></tr>").append("<td></td> "),h.append("<td></td> "),i=$("<td class='align-left' colspan="+e.viewFields.length+">"),i.append($("<div>").addClass("log-lists").addClass("list-inline").append($("<dl>")));for(f in b)$.inArray(f,e.viewFields)==-1&&q($("dl",i),parseInt(l),f,b[f],!1);h.append(i).append('<td style="vertical-align:top;"><button type="button" class="btn-loglist-toggle icon-list"></button></td>').appendTo($("tbody",d.searchEventListTable))}b=null,c=null,f=null,g=null,h=null,i=null,j=null},q=function(a,b,c,d,e){var f,g="context-menu-one",h=d||"",i=h,j=["Low","Middle","High"],k=["label-success","label-attention","label-danger"];if(e)switch(c){case"event_time":a.append(_SL.formatDate(h,"yyyyMMddHHmmss","yyyy-MM-dd HH:mm:ss"));break;case"event_nm":var l=b+","+c;i=h,h=$("<button>").addClass("event-nm").text(i).attr({"data-aria":l}).addClass(g),a.append(h);break;case"group_field":if(""==h)h="전체";else{var m=h.split(","),n="";for(var o in m)n+=gFieldJson[m[o]]+"("+m[o]+"), ";n=n.substring(0,n.length-2),h=n}a.append(h);break;case"event_cate_cd":a.append(gComCodes.eventCateCd[h]);break;case"event_level":a.append('<span class="'+k[h-1]+'" style="float:left;margin-left:10px;">'+j[h-1]+"</span>");break;case"handling_type_cd":a.append(""==h?"-":gComCodes.eventStatus[h]);break;case"cnt":case"distinct_cnt":case"limit_distinct_count":case"limit_count":h=_SL.formatNumber(h),a.append(h);break;default:if(""==h)return a;a.append(h)}else a.append($("<dt>").append($("<span>").addClass("field-name").addClass("field-name slui-draggable").data("field_name",c).text(gFieldCaptions[c]||c))),f=$("<dd>").appendTo(a),f.text(h);return a},r=function(){e.totalPage=Math.floor(e.total/e.pageRow),e.total%e.pageRow>0&&e.totalPage++,0==e.total&&(k(),$("<tr></tr>").append("<td class='list-empty' colspan='"+(e.field_idx_at_TH+e.viewFields.length+1)+"'>검색 결과가 없습니다.</td> ").appendTo(d.searchEventListTable)),u(),v(),t()},s=function(){$("th:gt(1)",d.searchEventListTable).droppable({accept:".slui-draggable",scope:"addField",activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(a,b){var c,d=$(this).data("field_index");void 0===d&&(d=e.viewFields.length),c=e.viewFields.slice(0,d).concat(b.helper.data("field_name"),e.viewFields.slice(d)),setTimeout(function(){w(c)},0)}}),$("th .slui-draggable",d.searchEventListTable).draggable({opacity:.8,scope:"removeField",helper:function(){return $("<div>").css({padding:"3px",border:"1px solid #67687d","background-color":"#f5f7f9","z-index":"1","whte-space":"nowrap"}).data("field_index",$(this).data("field_index")).append($(this).clone())},start:function(a,b){var c=parseInt(b.helper.data("field_index")),f=d.searchEventListTable.find("th:eq("+(e.field_idx_at_TH+c)+")"),g=$("<div style='position:absolute;font-size:64px;width:68px;height:68px;padding-top:4px;border:1px solid #666;text-align:center;'>").addClass("slui-layer-trash icon-trash");d.searchEventListTable.parents(".area-log-body").append(g),g.position({my:"center top",of:f,at:"center bottom+1"}),g.droppable({accept:".slui-draggable",scope:"removeField",opacity:.9,activeClass:"",hoverClass:"icon-trash-full text-gray",drop:function(a,b){var c,d=parseInt(b.helper.data("field_index"));c=e.viewFields.slice(0,d).concat(e.viewFields.slice(d+1)),setTimeout(function(){w(c)},0)}})},stop:function(a,b){$(".slui-layer-trash").remove()}})},t=function(){$("tbody .slui-draggable",d.searchEventListTable).draggable({scope:"addField",opacity:.7,helper:"clone",start:function(a,b){$(b.helper).data("field_name",$(this).data("field_name"))}})},u=function(){d.divTotal.html("Total <strong class='cnt'>"+_SL.formatNumber(e.total)+"</strong> Rows")},v=function(){0==e.total?d.divPaging.hide():(d.currPage.val(e.currPage),$("span",d.divPaging).html(_SL.formatNumber(e.totalPage)),e.currPage<=1?$(".btn-prev",d.divPaging).hide():$(".btn-prev",d.divPaging).show(),e.currPage>=e.totalPage?$(".btn-next .spanTotalPage",d.divPaging).hide():$(".btn-next",d.divPaging).show(),d.divPaging.show())},w=function(a,b){JSON.stringify(e.viewFields)!=JSON.stringify(a)&&(d.searchEventListTable.colResizable({disable:!0}),e.viewFields=a,e.sch_rows=e.rows,j(),i(),b||(p(e.listData),r()),d.searchEventListTable.colResizable({liveDrag:!0,minWidth:30,marginLeft:"3px",postbackSafe:!0,isLocalStorage:!0}),g())},x=function(a,b){a="string"==typeof a?parseInt(a,10):a,b="string"==typeof b?parseInt(b,10):b,a<1&&(a=1),e.currPage=a,e.pageRow=b,e.startIndex=(a-1)*b,e.listData=new Array,k(),n()},y=function(a){var b=e.listData[a],d=_SL.formatDate(b.sdt,"yyyyMMddHHmmss","yyyyMMddHHmm"),f=_SL.formatDate.addMin(_SL.formatDate(b.ddt,"yyyyMMddHHmmss","yyyyMMddHHmm"),1),g=(b.event_time,"sim_event_id:"+b.sim_event_id),h=$("#goLogForm");0==h.size()&&(h=$("<form id=goLogForm>").attr({action:c.URL.logSearch,method:"post"}),h.append($("<input>").attr({type:"hidden",name:"network_join_cd"}).val("ANALYZER")),h.append($("<input>").attr({type:"hidden",name:"action"}).val("event")),h.append($("<input>").attr({type:"hidden",name:"start_time"})),h.append($("<input>").attr({type:"hidden",name:"end_time"})),h.append($("<input>").attr({type:"hidden",name:"filter_type"}).val("2")),h.append($("<input>").attr({type:"hidden",name:"expert_keyword"})),h.append($("<input>").attr({type:"hidden",name:"template_id"}).val("popup")),h.append($("<input>").attr({type:"hidden",name:"log_view_fields"}))),$("[name=start_time]",h).val(d),$("[name=end_time]",h).val(f),$("[name=expert_keyword]",h).val(g),b.view_field?$("[name=log_view_fields]",h).val(b.view_field):$("[name=log_view_fields]",h).val("");var i="logSearchWin_"+(new Date).getTime();h.attr({target:i}).submit()},z=function(){return e.listData};return{init:f,search:l,movePage:x,changeFieldCaption:w,goSearchPopup:y,getListData:z}}();