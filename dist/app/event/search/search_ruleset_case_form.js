"use strict";_SL.nmspc("searchRuleset").caseForm=function(){var a={formId:"#formSearchRulesetCase",urlSelect:gCONTEXT_PATH+"event/search_ruleset_case_form.json",urlDelete:gCONTEXT_PATH+"event/search_ruleset_case_delete.do",urlComConfigForm:gCONTEXT_PATH+"sysdata/com_group_field_form.html",urlLoadCaseList:gCONTEXT_PATH+"event/search_ruleset_case_import.html",urlStatCheck:gCONTEXT_PATH+"event/search_ruleset_case_stat_check.json",urlRulesetCaseProc:gCONTEXT_PATH+"event/search_ruleset_case_stop_or_retry.do",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlQueryChk:gCONTEXT_PATH+"monitoring/log_search_list.json",urlChkCaseNm:gCONTEXT_PATH+"event/search_ruleset_case_nm_check.json",add:{action:gCONTEXT_PATH+"event/search_ruleset_case_add.do",message:"등록 하시겠습니까?"},update:{action:gCONTEXT_PATH+"event/search_ruleset_case_update.do",message:"수정 하시겠습니까?"}},b={form:$(a.formId),btnImport:$(a.formId+" .btn-import"),btnGrpFldAdd:$(a.formId+" .btn-group-fld-add"),groupFieldSel:$(a.formId+" [name=group_field_sel]"),times:$(a.formId+" [name=times]"),timeType:$(a.formId+" [name=time_type]"),caseId:$(a.formId+" [name=case_id]"),pCaseNm:$(a.formId+" [name=p_case_nm]"),caseSTime:$(a.formId+" [name=case_start_time]"),caseETime:$(a.formId+" [name=case_end_time]"),grpFld:$(a.formId+" [name=group_field]"),distFld:$(a.formId+" [name=distinct_field]"),status:$(a.formId+" [name=status]"),characterLimit:$(a.formId+" [name=characterLimit]"),logMaxCnt:$(a.formId+" [name=logMaxCnt]"),caseNm:$(a.formId+" [name=case_nm]"),timeSet:$(a.formId+" [name=timeSet]"),caseStartDay:$(a.formId+" [name=caseStartDay]"),caseStartHour:$(a.formId+" [name=caseStartHour]"),caseStartMin:$(a.formId+" [name=caseStartMin]"),caseEndDay:$(a.formId+" [name=caseEndDay]"),caseEndHour:$(a.formId+" [name=caseEndHour]"),caseEndMin:$(a.formId+" [name=caseEndMin]"),schQuery:$(a.formId+" [name=search_query]"),func:$(a.formId+" [name=func]"),funcFld:$(a.formId+" [name=func_field]"),limitCnt:$(a.formId+" [name=limit_count]"),distFldSel:$(a.formId+" [name=distinct_field_sel]"),distCnt:$(a.formId+" [name=distinct_count]")},c={isNew:""==b.caseId.val(),mode:""==b.caseId.val()?a.add:a.update},d=function(){b.timeType.on("change",f),k(),c.isNew?(b.form.find(".btn-delete").hide(),b.form.find(".btn-retry").hide(),b.form.find(".btn-stop").hide(),e(),h(),j(),f()):(0==b.status.val()?(b.form.find(".btn-retry").show(),b.form.find(".btn-stop").hide()):1==b.status.val()||3==b.status.val()?(b.form.find(".btn-retry").hide(),b.form.find(".btn-stop").show()):(b.form.find(".btn-retry").hide(),b.form.find(".btn-stop").hide()),b.form.find(".btn-import").hide(),b.form.find(".btn-save").hide(),b.form.find(".btn-group-fld-add").hide(),b.form.find(":input").not("[name=status],[name=case_id],.btn-delete,.btn-retry,.btn-stop,.btn-cancel").prop("disabled",!0),e(),h(),i())},e=function(){b.form.find(".btn-save").on("click",u),b.form.find(".btn-delete").on("click",v),b.form.find(".btn-retry").on("click",w),b.form.find(".btn-stop").on("click",x),b.form.find(".btn-case").on("click",t),b.btnImport.exModalPopup(a.urlLoadCaseList,{width:400,height:135,onClose:function(){}}),b.btnGrpFldAdd.exModalPopup(a.urlComConfigForm,{width:470,height:295,onClose:function(){g()}}),b.groupFieldSel.siblings(".chosen-container").find(".chosen-choices").on("mousedown","li a",function(){var a=$(this).prev().text(),c=b.orgFld.siblings(".chosen-container").find(".chosen-single").find(".chosen-selected-span").text(),d=$(this);a==c&&_confirm("원본필드가 리셋됩니다.<br>그래도 적용하시겠습니까??",{onAgree:function(){d.trigger("click"),addOrgFld()}})}),b.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var c=_SL.formatDate.addMin(b.form.find("[name=caseEndDay]").val()+b.form.find("[name=caseEndHour]").val()+b.form.find("[name=caseEndMin]").val(),-a),d=function(a,b){var c=a.siblings(".tform-select");c.find(".tform-select-t").text(b).end().find(".tform-select-option[data-value="+b+"]").addClass("selected").end(),a.val(b)};d(b.form.find("[name=caseStartDay]"),c.substring(0,8)),d(b.form.find("[name=caseStartHour]"),c.substring(8,10)),d(b.form.find("[name=caseStartMin]"),c.substring(10,12))}}),b.form.find("[name=caseStartDay],[name=caseStartHour],[name=caseStartMin],[name=caseEndDay],[name=caseEndHour],[name=caseEndMin]").change(function(){var a=b.form.find("[name=timeSet]"),c=a.siblings(".tform-select").find("[data-value=0]").text();a.val(0).siblings(".tform-select").find(".tform-select-t").text(c)}),b.func.change(s),b.distFldSel.change(r)},f=function(c){var d={1:[1,2,3,5,10,15,30],2:[1,2,3,6,12]},e=b.timeType,f=e.val();if(""!=f){b.times.empty();for(var g in d[f])b.times[0].add(new Option(d[f][g],d[f][g]));""!=b.caseId.val()&&(b.form.find("[value="+c+"]","[name=times]")[0].selected=!0)}"1"==f||"2"==f?b.form.find("[name-times]").prop("disabled",!1):b.form.find("[name-times]").prop("disabled",!0),setTimeout(function(){slui.attach.setTransformSelect(a.formId)},10)},g=function(){var a=slapp.comGroupField.form.getCode(),c=b.groupFieldSel.getSelectionOrder();b.groupFieldSel.empty();for(var d in a)b.groupFieldSel.append($("<option value='"+a[d]+"'>"+gFieldCapsJson[a[d]]+"("+a[d]+")</option>"));b.groupFieldSel.setSelectionOrder(c,!0),b.groupFieldSel.trigger("chosen:updated")},h=function(){b.groupFieldSel.chosen({search_contains:!0,width:"100%",placeholder_text_multiple:"[선택하세요]",max_selected_options:10}),b.groupFieldSel.siblings(".chosen-container").find(".chosen-results").css("max-height","100px").end().siblings(".chosen-container").find(".chosen-choices").css({"max-height":"55px","min-height":"55px","overflow-y":"auto"}),b.distFldSel.chosen({search_contains:!0,width:"100%",placeholder_text_multiple:"[선택하세요]",max_selected_options:10}),b.distFldSel.siblings(".chosen-container").find(".chosen-results").css("max-height","100px").end().siblings(".chosen-container").find(".chosen-choices").css({"max-height":"55px","min-height":"55px","overflow-y":"auto"})},i=function(){var c=b.caseId.val(),d={case_id:c},e=function(a){_SL.setDataToForm(a,b.form);var c=a.case_start_time,d=a.case_end_time;b.caseStartDay.val(c.substring(0,8)),b.caseStartHour.val(c.substring(8,10)),b.caseStartMin.val(c.substring(10,12)),b.caseEndDay.val(d.substring(0,8)),b.caseEndHour.val(d.substring(8,10)),b.caseEndMin.val(d.substring(10,12));var e=a.group_field;if(e){var g=e.split(",");for(var h in g){var i=g[h];gGroupField.indexOf(i)<0&&(gFieldCapsJson[i]="undefined",b.groupFieldSel.append("<option value='"+i+"'>undefined["+i+"]</option>"))}b.groupFieldSel.setSelectionOrder(g,!0)}var e=a.distinct_field;if(e){var g=e.split(",");for(h in g){var i=g[h];gGroupField.indexOf(i)<0&&(gFieldCapsJson[i]="undefined",b.distFldSel.append("<option value='"+i+"'>undefined["+i+"]</option>"))}b.distFldSel.setSelectionOrder(g,!0)}else b.distCnt.val("");b.groupFieldSel.trigger("chosen:updated"),b.distFldSel.trigger("chosen:updated"),j(),f(a.times)};$("body").requestData(a.urlSelect,d,{callback:e})},j=function(){r(),s()},k=function(){var a=b.caseSTime.val().length>0?b.caseSTime.val():_SL.formatDate.addMin(_SL.formatDate(),-30),c=b.caseETime.val().length>0?b.caseETime.val():_SL.formatDate();b.caseStartDay.val(a.substring(0,8)),b.caseStartHour.val(a.substring(8,10)),b.caseStartMin.val(a.substring(10,12)),b.caseEndDay.val(c.substring(0,8)),b.caseEndHour.val(c.substring(8,10)),b.caseEndMin.val(c.substring(10,12))},l=function(){switch($.trim(arguments[0])){case"SAVE":n();break;case"DELETE":_confirm("삭제 하시겠습니까?",{onAgree:function(){$("body").requestData(a.urlDelete,{case_id:b.caseId.val()},{callback:function(a,b,c){_alert(c,{onAgree:function(){y(!0)}})}})}});break;case"STOP":q(0);break;case"RETRY":q(1);break;case"CANCEL":y(!0)}},m=function(){return!!_SL.validate(b.form)&&("1"==b.func.val()||null!=b.funcFld.val()||(_alert("함수필드를 선택하세요"),!1))},n=function(){if(m()){var d=b.characterLimit.val(),e=b.schQuery.val(),f=Number(e.length);if(f>=d)return void _alert("검색어의 현재입력길이: "+f+"byte<br>입력가능길이는: "+d+"byte입니다.");var g=b.caseStartDay.val()+b.caseStartHour.val()+b.caseStartMin.val(),h=b.caseEndDay.val()+b.caseEndHour.val()+b.caseEndMin.val(),i=_SL.formatDate.diff(g,h)/6e4,j=2==b.timeType.val()?60*b.times.val():b.times.val();if(i<=0)return void _alert("검증기간을 잘못 입력하셨습니다.<br>확인 후 다시 입력바랍니다.");if(i<j)return void _alert("검증기간이 기준시간 미만입니다.<br>확인 후 다시 입력바랍니다.");if(i>10080)return void _alert("검증기간은 7일을 초과할 수 없습니다.<br>확인 후 다시 입력바랍니다.");b.caseSTime.val(g),b.caseETime.val(h),c.isNew&&$("body").requestData(a.urlChkCaseNm,_SL.serializeMap(b.form),{callback:function(a){if("000"==a.RESULT_CODE){if(null!=a.data)return void _alert("검증명["+a.data.case_nm+"]은(는)<br>이미 존재하므로 등록할 수 없습니다");o()}}})}},o=function(){var a=b.groupFieldSel.getSelectionOrder();b.grpFld.val(a.join());var d=b.distFldSel.getSelectionOrder();b.distFld.val(d.join()),0==a.length&&0==d?$("body").requestData(c.mode.action,_SL.serializeMap(b.form),{callback:function(a,b,c){_alert(c,{onAgree:function(){y(!0)}})}}):p()},p=function(){var d=_SL.formatDate(),e=_SL.formatDate.addMin(d,-10),f=b.schQuery.val(),g=b.logMaxCnt.val(),h={end_time:d,start_time:e,query:f,pageRow:1,startIndex:0},i=function(a){return a.total>g?void _alert("검색결과가 최대건수를 초과했습니다.<br>Case검증을 이용해 확인해 주세요.<br>(검색결과 "+_SL.formatNumber(a.total)+"건)<br>(최대건수 "+_SL.formatNumber(g)+"건)"):void $("body").requestData(c.mode.action,_SL.serializeMap(b.form),{callback:function(a,b,c){_alert(c,{onAgree:function(){y(!0)}})}})};$("body").requestData(a.urlQueryChk,h,{callback:i})},q=function(c){var d=0==c?"중지":"재요청";_confirm(d+" 하시겠습니까?",{onAgree:function(){$("body").requestData(a.urlStatCheck,{case_id:b.caseId.val()},{callback:function(e){if("000"==e.RESULT_CODE){if(5==e.data.status)return _alert("해당건은 현재 ["+e.data.str_stat+"] 상태이므로<br>"+d+"할 수 없습니다."),void l("CANCEL");b.status.val(c),$("body").requestData(a.urlRulesetCaseProc,{case_id:b.caseId.val(),status:b.status.val()},{callback:function(a,b,c){_alert(c,{onAgree:function(){y(!0)}})}})}else _alert("처리 중 오류가 발생 하였습니다.")}})}})},r=function(){null==b.distFldSel.val()?(b.distCnt.prop("disabled",!0),b.distCnt.attr("data-valid","유일필드 임계치,number")):(b.distCnt.prop("disabled",!1),b.distCnt.attr("data-valid","유일필드 임계치,required,number"))},s=function(){"1"==b.func.val()?b.funcFld.parent(".form-select-outer").css("visibility","hidden"):b.funcFld.parent(".form-select-outer").css("visibility","visible")},t=function(){var c=b.characterLimit.val(),d=b.schQuery.val(),e=Number(d.length);if(e>=c)return void _alert("검색어의 현재입력길이: "+e+"byte<br>입력가능길이는: "+c+"byte입니다.");var f=_SL.formatDate(),g=_SL.formatDate.addMin(f,-10),h=b.schQuery.val();if(""==d)return void _alert("검색어가 없습니다.");var i=b.form.find("[name='logSearchForm']");0==i.length&&(i=$('<form name="logSearchForm">'),i.append('<input type="hidden" name="start_time">'),i.append('<input type="hidden" name="end_time">'),i.append('<input type="hidden" name="filter_type">'),i.append('<input type="hidden" name="expert_keyword">'),i.append('<input type="hidden" name="template_id" value="popup">'),b.form.append(i)),$("[name=start_time]",i).val(g),$("[name=end_time]",i).val(f),$("[name=filter_type]",i).val("2"),$("[name=expert_keyword]",i).val(h);var j="logSearchWin_"+(new Date).getTime();i.attr({target:j,action:a.urlLogSearch}).submit()},u=function(){1==$(this).data("after-close");l("SAVE")},v=function(){1==$(this).data("after-close");l("DELETE")},w=function(){1==$(this).data("after-close");l("RETRY")},x=function(){1==$(this).data("after-close");l("STOP")},y=function(a){a&&b.form.find("[data-layer-close=true]").click()},z=function(a){b.caseId.val(a),i()};return{init:d,setCaseData:z}}(),$(function(){slapp.searchRuleset.caseForm.init()});