"use strict";_SL.nmspc("searchRuleset").form=function(){var a={formId:"#formSearchRuleset",urlSelect:gCONTEXT_PATH+"event/search_ruleset.json",urlDelete:gCONTEXT_PATH+"event/search_ruleset_delete.do",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlQueryChk:gCONTEXT_PATH+"monitoring/log_search_list.json",urlComCodeForm:gCONTEXT_PATH+"sysdata/comcode_form.html",urlComConfigForm:gCONTEXT_PATH+"sysdata/com_group_field_form.html",urlUserList:gCONTEXT_PATH+"system/comuser_list_to_select.html",urlCaseResult:gCONTEXT_PATH+"event/search_ruleset_case.json",add:{action:gCONTEXT_PATH+"event/search_ruleset_insert.do",message:"등록 하시겠습니까?"},update:{action:gCONTEXT_PATH+"event/search_ruleset_update.do",message:"수정 하시겠습니까?"}},b={form:$(a.formId),rulesetId:$(a.formId+" [name=ruleset_id]"),caseId:$(a.formId+" [name=case_id]"),logMaxCnt:$(a.formId+" [name=log_max_cnt]"),systemLink:$(a.formId+" [name=system_link]"),characterLimit:$(a.formId+" [name=character_limit]"),btnCateCodeAdd:$(a.formId+" .btn-register-event-cate"),viewFieldSel:$(a.formId+" [name=view_field_sel]"),times:$(a.formId+" [name=times]"),timeType:$(a.formId+" [name=time_type]"),fieldSelBox:$(a.formId+" [name=field_sel_box]"),operatorSelBox:$(a.formId+" [name=operator_sel_box]"),sysValSelBox:$(a.formId+" [name=sysval_sel_box]"),searchQuery:$(a.formId+" [name=org_search_query]"),eventOption:$(a.formId+" [name=event_option]"),groupFieldSel:$(a.formId+" [name=group_field_sel]"),btnGrpFldAdd:$(a.formId+" .btn-group-fld-add"),func:$(a.formId+" [name=func]"),funcFld:$(a.formId+" [name=func_field]"),limitCount:$(a.formId+" [name=limit_count]"),distinctFieldSel:$(a.formId+" [name=distinct_field_sel]"),distinctCount:$(a.formId+" [name=distinct_count]"),orgFld:$(a.formId+" [name=org_fld]"),dervFldSpan:$(a.formId+" .dervFldSpan"),dervFld:$(a.formId+" [name=derv_fld]"),dervFldValSpan:$(a.formId+" .dervFldValSpan"),dervFldVal:$(a.formId+" [name=derv_fld_val]"),expirePeriodSpan:$(a.formId+" .expirePeriodSpan"),expirePeriod:$(a.formId+" [name=expire_period]")},c={isNew:""==b.rulesetId.val(),isLoad:""!=b.caseId.val(),mode:""==b.rulesetId.val()?a.add:a.update},d=function(){c.isNew?(b.form.find(".btn-delete").hide(),b.form.find(".rulesetIdTr").hide(),e(),v(),g(),n()):x(),c.isLoad&&w()},e=function(){b.form.find(".btn-save").on("click",y),b.form.find(".btn-delete").on("click",B),b.form.find(".config_tab li").click(function(){h($(this).index()),slui.attach.setTransformSelect(a.formId)}),b.form.find(".btn-register-event-cate").exModalPopup(a.urlComCodeForm+"?code_type="+b.btnCateCodeAdd.data("value"),{width:550,height:455,onClose:function(){i(b.form.find("[name=event_cate_cd]")),slui.attach.setTransformSelect(a.formId)}}),b.fieldSelBox.on("change",j),b.operatorSelBox.on("change",k),b.sysValSelBox.on("change",l),b.form.find(".btn-case").on("click",m),b.eventOption.on("change",q),b.timeType.on("change",n),b.btnGrpFldAdd.exModalPopup(a.urlComConfigForm,{width:470,height:295,onClose:function(){o()}}),b.func.on("change",p),b.groupFieldSel.siblings(".chosen-container").find(".chosen-choices").on("mousedown","li a",function(){var a=$(this).prev().text(),c=b.orgFld.siblings(".chosen-container").find(".chosen-single").find(".chosen-selected-span").text(),d=$(this);a==c&&_confirm("원본필드가 리셋됩니다.<br>그래도 적용하시겠습니까??",{onAgree:function(){d.trigger("click"),s()}})}),b.form.find(".btn-plus").exModalPopup(a.urlUserList,{width:1e3,height:550,setScroll:!0,onClose:function(){f()}}),b.form.find(".btn-minus").off().on("click",function(){b.form.find("[name=chk_user_list] :selected").remove()}),b.orgFld.on("change",t),b.distinctFieldSel.on("change",r),b.dervFld.on("change",u),b.form.find("[name=case_id]").on("change")},f=function(){var a,c,d,e,f,g=slapp.user.listSel.getParam(),h=g.userDataArr,i=(g.userIdx,b.form.find("[name=chk_user_list]")),j=0,k=!1,l="";for(var m in h)a=h[m],c=a.user_id,d=a.user_nm,e=a.mobile_no,f=a.mail_addr,0==i.size()?i.append("<option value='"+c+"'>"+d+" ["+c+"], ["+e+"], ["+f+"]</option>"):(b.form.find("[name=chk_user_list] option").each(function(){c==$(this).val()&&(j=1)}),1!=j?i.append("<option value='"+c+"'>"+d+" ["+c+"], ["+e+"], ["+f+"]</option>"):(k?l+=", "+c:(l+="해당 ID가 이미 존재합니다.<br>(ID : "+c,k=!0),j=0));k&&_alert(l+" )")},g=function(){q(),p()},h=function(a){switch(b.form.find(".config_tab li").removeClass("tab-item-active"),b.form.find(".config_tab li").eq(a).addClass("tab-item-active"),a){case 0:b.form.find(".defaultTab").css("display","block"),b.form.find(".detectionInfoTab").css("display","none"),b.form.find(".actionInfoTab").css("display","none");break;case 1:b.form.find(".defaultTab").css("display","none"),b.form.find(".detectionInfoTab").css("display","block"),b.form.find(".actionInfoTab").css("display","none");break;case 2:b.form.find(".defaultTab").css("display","none"),b.form.find(".detectionInfoTab").css("display","none"),b.form.find(".actionInfoTab").css("display","block"),s()}},i=function(a){var b=slapp.comcode.form.getCode();a.append("<option value='"+b.code_id+"' selected='selected'>"+b.code_name+"</option>")},j=function(){var a=b.searchQuery,c=b.fieldSelBox,d=$.trim(a.val()),e=c.val();""!=e&&(d+=""==d?"":"+"==d.charAt(d.length-1)?"":" ",a.val(d+e+":"),c.val(""),c.trigger("chosen:updated"))},k=function(){var a=b.searchQuery,c=b.operatorSelBox,d=$.trim(a.val()),e=c.val();""!=e&&(""!=d&&"AND,OR,NOT,+".indexOf(e)!=-1&&(e=" "+e),a.val(d+e),c.val(""))},l=function(){var a=$(this).val(),c=b.searchQuery,d=$.trim(c.val());d+=""==d?"":"+"==d.charAt(d.length-1)?"":" ",c.val(d+"SYSVAR("+a+")"),$(this).val(""),b.sysValSelBox.trigger("chosen:updated")},m=function(){var c=$(a.formId+" [name=character_limit]").val(),d=b.searchQuery.val(),e=Number(d.length);if(e>=c)return void _alert("검색어의 현재입력길이: "+e+"byte<br>입력가능길이는: "+c+"byte입니다.");var f=_SL.formatDate(),g=_SL.formatDate.addMin(f,-10),h=b.searchQuery.val();if(""==h)return void _alert("검색어가 없습니다.",{onAgree:function(){b.searchQuery.focus()}});var i=b.form.find("[name='logSearchForm']");0==i.length&&(i=$('<form name="logSearchForm">'),i.append('<input type="hidden" name="start_time">'),i.append('<input type="hidden" name="end_time">'),i.append('<input type="hidden" name="filter_type">'),i.append('<input type="hidden" name="expert_keyword">'),i.append('<input type="hidden" name="template_id" value="popup">'),b.form.append(i)),$("[name=start_time]",i).val(g),$("[name=end_time]",i).val(f),$("[name=filter_type]",i).val("2"),$("[name=expert_keyword]",i).val(h);var j="logSearchWin_"+(new Date).getTime();i.attr({target:j,action:a.urlLogSearch}).submit()},n=function(c){var d={1:[1,2,3,5,10,15,30],2:[1,2,3,6,12]},e=b.times,f=b.timeType,g=f.val(),h=e.empty()[0];if(""!=g){for(var i in d[g])h.add(new Option(d[g][i],d[g][i]));"number"==typeof c&&c&&($("[value="+c+"]","[name=times]")[0].selected=!0)}"1"==g||"2"==g?e.prop("disabled",!1):e.prop("disabled",!0),setTimeout(function(){slui.attach.setTransformSelect(a.formId)},10)},o=function(){var a=slapp.comGroupField.form.getCode(),c=b.groupFieldSel.getSelectionOrder();b.groupFieldSel.empty();for(var d in a)b.groupFieldSel.append($("<option value='"+a[d]+"'>"+gFieldCapsJson[a[d]]+"("+a[d]+")</option>"));b.groupFieldSel.setSelectionOrder(c,!0),b.groupFieldSel.trigger("chosen:updated")},p=function(){1==b.func.val()?b.funcFld.siblings(".chosen-container").hide():b.funcFld.siblings(".chosen-container").show()},q=function(){b.eventOption.val()<4?(b.limitCount.prop("disabled",!0),b.limitCount.val(""),b.distinctFieldSel.val(""),b.distinctFieldSel.prop("disabled",!0)):(b.limitCount.prop("disabled",!1),b.limitCount.attr("data-valid","임계치,required,number"),b.distinctFieldSel.prop("disabled",!1)),b.distinctFieldSel.trigger("chosen:updated"),r()},r=function(){null==b.distinctFieldSel.val()?(b.distinctCount.prop("disabled",!0),b.distinctCount.attr("data-valid","유일필드 임계치,number")):(b.distinctCount.prop("disabled",!1),b.distinctCount.attr("data-valid","유일필드 임계치,required,number"))},s=function(){var a=b.orgFld.val();b.orgFld.empty().append("<option value=''>[선택하세요]</option>").chosen({search_contains:!1,width:"100%;"});var c=b.groupFieldSel.getSelectionOrder();for(var d in c){var e="",f="";e=c[d],f=gFieldCapsJson[c[d]],b.orgFld.append("<option value='"+e+"'>"+f+"("+e+")</option>")}b.orgFld.val(a).trigger("chosen:updated"),t()},t=function(){b.orgFld.val()?(b.dervFldSpan.addClass("mark-required"),b.dervFld.attr("data-valid","태깅 필드,required"),b.dervFldValSpan.addClass("mark-required"),b.dervFldVal.attr("data-valid","태깅 내용,required"),b.expirePeriodSpan.addClass("mark-required"),b.expirePeriod.attr("data-valid","만료 시간,required")):(b.dervFldSpan.removeClass("mark-required"),b.dervFld.attr("data-valid",""),b.dervFldValSpan.removeClass("mark-required"),b.dervFldVal.attr("data-valid",""),b.expirePeriodSpan.removeClass("mark-required"),b.expirePeriod.attr("data-valid",""))},u=function(){"event_extr_ruleset_id"==$(this).val()&&b.rulesetId.val()&&b.dervFldVal.val(b.rulesetId.val())},v=function(){b.viewFieldSel.chosen({search_contains:!0,width:"100%",placeholder_text_multiple:"[선택하세요]"}).end().siblings(".chosen-container").find(".chosen-results").css("max-height","200px").end().siblings(".chosen-container").find(".chosen-choices").css({"max-height":"120px","min-height":"120px","overflow-y":"auto"}),b.fieldSelBox.chosen({search_contains:!0,width:"100%"}),b.sysValSelBox.chosen({search_contains:!0,width:"100%"}),b.groupFieldSel.chosen({search_contains:!0,width:"100%",placeholder_text_multiple:"[선택하세요]",max_selected_options:10}).end().siblings(".chosen-container").find(".chosen-results").css("max-height","100px").end().siblings(".chosen-container").find(".chosen-choices").css({"max-height":"55px","min-height":"55px","overflow-y":"auto"}),b.funcFld.chosen({search_contains:!0,width:"100%",placeholder_text_single:"[선택하세요]"}),b.distinctFieldSel.chosen({search_contains:!0,width:"100%",placeholder_text_multiple:"[선택하세요]",max_selected_options:10}).end().siblings(".chosen-container").find(".chosen-results").css("max-height","100px").end().siblings(".chosen-container").find(".chosen-choices").css({"max-height":"55px","min-height":"55px","overflow-y":"auto"}),b.dervFld.chosen({search_contains:!0,width:"100%"})},w=function(){var c=b.caseId.val(),d={case_id:c},f=function(a){var c=a.data;e(),v(),_SL.setDataToForm(c,b.form);var d=c.group_field;if(d){var f=d.split(",");for(var h in f){var i=f[h];gGroupField.indexOf(i)<0&&(gFieldCapsJson[i]="undefined",b.groupFieldSel.append("<option value='"+i+"'>undefined["+i+"]</option>"))}b.groupFieldSel.setSelectionOrder(f,!0)}var d=c.distinct_field;if(d){var f=d.split(",");for(h in f){var i=f[h];gGroupField.indexOf(i)<0&&(gFieldCapsJson[i]="undefined",b.distinctFieldSel.append("<option value='"+i+"'>undefined["+i+"]</option>"))}b.distinctFieldSel.setSelectionOrder(f,!0)}else b.distinctCount.val("");g(),n(c.times)};$("body").requestData(a.urlCaseResult,d,{callback:f})},x=function(){var c=b.rulesetId.val(),d={ruleset_id:c},f=function(a){var c=a.data;e(),v(),_SL.setDataToForm(c,b.form);var d=c.view_field;if(d){var f=d.split(",");for(k in f){var h=f[k];gFieldCapsJson[h]||(gFieldCapsJson[h]="undefined",b.viewFieldSel.append("<option value='"+h+"'>undefined["+h+"]</option>"))}b.viewFieldSel.setSelectionOrder(f,!0)}var i=c.group_field;if(i){var j=i.split(",");for(var k in j){var h=j[k];gGroupField.indexOf(h)<0&&(gFieldCapsJson[h]="undefined",b.groupFieldSel.append("<option value='"+h+"'>undefined["+h+"]</option>"))}b.groupFieldSel.setSelectionOrder(j,!0)}var i=c.distinct_field;if(i){var j=i.split(",");for(k in j){var h=j[k];gGroupField.indexOf(h)<0&&(gFieldCapsJson[h]="undefined",b.distinctFieldSel.append('<option value="'+h+'">undefined['+h+"]</option>"))}b.distinctFieldSel.setSelectionOrder(j,!0)}else b.distinctCount.val("");var l=c.org_fld;if(l){var m=b.groupFieldSel.getSelectionOrder();for(var o in m){var p="",q="";p=m[o],q=gFieldCapsJson[m[o]],b.orgFld.append("<option value='"+p+"'>"+q+"("+p+")</option>")}b.orgFld.val(l)}var r=c.derv_fld;r||(b.dervFldVal.val(c.ruleset_id),b.dervFld.val("event_extr_ruleset_id")),b.dervFld.trigger("chosen:updated"),g(),n(c.times)};$("body").requestData(a.urlSelect,d,{callback:f})},y=function(){if(_SL.validate(b.form)){var a=b.characterLimit.val(),c=b.searchQuery.val(),d=Number(c.length);if(d>=a)return void _alert("검색어의 현재입력길이: "+d+"byte<br>입력가능길이는: "+a+"byte입니다.");var e=b.groupFieldSel.getSelectionOrder(),f=b.distinctFieldSel.getSelectionOrder();0==e.length&&0==f?A():z()}},z=function(){var c=_SL.formatDate(),d=_SL.formatDate.addMin(c,-60),e=b.searchQuery.val(),f=b.logMaxCnt.val(),g={end_time:c,start_time:d,query:e,pageRow:1,startIndex:0};$("body").requestData(a.urlQueryChk,g,{displayLoader:!0,callback:function(a,b,c){return a.total>f?void _alert("검색결과가 최대건수를 초과했습니다.<br>\t\t\t\t\t\t\tCase검증을 이용해 확인해 주세요.<br>\t\t\t\t\t\t\t(검색결과 "+_SL.formatNumber(a.total)+"건)<br>\t\t\t\t\t\t\t(최대건수 "+_SL.formatNumber(f)+"건)"):void A()}})},A=function(){var a=b.viewFieldSel.getSelectionOrder(),d=b.groupFieldSel.getSelectionOrder(),e=b.distinctFieldSel.getSelectionOrder();$("option","[name=chk_user_list]").each(function(){this.selected=!0});var f=$.extend({},_SL.serializeMap(b.form),{view_field:a.join(),group_field:d.join(),distinct_field:e.join()});$("option","[name=chk_user_list]").each(function(){this.selected=!1});var g=1==b.form.find(".btn-save").data("after-close");$("body").requestData(c.mode.action,f,{callback:function(a,b,c){_alert(c,{onAgree:function(){C(g)}})}})},B=function(){var c=1==$(this).data("after-close");_confirm("삭제하시겠습니까?",{onAgree:function(){var d=b.rulesetId.val();$("body").requestData(a.urlDelete,{ruleset_id:d},{callback:function(a,b,d){_alert(d,{onAgree:function(){C(c)}})}})}})},C=function(a){a&&b.form.find("[data-layer-close=true]").click()};return{init:d}}(),$(function(){slapp.searchRuleset.form.init()});