"use strict";_SL.nmspc("parser").logForm=function(){var a={formId:"#formLogParser",parserTreeId:"#parserTree",urlSelect:gCONTEXT_PATH+"management/log_psr_form.json",urlComCodeForm:gCONTEXT_PATH+"sysdata/comcode_form.html",urlXmlCheck:gCONTEXT_PATH+"management/arr_log_psr_xml_check.json",urlLogPsrNameCheck:gCONTEXT_PATH+"management/arr_log_parser_name_exist.json",urlParserGenerator:gCONTEXT_PATH+"management/parser_generator.do?menu_idx=1",urlChkDelete:gCONTEXT_PATH+"management/log_psr_check_delete.json",urlDelete:gCONTEXT_PATH+"management/log_psr_delete.do",urlNewForm:gCONTEXT_PATH+"management/log_parser_manager_form.html",urlLoadForm:gCONTEXT_PATH+"management/log_parser_list.html",urlUpdOrder:gCONTEXT_PATH+"management/log_parser_ord_no_update.do",save:{action:gCONTEXT_PATH+"management/log_psr_save.do",message:"저장 하시겠습니까?"}},b={form:$(a.formId),parserTree:$(a.parserTreeId),dynTree:$(a.parserTreeId+" .dynTree"),trHandleOpt1:$(a.formId+" #handle_opt_1_wrap"),trHandleOpt2:$(a.formId+" #handle_opt_2_wrap"),trLogCateValue:$(a.formId+" #log_cate_value_wrap"),comment1:$(a.formId+" #comment1"),psrId:$(a.formId+" [name=psr_id]"),logPsrId:$(a.formId+" [name=log_psr_id]"),logPsrNm:$(a.formId+" #log_psr_nm"),logCateCd:$(a.formId+" [name=log_cate_cd]"),logTypeCd:$(a.formId+" [name=log_type_cd]"),handleType:$(a.formId+" [name=handle_type]"),handleOptChar:$(a.formId+" [name=handle_opt_1_char]"),handleOptIndex:$(a.formId+" [name=handle_opt_1_index]"),handleOpt:$(a.formId+" [name=handle_opt]"),logCateValue:$(a.formId+" [name=log_cate_value]"),defaultOpt:$(a.formId+" [name=default_opt]"),sample:$(a.formId+" #sample"),psrXml:$(a.formId+" #psr_xml"),description:$(a.formId+" #description"),categoryCode:$(a.formId+" .btn-register-category").data("value")},c={exNode:null},d=function(){e(),l.init(),l.load(),b.parserTree.draggable({handle:".area-head"})},e=function(){b.form.find(".btn-save").on("click",h),b.form.find(".btn-delete").on("click",i),b.form.find(".btn-register-category").exModalPopup(a.urlComCodeForm+"?code_type="+b.categoryCode,{width:550,height:455,onClose:function(){j(b.logCateCd)}}),b.handleType.change(k.changeHandleType),b.form.find(".btn-new").exModalPopup(a.urlNewForm,{width:800,height:500,onClose:function(){}}),b.form.find(".btn-register").exModalPopup(a.urlLoadForm,{width:1100,height:620,setScroll:!0,onClose:function(){}}),b.defaultOpt.change(function(){b.defaultOpt.is(":checked")?b.logCateValue.prop("disabled",!0).val("[[@default]]"):b.logCateValue.prop("disabled",!1).val("")})},f=function(a){k.connectLogParser(a)},g=function(a){k.addLogParser(a)},h=function(){l.save()},i=function(){l.remove()},j=function(b){var c=slapp.comcode.form.getCode();b.append('<option value="'+c.code_id+'">'+c.code_name+"</option>"),b.val(c.code_id),slui.attach.setTransformSelect(a.formId)},k={connCtxNode:null,winCtx:null,loadTree:function(a){var c=b.dynTree.dynatree("getTree"),d=c.getNodeByKey("log_type_cd_"+a.log_type_cd);a.dtoType="load",d.addChild({title:a.log_psr_nm,key:a.log_type_cd+"_log_psr_id_"+a.log_psr_id,dto:a}),d.data.dto||(d.data.dto={handle_type:a.handle_type,handle_opt:a.handle_opt,psr_id:a.psr_id,log_type_cd:a.log_type_cd})},showForm:function(a,c){var d,e=a.data.dto||{};3===a.getLevel()?(b.form.find(".btn-register-category").show(),b.form.find(".btn-save").show(),b.form.find(".btn-delete").show()):(e.handle_type=-1,b.form.find(".btn-register-category").hide(),b.form.find(".btn-save").hide(),b.form.find(".btn-delete").hide()),b.logTypeCd.val(e.log_type_cd||a.data.key.replace(/log_type_cd_/g,"")),b.handleType.val(e.handle_type||"-1"),b.handleOpt.val(e.handle_opt||""),b.defaultOpt.prop("checked",!1),b.logCateValue.prop("disabled",!1);var f=b.handleType.val();switch(b.form.find("#ranges-default_opt").css("display","none"),b.form.find("#ranges-comment1").css("display","none"),b.trHandleOpt2.jqxTooltip("destroy"),b.logCateValue.jqxTooltip("destroy"),f){case"2":b.trHandleOpt2.jqxTooltip({content:tooltip1,position:"mouse"});break;case"3":b.logCateValue.jqxTooltip({content:tooltip2,position:"mouse"}),b.form.find("#ranges-default_opt").css("display","block"),b.form.find("#ranges-comment1").css("display","block"),"[[@default]]"==e.log_cate_value?(b.logCateValue.prop("disabled",!0),b.defaultOpt.prop("checked",!0)):b.defaultOpt.prop("checked",!1)}if("1"==f||"2"==f)if($("#handle_opt_"+f+"_wrap").show(),"1"==f){if(d=b.handleOpt.val(),""!=d){var g=d.split("|"),h="";2==g.length&&(h=parseInt(g[1])+1),b.handleOptChar.val(g[0].replace(new RegExp(SEPARATOR_PIPE_STR,"g"),"|")),b.handleOptIndex.val(isNaN(h)?"":h)}b.trHandleOpt2.hide()}else b.trHandleOpt1.hide();else b.trHandleOpt1.hide(),b.trHandleOpt2.hide();"-1"!=f?b.trLogCateValue.show():b.trLogCateValue.hide(),b.logPsrId.val(e.log_psr_id||""),b.logPsrNm.text(e.log_psr_nm||""),b.logCateCd.val(e.log_cate_cd||0),b.logCateValue.val(e.log_cate_value||""),b.sample.text(e.sample||""),b.psrXml.text(e.psr_xml||""),b.description.text(e.description||""),b.form.find("[name=p_log_psr_nm]").val(e.log_psr_nm||""),b.form.find("[name=p_log_cate_cd]").val(e.log_cate_cd||""),b.form.find("[name=p_log_cate_value]").val(e.log_cate_value||""),b.form.find("[name=p_handle_type]").val(e.handle_type||""),b.form.find("[name=p_handle_opt]").val(e.handle_opt||"")},getDataFormPage:function(a){return a&&!_SL.validate(":visible")?null:{psr_id:b.psrId.val(),log_psr_id:b.logPsrId.val(),log_type_cd:b.logTypeCd.val(),log_cate_cd:b.logCateCd.val(),p_log_cate_cd:b.form.find("[name=p_log_cate_cd]").val(),handle_type:b.handleType.val(),handle_opt:1==b.handleType.val()?b.handleOptChar.val().replace(/\|/g,SEPARATOR_PIPE_STR)+"|"+(parseInt(b.handleOptIndex.val())-1):b.handleOpt.val(),log_psr_nm:b.logPsrNm.text(),psr_xml:b.psrXml.text(),sample:b.sample.text(),log_cate_value:b.logCateValue.val(),description:b.description.text(),p_log_cate_value:b.form.find("[name=p_log_cate_value]").val(),p_handle_type:b.form.find("[name=p_handle_type]").val(),p_handle_opt:b.form.find("[name=p_handle_opt]").val(),is_changed:b.form.find("[name=p_log_cate_cd]").val()!=b.logCateCd.val()||b.form.find("[name=p_handle_type]").val()!=b.handleType.val()||b.form.find("[name=p_handle_opt]").val()!=(1==b.handleType.val()?b.handleOptChar.val().replace(/\|/g,SEPARATOR_PIPE_STR)+"|"+(parseInt(b.handleOptIndex.val())-1):b.handleOpt.val())||b.form.find("[name=p_log_cate_value]").val()!=b.logCateValue.val()}},addNode:function(a,b,c){a.deactivate(),a.addChild({title:b.log_psr_nm,key:b.log_type_cd+"_conn_log_psr_id_"+b.log_psr_id,dto:b}),a.data.dto={handle_type:b.handle_type,handle_opt:b.handle_opt,psr_id:b.psr_id,log_type_cd:b.log_type_cd},c||k.activate(b.log_type_cd+"_conn_log_psr_id_"+b.log_psr_id)},updateNode:function(a,b){a.setTitle(b.psr_nm),a.data.dto=b,a.getParent().data.dto={handle_type:b.handle_type,handle_opt:b.handle_opt,psr_id:b.psr_id,log_type_cd:b.log_type_cd}},deleteNode:function(a){var b=a.getParent();a.remove(),c.exNode=null,b.hasChildren()||(b.data.dto=null,delete b.data.dto),k.activate(b.data.key)},activate:function(a){b.dynTree.dynatree("getTree").activateKey(a)},changeHandleType:function(){b.trHandleOpt1.hide(),b.trHandleOpt2.hide(),b.form.find("#ranges-default_opt").css("display","none"),b.form.find("#ranges-comment1").css("display","none"),b.trHandleOpt2.jqxTooltip("destroy"),b.logCateValue.jqxTooltip("destroy");var a=b.handleType.val();switch(a){case"-1":b.handleOptChar.val(""),b.handleOptIndex.val(""),b.handleOpt.val(""),b.logCateValue.prop("disabled",!1).val(""),b.trLogCateValue.hide();break;case"1":if(1==b.form.find("[name=p_handle_type]").val()){var c=b.form.find("[name=p_handle_opt]").val().split("|"),d="";2==c.length&&(d=parseInt(c[1])+1),b.handleOptChar.val(c[0].replace(new RegExp(SEPARATOR_PIPE_STR,"g"),"|")),b.handleOptIndex.val(isNaN(d)?"":d),b.handleOpt.val(b.form.find("[name=p_handle_opt]").val()),b.logCateValue.prop("disabled",!1).val(b.form.find("[name=p_log_cate_value]").val())}else b.handleOptChar.val(""),b.handleOptIndex.val(""),b.handleOpt.val(""),b.logCateValue.prop("disabled",!1).val("");b.trLogCateValue.show(),b.form.find("#handle_opt_"+a+"_wrap").show();break;case"2":2==b.form.find("[name=p_handle_type]").val()?(b.handleOpt.val(b.form.find("[name=p_handle_opt]").val()),b.logCateValue.prop("disabled",!1).val(b.form.find("[name=p_log_cate_value]").val())):(b.handleOptChar.val(""),b.handleOptIndex.val(""),b.handleOpt.val(""),b.logCateValue.prop("disabled",!1).val("")),b.trLogCateValue.show(),b.form.find("#handle_opt_"+a+"_wrap").show(),b.trHandleOpt2.jqxTooltip({content:tooltip1,position:"mouse"});break;case"3":3==b.form.find("[name=p_handle_type]").val()?(b.logCateValue.val(b.form.find("[name=p_log_cate_value]").val()),"[[@default]]"==b.form.find("[name=p_log_cate_value]").val()?(b.logCateValue.prop("disabled",!0),b.defaultOpt.prop("checked",!0)):(b.logCateValue.prop("disabled",!1),b.defaultOpt.prop("checked",!1))):(b.handleOptChar.val(""),b.handleOptIndex.val(""),b.handleOpt.val(""),b.logCateValue.prop("disabled",!1).val(""),b.defaultOpt.prop("checked",!1)),b.trLogCateValue.show(),b.logCateValue.jqxTooltip({content:tooltip2,position:"mouse"}),b.form.find("#ranges-default_opt").css("display","block"),b.form.find("#ranges-comment1").css("display","block")}},contextMenuCallback:function(a,c){var d,e,h,i=$.ui.dynatree.getNode(c.$trigger);k.getDataFormPage(!1);switch(a){case"new":k.connCtxNode=i,k.winCtx=b.form.find(".btn-new").trigger("click"),k.winCtx.fnCallback=g;break;case"conn":var j=b.dynTree.dynatree("getActiveNode");if(3===j.getLevel()&&!k.getDataFormPage(!0))return;if(i.hasChildren()){d=i.getChildren(),e=new Array;for(h in d)e[e.length]=d[h].data.dto.log_psr_id}k.connCtxNode=i,k.winCtx=b.form.find(".btn-register").trigger("click"),k.winCtx.fnCallback=f;break;default:_alert("잘못된 메뉴 입니다.")}},connectLogParser:function(a){var c,d,e,f=k.connCtxNode,g=f.data.key.replace(/log_type_cd_/g,""),h=new Array,i=new Array,j=new Array,l=!1;if(!f)return void _alert("불러올 로그타입이 선택되지 않았습니다.");if(a&&a.length>0){if(c=f.getChildren())for(e in c)h[c[e].data.dto.log_psr_id]=c[e].data.dto.log_psr_nm;for(e in a)d=a[e],h[d.log_psr_id]?l=!0:(i[i.length]=d.log_psr_id,j[j.length]=$.extend(!0,{},d));if(0==i.length)return void _alert((l?"동일한 로그파서외 ":"")+"불러올 수 있는 로그파서가 없습니다.");for(var m=0;m<j.length;m++)j[m].psr_id=b.psrId.val(),j[m].log_type_cd=g,j[m].dtoType="new",k.addNode(f,j[m],m!=j.length-1);_alert((l?"동일한 로그파서외 ":"")+j.length+"건 처리 되었습니다."),k.winCtx?k.winCtx=null:_alert("처리중 에러가 발생했습니다.<br> 다시 실행하세요."+textStatus)}},addLogParser:function(a){var b=k.connCtxNode,c=b.addChild({title:a.log_psr_nm,key:b.data.key.replace(/log_type_cd_/g,"")+"_new_log_psr_id_"+a.log_psr_id,dto:a,focus:!0});c.data.dto.log_type_cd=b.data.key.replace(/log_type_cd_/g,""),c.data.dto.dtoType="new",c.activate(),k.winCtx?k.winCtx=null:_alert("처리중 에러가 발생했습니다.<br> 다시 실행하세요.")}},l={init:function(){b.dynTree.dynatree({minExpandLevel:2,onActivate:function(b){var d=(b.data.dto?b.data.dto.dtoType:null,k.getDataFormPage(!1)),e=c.exNode;if(null!=e&&e.getLevel()&&3===e.getLevel())if(k.getDataFormPage(!0)){var f=k.getDataFormPage(!0);"load"==e.data.dto.dtoType&&f.is_changed&&(f.dtoType="change"),$.extend(!0,c.exNode.data.dto,f),k.showForm(b,!1),c.exNode=b}else $.extend(!0,e.data.dto,d),c.exNode.focus(),c.exNode.activate();else k.showForm(b,!0),c.exNode=b;slui.attach.setTransformSelect(a.formId)},persist:!1,dnd:{onDragStart:function(a){return!(a.getLevel()<3||"[[@default]]"==a.data.dto.log_cate_value)},preventVoidMoves:!0,onDragEnter:function(a,b){return!(a.parent!==b.parent||a.data.dto&&"[[@default]]"==a.data.dto.log_cate_value)&&["before","after"]},onDragOver:function(a,b,c){return!a.isDescendantOf(b)&&(a.data.isFolder||"over"!==c?void 0:"after")},onDrop:function(a,b,c,d,e){_confirm("순서를 변경하시겠습니까?",{onAgree:function(){b.move(a,c);var d=a.parent.getChildren();l.resetTreeOrdNo(d)}})}},children:[{title:_SL.htmlEscape(psrInfoData.psr_nm),icon:!1,children:[{title:"Security",key:"log_type_cd_1",isFolder:!0},{title:"Traffic",key:"log_type_cd_2",isFolder:!0},{title:"System",key:"log_type_cd_3",isFolder:!0},{title:"SMS",key:"log_type_cd_4",isFolder:!0}]}]}),$.contextMenu({selector:".dynatree-node",events:{show:function(a){return a.$trigger.hasClass("dynatree-folder")}},callback:k.contextMenuCallback,items:{"new":{name:"신규"},conn:{name:"등록"}}})},resetTreeOrdNo:function(b){var c;if(null!=b)for(var d=0;d<b.length;d++)c=d+1,c!=b[d].data.dto.ord_no&&("[[@default]]"==b[d].data.dto.log_cate_value?b[d].data.dto.ord_no=999:b[d].data.dto.ord_no=c,$("body").requestData(a.urlUpdOrder,{log_psr_id:b[d].data.dto.log_psr_id,psr_id:b[d].data.dto.psr_id,ord_no:b[d].data.dto.ord_no},{callback:function(a,b,c){}}))},load:function(){var c="log_type_cd_1";$("body").requestData(a.urlSelect,{psr_id:b.psrId.val()},{callback:function(a,b,d){for(var e=0;null!=a&&e<a.length;e++)k.loadTree(a[e]),0==e&&(c=a[0].log_type_cd+"_log_psr_id_"+a[0].log_psr_id);k.activate(c)}})},save:function(){var c=b.dynTree.dynatree("getActiveNode"),d=k.getDataFormPage(!1);if(k.getDataFormPage(!0)){"load"==c.data.dto.dtoType&&d.is_changed&&(d.dtoType="change"),$.extend(!0,c.data.dto,d);var e,f,g=!1,h=l.logPsrToArray();return $.each(h,function(a,b){return!g&&void $.each(h,function(c,d){if(a!=c&&b.log_type_cd==d.log_type_cd){if(b.handle_type==-1)return e="로그파서["+b.log_psr_nm+"]의 구분 방법이 None이므로<br>하나의 로그파서만 사용할 수 있습니다.",f=b.key,g=!0,!1;if(b.handle_type!=d.handle_type)return e="같은 로그타입 내 로그파서<br>구분방법이 서로 다릅니다.",f=d.key,g=!0,!1;if(b.handle_opt!=d.handle_opt){if(3!=b.handle_type)return e="같은 로그타입 내 로그파서<br>구분Option이 서로 다릅니다.",f=d.key,g=!0,!1}else if(b.log_cate_value==d.log_cate_value)return e="같은 로그타입 내 로그파서<br>구분값이 서로 중복됩니다.",f=d.key,g=!0,!1}})}),g?(_alert(e),k.activate(f),!1):void _confirm("저장 하시겠습니까?",{onAgree:function(){$("body").requestData(a.save.action,{logPsrList:JSON.stringify(h)},{callback:function(a,c,d){_alert(d,{onAgree:function(){var a=b.dynTree.dynatree("getTree");a.reload(),l.load()}})}})}})}},logPsrToArray:function(){var a=[],c=b.dynTree.dynatree("getTree");return c.visit(function(b){3==b.getLevel()&&b.data.dto&&(b.data.dto.key=b.data.key,a.push(b.data.dto))}),a},remove:function(){var c,d=b.dynTree.dynatree("getActiveNode"),e=k.getDataFormPage(!1),f=f=parseInt(e.log_psr_id,10),g=function(){k.deleteNode(d,e);var a=d.parent.getChildren();l.resetTreeOrdNo(a),_alert("삭제 되었습니다.")};if("load"==d.data.dto.dtoType){var h=function(){_confirm(c?c:"삭제하시겠습니까?",{onAgree:function(){$("body").requestData(a.urlDelete,e,{callback:function(a,b,c){g()}})}})};$("body").requestData(a.urlChkDelete,e,{callback:function(a,b,d){return void 0==a.CONN_CNT?void _alert("연동 여부 체크에 실패했습니다.<br> 다시 시도하세요."):(a.CONN_CNT>1&&(c="연동중인 파서입니다.<br>삭제 하시겠습니까?"),void h())}})}else _confirm("삭제하시겠습니까?",{onAgree:function(){g()}})}};return{init:d,selectLogParser:f,addLogParser:g}}(),$(function(){slapp.parser.logForm.init()});