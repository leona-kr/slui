"use strict";_SL.nmspc("pms").list=function(){var a=[],b=[],c={gridId:"#gridPmsList",formId:"#searchPmsList",urlList:gCONTEXT_PATH+"management/pms_list.json",urlForm:gCONTEXT_PATH+"management/pms_form.html",urlInfo:gCONTEXT_PATH+"management/pms_stat_list.html",urlStat:gCONTEXT_PATH+"management/pms_status.json",urlDown:gCONTEXT_PATH+"management/download_file.do",urlCancel:gCONTEXT_PATH+"management/pms_cancel.do",urlRestore:gCONTEXT_PATH+"management/pms_restore.do"},d={grid:$(c.gridId),form:$(c.formId)},e=function(){var a=$(c.gridId).parent().siblings(".grid-bottom").find(".btn-add");f(d.grid),$(c.formId+" .form-submit").on("click",function(){g()}),a.on("click",function(){new ModalPopup(c.urlForm,{width:900,height:560,onClose:function(){g()}})}),setInterval(h,5e3)},f=function(e){var f={datatype:"json",datafields:[{name:"reg_date",type:"string"},{name:"subject",type:"string"},{name:"status",type:"string"},{name:"succ_cnt",type:"string"},{name:"err_cnt",type:"string"},{name:"tot_cnt",type:"string"},{name:"cnt_info",type:"string"},{name:"wait_cnt",type:"string"},{name:"backup_cnt",type:"string"},{name:"func",type:"string"},{name:"func_name",type:"string"},{name:"file_name",type:"string"},{name:"app_seq",type:"string"},{name:"pct",type:"string"}],root:"rows",beforeprocessing:function(a){null!=a&&(f.totalrecords=a.totalRows)},cache:!1,url:c.urlList},h=new $.jqx.dataAdapter(f,{beforeLoadComplete:function(c){a=[],b=[];for(var d in c)c[d].reg_date=_SL.formatDate(c[d].reg_date,"yyyyMMddHHmm","yyyy-MM-dd HH:mm"),c[d].cnt_info="<span>"+c[d].tot_cnt+'</span> / <span class="text-info">'+c[d].succ_cnt+'</span> / <span class="text-danger">'+c[d].err_cnt+"</span>",c[d].wait_cnt>0?(c[d].func="cancel",c[d].func_name='<button type="button" class="btn-link">취소</button>'):c[d].backup_cnt>0?(c[d].func="restore",c[d].func_name='<button type="button" class="btn-link">복원</button>'):(c[d].func="",c[d].func_name="-"),a.push(c[d].app_seq),b.push(c[d].pct);return c},formatData:function(a){var b,c={},e=d.form.serializeArray();for(b in e)c[e[b].name]=e[b].value;return $.extend(a,c),a},loadError:function(a,b,c){alert(c)}});e.jqxGrid({source:h,sortable:!0,width:"100%",virtualmode:!0,enablehover:!1,rendergridrows:function(a){return a.data},columns:[{text:"No",columntype:"number",width:40,cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).text(c+1)[0].outerHTML}},{text:"패치일",datafield:"reg_date",cellsalign:"center",width:"12%"},{text:"제목",datafield:"subject",width:"30%",cellsrenderer:function(a,b,c,d,e,f){return $(d).html('<button type="button" class="btn-link">'+c+"</button>")[0].outerHTML}},{text:"진행률",datafield:"status",cellalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g=f.app_seq,h=f.pct,i='<div id="'+g+'" data-proc_date="'+h+'" style="position:relative;width:100px;height:16px;margin:5px auto;border:1px solid #000;background:#fff;"><div class="prcsPctB" style="position:absolute;left:0;top:0;bottom:0;width: '+h+'%;background-color:#89cf43;"></div><div class="prcsPctT" style="position:absolute;width:100%;height:100%;text-align:center;color:#000;" >'+h+"%</div></div>";return i}},{text:"(전체/완료/오류)",datafield:"cnt_info",cellalign:"center",width:"20%",cellsrenderer:function(a,b,c){return'<div style="margin-top:7px;text-align:center;">( '+c+" )</div>"}},{text:"동작",datafield:"func_name",cellalign:"center",cellsrenderer:function(a,b,c,d,e,f){return $(d).html('<div class="text-func" style="text-align:center;">'+c+"</div>")[0].outerHTML}},{text:"패치파일",datafield:"file_name",cellalign:"center",cellsrenderer:function(a,b,c,d,e,f){if(c.length>0)return $(d).html('<div style="text-align:center;"><button type="button" class="btn-link"><i class="icon-drive"></i> download</button></div>')[0].outerHTML}}]}),e.on("cellclick",function(a){var b=a.args.row.bounddata.app_seq;"subject"===a.args.datafield&&$(this).addModalPage(c.urlInfo+"?s_app_seq="+b),"file_name"===a.args.datafield&&""!=a.args.row.bounddata.file_name&&(d.form.find("[name=s_app_seq]").val(b),d.form.attr({action:c.urlDown}).submit()),"func_name"===a.args.datafield&&("restore"==a.args.row.bounddata.func?$("body").requestData(c.urlRestore,{s_app_seq:b},{callback:function(a){g()}}):"cancel"==a.args.row.bounddata.func&&$("body").requestData(c.urlCancel,{s_app_seq:b},{callback:function(a){g()}}))})},g=function(){d.grid.jqxGrid("updatebounddata"),d.grid.jqxGrid("clearselection")},h=function(){if(!(a.length<1))for(var e=0;e<a.length;e++)if(b[e]<100){var f={app_seq_arr:a},g=function(a){for(var c in a){var e=a[c],f=e.app_seq,g=e.pct,h=e.error_cnt,i=e.succ_cnt,j=e.wait_cnt,k=e.backup_cnt;b.push(g);var l=d.grid.find("#"+f);l.data("proc_date");g+"%"!=l.find(".prcsPctT").text()&&($(".prcsPctB").eq(c).width(g+"%"),$(".prcsPctT").eq(c).text(g+"%"),$(".text-info").eq(c).text(i),$(".text-danger").eq(c).text(h),0==j&&($(".text-func").eq(c).text("-"),100==g&&k>0&&$(".text-func").eq(c).html('<button type="button" class="btn-link">복원</button>')))}};$("body").requestData(c.urlStat,f,{callback:g}),b=[];break}};return{init:e}}(),$(function(){slapp.pms.list.init()});