"use strict";_SL.nmspc("epsSecurityEvent").list=function(){var a={urlList:gCONTEXT_PATH+"event2/eps_security_event_list.json",formId:"#searchEpsSecurityEventList",gridId:"#gridEpsSecurityEventList",tableList:"#epsSecurityEventListTable tbody",urlHandlingUdate:gCONTEXT_PATH+"event2/eps_security_event_update.json",urlChkForm:gCONTEXT_PATH+"event2/eps_security_event_list_form.html",urlAllChkForm:gCONTEXT_PATH+"event2/eps_security_event_list_allcheck_form.html",urlLogSearch:gCONTEXT_PATH+"monitoring/log_search.html",urlUpdate:gCONTEXT_PATH+"event2/eps_security_event_update.json"},b={form:$(a.formId),grid:$(a.gridId),sDay:$(a.formId+" [name=startDay]"),sHour:$(a.formId+" [name=startHour]"),sMin:$(a.formId+" [name=startMin]"),eDay:$(a.formId+" [name=endDay]"),eHour:$(a.formId+" [name=endHour]"),eMin:$(a.formId+" [name=endMin]"),tableList:$(a.tableList+" tbody")},c=[],d=[],e=[],f=function(){$("#s_event_cate_cd").val($("#event_cate_cd").val()),j(b.grid),k()},g=function(){return c},h=function(){return d},i=function(){return e},j=function(c){var d={datatype:"json",datafields:[{name:"cnt",type:"string"},{name:"event_time",type:"string"},{name:"event_nm",type:"string"},{name:"event_cate_name",type:"string"},{name:"tc_type_name",type:"string"},{name:"src_ip",type:"string"},{name:"times",type:"string"},{name:"limit_count",type:"string"},{name:"time_type_name",type:"string"},{name:"handling_type_cd_name",type:"string"},{name:"sdt",type:"string"},{name:"ddt",type:"string"},{name:"ruleset_id",type:"string"},{name:"search_query",type:"string"}],root:"rows",beforeprocessing:function(a){null!=a&&(d.totalrecords=a.totalRows)},cache:!1,url:a.urlList},e=new $.jqx.dataAdapter(d,{beforeLoadComplete:function(a){for(var b in a)a[b].event_time=_SL.formatDate(a[b].event_time,"yyyyMMddHHmm","yyyy-MM-dd HH:mm");return a},formatData:function(b){var c,d={},e=$(a.formId).serializeArray();for(c in e)d[e[c].name]=e[c].value;return $.extend(b,d),b},loadError:function(a,b,c){_alert(c)}});c.jqxGrid({source:e,sortable:!0,width:"100%",virtualmode:!0,enablehover:!1,selectionmode:"checkbox",rendergridrows:function(a){return a.data},columns:[{text:"번호",columntype:"number",width:40,cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).text(c+1)[0].outerHTML}},{text:"발생시간",datafield:"event_time",cellsalign:"center",width:"12%"},{text:"이벤트명",datafield:"event_nm",cellsrenderer:function(a,b,c,d,e,f){return $(d).html('<button type="button" class="btn-link">'+c+"</button>")[0].outerHTML}},{text:"이벤트 분류",datafield:"event_cate_name",cellsalign:"center",width:"12%"},{text:"구분",datafield:"tc_type_name",cellsalign:"center",width:"8%"},{text:"HOST",datafield:"src_ip",cellsalign:"center",width:"10%"},{text:"체크 주기",datafield:"times",cellsalign:"center",width:"8%",cellsrenderer:function(a,b,c,d,e,f){return $(d).text(c+" "+f.time_type_name)[0].outerHTML}},{text:"발생건수/기준건수",datafield:"cnt",cellsalign:"center",width:"12%",cellsrenderer:function(a,b,c,d,e,f){return $(d).html(_SL.formatNumber(f.cnt)+" / "+_SL.formatNumber(f.limit_count))[0].outerHTML}},{text:"상태",datafield:"handling_type_cd_name",cellsalign:"center",width:"8%",cellsrenderer:function(a,b,c,d,e,f){return""==c||null==c?$(d).text("-")[0].outerHTML:$(d).text(c)[0].outerHTML}}]}),c.on("cellclick",function(a){if("event_nm"===a.args.datafield){var b=a.args.row.bounddata.sdt,c=a.args.row.bounddata.src_ip,d=a.args.row.bounddata.event_nm,e=a.args.row.bounddata.ddt,f=a.args.row.bounddata.search_query;q(b,e,c,d,f)}}),$("#gridEpsSecurityEventList").on("rowselect",function(a){var c=b.grid.jqxGrid("getdisplayrows"),d=b.grid.jqxGrid("selectedrowindexes"),e=[];for(var f in c)for(var g=0,h=d.length;g<h;g++)d[g]==c[f].boundindex&&e.push(c[f].boundindex);0==e.length&&$("#gridEpsSecurityEventList").jqxGrid("clearselection")})},k=function(){var c=b.grid.parent().siblings(".grid-bottom").find(".btn-event_process");b.grid.parent().siblings(".grid-bottom").find(".btn-about"),b.grid.parent().siblings(".grid-bottom").find(".btn_duplication"),b.grid.parent().siblings(".grid-bottom").find(".btn-exception");b.form.find(".form-submit").off().on("click",function(){if(_SL.validate(b.form)){var a=b.sDay.val()+b.sHour.val()+b.sMin.val(),c=b.eDay.val()+b.eHour.val()+b.eMin.val(),d=_SL.formatDate.diff(a,c);$("#s_eqp_ip").val();if(d<=0)return void _alert("시작일이 종료일보다 큽니다.");if(d/6e4>b.form.find("[name=timeSet] option:last-child").val())return void _alert("검색 기간 초과입니다.");b.form.find("[name=currPage]").val(1),r()}}),b.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var c=function(a,b){var c=a.siblings(".tform-select");c.find(".tform-select-t").text(b).end().find(".tform-select-option[data-value="+b+"]").addClass("selected").end(),a.val(b)},d=_SL.formatDate.addMin(b.form.find("[name=endDay]").val()+b.form.find("[name=endHour]").val()+b.form.find("[name=endMin]").val(),-a);c(b.form.find("[name=startDay]"),d.substring(0,8)),c(b.form.find("[name=startHour]"),d.substring(8,10)),c(b.form.find("[name=startMin]"),d.substring(10,12))}}),b.form.find("[name=startDay],[name=startHour],[name=startMin],[name=endDay],[name=endHour],[name=endMin]").change(function(){var a=b.form.find("[name=timeSet]"),c=a.siblings(".tform-select").find("[data-value=0]").text();a.val(0).siblings(".tform-select").find(".tform-select-t").text(c)}),$(".btn-about").click(function(){l(2,$(".btn-about").text())}),$(".btn_duplication").click(function(){l(4)}),$(".btn-exception").click(function(){l(5)});var c=b.grid.parent().siblings(".grid-bottom").find(".btn-event_process");c.on("click",n),$("#div_s_time_type").change(function(){"[ 선택하세요 ]"==$("select[name=s_time_type] option:selected").text()?$("#div_s_times").hide():$("#div_s_times").show(),slui.attach.setTransformSelect(a.formId)}),$("#div_s_times").hide()},l=function(a,c){var d=c,e=b.grid.jqxGrid("selectedrowindexes"),f=b.grid.jqxGrid("getdisplayrows"),g=[];for(var h in f)for(var i=0,j=e.length;i<j;i++)e[i]==f[h].boundindex&&g.push(f[h].boundindex);if(g.length<1)return void _alert(d+"할 이벤트를 체크해주세요.");if(g.length>1&&5==a)return void _alert(d+" 처리는 1개 이벤트만 가능합니다.");if(2==a)$("#all_checkbox").is(":checked")||_confirm("이벤트를 "+d+" 하시겠습니까?",{onAgree:function(){if(m(a))return p(a),!0},onDisagree:function(){return!1}});else if(5==a){var e=b.grid.jqxGrid("selectedrowindexes"),f=b.grid.jqxGrid("getdisplayrows");if(!m(a))return;var k=e[0],l=eventInfoList[k].ruleset_id;"src_ip:"+eventInfoList[k].src_ip;$.get("/event/event_exception.do",{ruleset_id:l,event_type_cd:3},function(a){if(0==a.cnt)return void _alert("룰셋이 삭제되었습니다.")})}},m=function(c,d){var e,f=($(this).data("handle-type"),$(this).text(),b.grid.jqxGrid("selectedrowindexes")),g=b.grid.jqxGrid("getdisplayrows"),h="",i=[];if(3!=c)for(var j in g)for(var k=0,l=f.length;k<l;k++)f[k]==g[j].boundindex&&(e=g[j].boundindex,i.push(g[e].handling_type_cd));else e=idx-1,i.push(g[e].handling_type_cd);if(1==i.length){for(var k=0;k<i.length;k++)if(h=eventStatusJson[i[k]],null!=g[e].handling_type_cd){if(i[k]==c)return void _alert("이미 "+h+" 되었습니다");if(null!=i[k]&&""!=i[k]&&i[k].indexOf(c)==-1)return void _confirm(h+"인 상태가 있습니다. 상태를 변경하시겠습니까?",{onAgree:function(){return o(d?a.urlAllChkForm:a.urlChkForm),!0},onDisagree:function(){return!1}})}}else{var e,m=[];for(var j in g)for(var k=0,l=f.length;k<l;k++)f[k]==g[j].boundindex&&(e=g[j].boundindex,null!=g[e].handling_type_cd&&m.push(g[e].handling_type_cd));for(var k=0;k<m.length;k++){if(h=eventStatusJson[m[k]],m[0]!=m[k])return void _confirm(h+"인 상태가 있습니다. 상태를 변경하시겠습니까?",{onAgree:function(){return o(d?a.urlAllChkForm:a.urlChkForm),!0},onDisagree:function(){return!1}});if(null!=m[k]&&""!=m[k]&&m[k].indexOf(c)==-1)return void _confirm(h+"인 상태가 있습니다. 상태를 변경하시겠습니까?",{onAgree:function(){return o(d?a.urlAllChkForm:a.urlChkForm),!0},onDisagree:function(){return!1}})}}return 1==c&&o(g.length<=f.length?a.urlAllChkForm:a.urlChkForm),!0},n=function(){var a=($(this).data("handle-type"),b.grid.jqxGrid("selectedrowindexes")),f=b.grid.jqxGrid("getdisplayrows"),g=[];c=[],d=[],e=[];for(var h in f)for(var i=0,j=a.length;i<j;i++)a[i]==f[h].boundindex&&(g.push(f[h].boundindex),c.push(f[a[i]].src_ip),d.push(_SL.formatDate(f[a[i]].event_time,"yyyy-MM-dd HH:mm","yyyyMMddHHmm")),e.push(f[a[i]].ruleset_id));if(g.length<1)return void _alert("처리할 건을 선택하세요");if(f.length<=a.length){if(!m(1,!0))return}else{if(!m(1,!1))return;for(var i in a)f[i]}},o=function(a){new ModalPopup(a,{width:500,height:170,onClose:function(){r()}})},p=function(c){for(var d,e=b.grid.jqxGrid("selectedrowindexes"),f=b.grid.jqxGrid("getdisplayrows"),g=e.length,h={},i=(eventInfoList,0),g=e.length;i<g;i++){var j=e[i];d=f[j].boundindex;var k=_SL.formatDate(f[d].event_time,"yyyy-MM-dd HH:mm","yyyyMMddHHmm"),l=f[d].src_ip,m=f[d].ruleset_id;h={handling_type_cd:c,event_time:k,src_ip:l,ruleset_id:m};$.extend({},_SL.serializeMap(b.form));$("body").requestData(a.urlUpdate,h,{callback:function(a,b,c){"SUC_COM_0005"==b?r():_alert("처리중 에러가 발생했습니다.\n다시 시도해 보세요.")}})}},q=function(c,d,e,f,g){var h=c;h=_SL.formatDate(h,"yyyyMMddHHmmss","yyyyMMddHHmm");var i=d;i=_SL.formatDate(i,"yyyyMMddHHmmss","yyyyMMddHHmm"),i=_SL.formatDate.addMin(d,1);var j="src_ip:",k=" AND ",l=b.form.find("[name='logSearchForm']");0==l.length&&(l=$('<form name="logSearchForm">'),l.append('<input type="hidden" name="start_time">'),l.append('<input type="hidden" name="end_time">'),l.append('<input type="hidden" name="filter_type"'),l.append('<input type="hidden" name="expert_keyword">'),l.append('<input type="hidden" name="template_id" value="popup">'),l.append('<input type="hidden" name="search_query">'),b.form.append(l)),$("[name=start_time]",l).val(h),$("[name=end_time]",l).val(i),$("[name=filter_type]",l).val("2"),$("[name=expert_keyword]",l).val(j+e+k+g),$("[name=search_query]",l).val(g);var m="logSearchWin_"+(new Date).getTime();l.attr({target:m,action:a.urlLogSearch}).submit()},r=function(){j(b.grid)};return{init:f,getAllPageIpParam:g,getAllPageEventTimeParam:h,getAllPageRulesetIdParam:i}}(),$(function(){slapp.epsSecurityEvent.list.init(),$("#btnSettingEpsRulesetList").togglePage(gCONTEXT_PATH+"event2/eps_ruleset_list.html"),$("#btnSettingRiskRuleView").off().on("click",function(){new ModalPopup(gCONTEXT_PATH+"event2/eps_event_risk_rule_view.html",{width:820,height:250})})});