"use strict";_SL.nmspc("relRuleset").form=function(){var a,b=null,c=null,d=null,e={formId:"#formRelRuleset",urlSelect:gCONTEXT_PATH+"event2/rel_ruleset.json",urlDelete:gCONTEXT_PATH+"event2/rel_ruleset_delete.do",urlComCodeForm:gCONTEXT_PATH+"sysdata/comcode_form.html",urlComConfigForm:gCONTEXT_PATH+"sysdata/com_group_field_form.html",add:{action:gCONTEXT_PATH+"event2/rel_ruleset_add.do",message:"등록 하시겠습니까?"},update:{action:gCONTEXT_PATH+"event2/rel_ruleset_update.do",message:"수정 하시겠습니까?"}},f={form:$(e.formId),rulesetId:$(e.formId+" [name=ruleset_id]"),times:$(e.formId+" [name=times]"),timeType:$(e.formId+" [name=time_type]"),viewFldSel:$(e.formId+" [name=view_field_sel]"),operand:$(e.formId+" [name=operand]"),rulesetType:$(e.formId+" [name=ruleset_type]"),searchQuery:$(e.formId+" [name=search_query]"),fltGrpFld:$(e.formId+" [name=filter_field]"),rstGrpFld:$(e.formId+" [name=result_field]"),limitCount:$(e.formId+" [name=limit_count]"),relTimes:$(e.formId+" [name=rel_times]"),rulesetTreeTd:$(e.formId+" .relRulesetTreeTd"),characterLimit:$(e.formId+" [name=character_limit]"),viewFld:$(e.formId+" [name=view_field]"),eventCateCodeType:$(e.formId+" .btn-register-event-cate")},g={isNew:""==f.rulesetId.val(),mode:""==f.rulesetId.val()?e.add:e.update},h=function(){i(),g.isNew?(r.init(),r.btnInit(),k()):m(),j(),l(),g.isNew&&f.form.find(".btn-delete").hide(),setTimeout(function(){slui.attach.setTransformSelect(e.formId)},100)},i=function(){f.fltGrpFld.chosen({width:"100%",search_contains:!0,placeholder_text_multiple:"[선택하세요]",max_selected_options:10}),f.rstGrpFld.chosen({width:"100%",search_contains:!0,placeholder_text_multiple:"[선택하세요]",max_selected_options:10}),$(".treeForm .chosen-results").css("max-height","100px"),$(".treeForm .chosen-choices").css("max-height","55px").css("min-height","55px").css("overflow-y","auto").css("cursor","default").css("background-image","none")},j=function(){f.rulesetType.change(function(){if(1==f.rulesetType.val()){f.searchQuery.prop("disabled",!1),f.fltGrpFld.prop("disabled",!1),f.relTimes.prop("disabled",!1),f.searchQuery.val(""),f.fltGrpFld.setSelectionOrder([],!0),f.rstGrpFld.setSelectionOrder([],!0),f.relTimes.val("0");var a=$("<input type='text' name='limit_count' class='form-input' value='' style='width:70px;' maxlength='10' data-valid='조건,required,number'>"),b=$("<span> 건 이상</span>"),d=f.form.find("[name=limit_count]").parent("td:eq(0)");d.empty().append(a).append(b)}else{f.searchQuery.prop("disabled",!0),f.fltGrpFld.prop("disabled",!0),f.rstGrpFld.prop("disabled",!0),f.relTimes.prop("disabled",!0),f.searchQuery.val(""),f.fltGrpFld.setSelectionOrder(["eqp_ip"],!0),f.rstGrpFld.setSelectionOrder(["eqp_ip"],!0),f.relTimes.val("0");var g=$("<span />").addClass("form-select-outer").css({display:"inline-block",width:"70px","vertical-align":"middle"}),h=$("<select name='limit_count' class='form-select' style='width:70px;' data-valid='조건,required'></select>");$.each(gEventLevelsJson,function(a,b){h.append($("<option>").append(b).val(a))});var b=$("<span> 이상</span>"),d=f.form.find("[name=limit_count]").parents("td:eq(0)");g.append(h),d.empty().append(g).append(b)}var i=c.getActiveNode(),j=r.getData();i.setTitle(j.title),slui.attach.setTransformSelect(e.formId)}),f.fltGrpFld.on("change",function(a,b){var d=c.getActiveNode();if(null!=d&&0!=d.data.dto.seq_no){var e=f.fltGrpFld.val();if(b.deselected){var g=f.fltGrpFld.getSelectionOrder(),h=g.indexOf(b.deselected);g.splice(h,1),f.fltGrpFld.setSelectionOrder(g,!0)}e?f.rstGrpFld.prop("disabled",!1):(f.rstGrpFld.prop("disabled",!0),f.rstGrpFld.val("")),f.rstGrpFld.trigger("chosen:updated");var i=r.getData();d.setTitle(i.title)}}),f.operand.change(function(){var a=c.getActiveNode();null!=a&&0!=a.data.dto.seq_no&&a.hasChildren()&&"NOT"==f.operand.val()&&_alert("하위 룰셋이 있어 수정할 수 없습니다.",{onAgree:function(){f.operand.val(a.data.dto.operand)}})}),f.rstGrpFld.on("change",function(a,b){var d=c.getActiveNode();if(null!=d&&0!=d.data.dto.seq_no){if(b.deselected){var e=f.rstGrpFld.getSelectionOrder(),g=e.indexOf(b.deselected);e.splice(g,1),f.rstGrpFld.setSelectionOrder(e,!0)}d.hasChildren()&&""==f.rstGrpFld.val()&&_alert("하위 룰셋이 있어 수정할 수 없습니다.",{onAgree:function(){f.rstGrpFld.val(d.data.dto.rst_grp_fld)}});var h=r.getData();d.setTitle(h.title)}}),f.searchQuery.keyup(function(){var a=c.getActiveNode();if(null!=a&&0!=a.data.dto.seq_no){var b=r.getData();a.setTitle(b.title)}})},k=function(){f.viewFldSel.chosen({search_contains:!0,placeholder_text_multiple:"[선택하세요]"});var a=f.viewFld.val();if(""!=a){var b=a.split(",");for(var c in b){var d=b[c];gFieldCapsJson[d]||(gFieldCapsJson[d]="undefined",$("#view_field_sel").append("<option value='"+d+"'>undefined["+d+"]</option>"))}f.viewFldSel.setSelectionOrder(b,!0)}},l=function(){f.form.find(".btn-save").on("click",n),f.form.find(".btn-delete").on("click",o),q(),f.timeType.on("change",q),f.form.find(".btn-register-event-cate").exModalPopup(e.urlComCodeForm+"?code_type="+f.eventCateCodeType.data("value"),{width:550,height:455,onClose:function(){t(f.form.find("[name=event_cate_cd]")),slui.attach.setTransformSelect(e.formId)}}),f.form.find(".btn-group-fld-add").exModalPopup(e.urlComConfigForm,{width:470,height:295,draggable:!0,onClose:function(){u()}})},m=function(){var b=f.rulesetId.val(),c={ruleset_id:b},d=function(b){_SL.setDataToForm(b,f.form),a=b.rulesetDtlList,r.init(),r.btnInit(),k()};$("body").requestData(e.urlSelect,c,{callback:d})},n=function(){var a=f.characterLimit.val(),b=f.searchQuery.val(),e=Number(b.length);if(_SL.validate(f.form.find("[name=event_nm]"))){if(e>=a)return void _alert("검색어의 현재입력길이: "+e+"byte<br>입력가능길이는: "+a+"byte입니다.");if(!c.getNodeByKey("0").hasChildren())return void _alert("이벤트 룰셋을 등록해 주세요");if(null!=d&&0!=d.data.dto.seq_no){if(!r.nodeValidate())return;var h=c.getActiveNode();if(null!=h){var i=r.getData();$.extend(!0,h.data.dto,i),h.setTitle(i.title)}}var j=f.viewFldSel.getSelectionOrder(),k=$.map(j,function(a){return a}).join(),l=[];c.visit(function(a){var b=a.data.dto;0!=b.seq_no&&l.push(b)}),$("body").requestData(g.mode.action,$.extend({},_SL.serializeMap(f.form),{ruleset_dtl_json:l,view_field:k}),{callback:function(a,b,c){_alert(c,{onAgree:function(){p(!0,a.top_code)}})}})}},o=function(){var a=1==$(this).data("after-close");_confirm("삭제하시겠습니까?",{onAgree:function(){$("body").requestData(e.urlDelete,{ruleset_id:f.rulesetId.val()},{callback:function(b,c,d){_alert(d,{onAgree:function(){p(a)}})}})}})},p=function(a){a&&f.form.find("[data-layer-close=true]").click()},q=function(){var a={1:[1,2,3,5,10,15,30],2:[1,2,3,6,12],3:[1]},b=f.times,c=f.timeType,d=c.val(),e=b.empty();if(""!=d){for(var g in a[d])e.append('<option value="'+a[d][g]+'">'+a[d][g]+"</option>");$('[value="1"]',"[name=times]")[0].selected=!0}"1"==d||"2"==d?b.show():b.hide()},r={init:function(){var e=r.getInitData();e.seq_no=0,e.dtl_ord_no=0,b={title:"START",key:"0",dto:e,isFolder:!0,children:[]},f.rulesetTreeTd.dynatree({minExpandLevel:99,autoFocus:!0,clickFolderMode:3,onActivate:function(a){if(null!=d&&0!=d.data.dto.seq_no&&d!=a){if(!r.nodeValidate())return d.activate(),void d.focus();var b=r.getData();$.extend(!0,d.data.dto,b),d.setTitle(b.title)}d=a,r.rulesetTypechangeEvent(a.data.dto),f.rulesetType.val(a.data.dto.ruleset_type),f.operand.val(a.data.dto.operand),f.searchQuery.val(a.data.dto.search_query);var c=a.data.dto.flt_grp_fld.split(","),e=a.data.dto.rst_grp_fld.split(",");if(""!=a.data.dto.flt_grp_fld?s(f.fltGrpFld,c):(f.fltGrpFld.find("option").prop("selected",!1),f.fltGrpFld.trigger("chosen:updated")),""!=a.data.dto.rst_grp_fld?s(f.rstGrpFld,e):(f.rstGrpFld.find("option").prop("selected",!1),f.rstGrpFld.trigger("chosen:updated")),f.form.find("[name=limit_count]").val(a.data.dto.limit_count),f.relTimes.val(a.data.dto.rel_times),null!=a&&0!=a.data.dto.seq_no){var b=r.getData();a.setTitle(b.title)}0==a.data.dto.dtl_ord_no?f.form.find(".treeForm").hide():f.form.find(".treeForm").show()},children:[b]}),c=f.rulesetTreeTd.dynatree("getTree");var h=c.getNodeByKey("0");if(h.activate(),!g.isNew)for(var i in a){var j=a[i].p_seq_no,k="<";if(k+=gRulesetTypes[a[i].ruleset_type],1==a[i].ruleset_type?(""!=a[i].flt_grp_fld&&(k+=" - "+a[i].flt_grp_fld),""!=a[i].rst_grp_fld&&(k+=" / "+a[i].rst_grp_fld),k+=">",k+=a[i].search_query):k+=">",c.getNodeByKey(j.toString()).addChild({title:k,key:a[i].seq_no,dto:a[i],icon:!1,children:[]}),0==i){var h=c.getNodeByKey(a[i].seq_no.toString());h.activate()}}},btnInit:function(){f.form.find(".btn-plus").click(function(){var a=c.getActiveNode();if(null!=a){if(0!=a.data.dto.seq_no){if(!r.nodeValidate())return;var b=r.getData();if($.extend(!0,d.data.dto,b),d.setTitle(b.title),"NOT"==b.operand)return void _alert("NOT연산에는 하위 룰셋을 설정 할 수 없습니다.");if(""==b.rst_grp_fld)return void _alert("결과필드가 없으면 하위 룰셋을 설정 할 수가 없습니다.")}var f,g,h=r.getInitData(),i=0,j=0;a.hasChildren()?(c.getActiveNode().visit(function(a){j<a.data.dto.dtl_ord_no&&(j=a.data.dto.dtl_ord_no)}),g=j+1):g=a.data.dto.dtl_ord_no+1,c.visit(function(a){i<a.data.dto.seq_no&&(i=a.data.dto.seq_no),g<=a.data.dto.dtl_ord_no&&(a.data.dto.dtl_ord_no+=1)}),f=i+1,h.p_seq_no=a.data.dto.seq_no,h.seq_no=f,h.dtl_ord_no=g,h.dtl_depth=a.getLevel();var k=a.addChild({title:"New",key:h.seq_no,dto:h,focus:!0,children:[]});d=k,d.activate()}else console.log("선택된노드없습니다.");slui.attach.setTransformSelect(e.formId)}),f.form.find(".btn-minus").click(function(){var a=c.getActiveNode();if(null!=a){var b=a.data.dto;if(0==b.seq_no)return;1==b.seq_no?_confirm("전체를 삭제하시겠습니까?",{onAgree:function(){c.getNodeByKey("0").removeChildren()}}):a.hasChildren()?_confirm("하위 룰셋도 함께 삭제 합니다.",{onAgree:function(){c.visit(function(c){if(b.dtl_ord_no<c.data.dto.dtl_ord_no){var d=a.countChildren()+1;c.data.dto.dtl_ord_no-=d}}),a.remove()}}):_confirm("삭제하시겠습니까?",{onAgree:function(){c.visit(function(a){b.dtl_ord_no<a.data.dto.dtl_ord_no&&(a.data.dto.dtl_ord_no-=1)}),a.remove()}}),d=null}else console.log("선택된노드없습니다.")})},nodeValidate:function(){if(2==f.rulesetType.val())return!0;if(!_SL.validate("#formRelRuleset [name=search_query]"))return!1;var a=f.characterLimit.val(),b=f.searchQuery.val(),c=Number(b.length);return c>=a?void _alert("검색어의 현재입력길이: "+c+"byte<br>입력가능길이는: "+a+"byte입니다."):d.hasChildren()&&""==f.rstGrpFld.val()?(_alert("하위 룰셋이 존재합니다.<br>결과필드를 선택해 주세요"),!1):!!_SL.validate("#formRelRuleset [name=limit_count]")},getInitData:function(){return{operand:"AND",ruleset_type:"1",search_query:"",flt_grp_fld:"",rst_grp_fld:"",rel_times:"0"}},getData:function(){var a={operand:f.operand.val(),ruleset_type:f.rulesetType.val(),search_query:f.searchQuery.val(),flt_grp_fld:f.fltGrpFld.getSelectionOrder().join(),rst_grp_fld:f.rstGrpFld.getSelectionOrder().join(),limit_count:f.form.find("[name=limit_count]").val(),rel_times:f.relTimes.val()},b="<";return b+=gRulesetTypes[a.ruleset_type],1==a.ruleset_type?(""!=a.flt_grp_fld&&(b+=" - "+a.flt_grp_fld),""!=a.rst_grp_fld&&(b+=" / "+a.rst_grp_fld),b+=">",b+=a.search_query):b+=">",a.title=b,a},rulesetTypechangeEvent:function(a){if(1==a.ruleset_type){f.searchQuery.prop("disabled",!1),f.fltGrpFld.prop("disabled",!1),f.rstGrpFld.prop("disabled",!1),f.relTimes.prop("disabled",!1),f.relTimes.val("0"),""==a.flt_grp_fld?(f.rstGrpFld.prop("disabled",!0),f.rstGrpFld.val("")):f.rstGrpFld.prop("disabled",!1);var b=$("<input type='text' name='limit_count' class='form-input' value='' style='width:70px;' maxlength='10' data-valid='조건,required,number'>"),c=$("<span> 건 이상</span>"),d=f.form.find("[name=limit_count]").parent("td:eq(0)");d.empty().append(b).append(c)}else{f.searchQuery.prop("disabled",!0),f.fltGrpFld.prop("disabled",!0),f.rstGrpFld.prop("disabled",!0),f.relTimes.prop("disabled",!0),f.searchQuery.val(""),f.fltGrpFld.val("eqp_ip"),f.rstGrpFld.val("eqp_ip"),f.relTimes.val("0");var g=$("<span />").addClass("form-select-outer").css({display:"inline-block",width:"70px","vertical-align":"middle"}),h=$("<select name='limit_count' class='form-select' data-valid='조건,required'></select>");$.each(gEventLevelsJson,function(a,b){h.append($("<option>").append(b).val(a))});var c=$("<span> 이상</span>"),d=f.form.find("[name=limit_count]").parent("td:eq(0)");g.append(h),d.empty().append(g).append(c)}slui.attach.setTransformSelect(e.formId)}},s=function(a,b){for(var c in b){var d=b[c];gFieldCapsJson[d]?$.inArray(d,grpFldArr)<0&&a.append("<option value='"+d+"'>"+gFieldCapsJson[d]+"["+d+"]</option>"):(gFieldCapsJson[d]="undefined",a.append("<option value='"+d+"'>undefined["+d+"]</option>"))}a.setSelectionOrder(b,!0)},t=function(a){var b=slapp.comcode.form.getCode();a.append('<option value="'+b.code_id+'" selected="selected">'+b.code_name+"</option>"),slui.attach.setTransformSelect(e.formId)},u=function(){var a=slapp.comGroupField.form.getCode(),b=f.fltGrpFld.getSelectionOrder(),c=f.rstGrpFld.getSelectionOrder();f.fltGrpFld.empty(),f.rstGrpFld.empty();for(var d in a)f.fltGrpFld.append($("<option value='"+a[d]+"'>"+gFieldCapsJson[a[d]]+"("+a[d]+")</option>")),f.rstGrpFld.append($("<option value='"+a[d]+"'>"+gFieldCapsJson[a[d]]+"("+a[d]+")</option>"));f.fltGrpFld.setSelectionOrder(b,!0),f.rstGrpFld.setSelectionOrder(c,!0),f.fltGrpFld.trigger("chosen:updated"),f.rstGrpFld.trigger("chosen:updated"),slui.attach.setTransformSelect(e.formId)};return{init:h}}(),$(function(){slapp.relRuleset.form.init()});