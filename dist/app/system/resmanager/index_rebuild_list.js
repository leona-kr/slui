"use strict";_SL.nmspc("resmanager").rebuild=function(){var a=[],b={urlList:gCONTEXT_PATH+"system/index_rebuild_list.json",urlForm:gCONTEXT_PATH+"system/index_rebuild_form.html",urlRebuildControl:gCONTEXT_PATH+"system/index_rebild_control.do",urlProcPct:gCONTEXT_PATH+"system/index_rebuild_prcs_pct.json",formId:"#searchIndexRebuildList",gridId:"#gridIndexRebuild",dialogFormId:"#formRebuildDlg"},c={form:$(b.formId),grid:$(b.gridId),dialogForm:$(b.dialogFormId)},d=function(){var a=c.grid.parent().siblings(".grid-bottom").find(".btn-add");e(c.grid),c.form.find(".form-submit").off().on("click",function(){_SL.validate(c.form)&&h()}),a.off().on("click",function(){i(b.urlForm)}),c.form.find("[name=timeSet]").change(function(){var a=this.value;if(0!=a){var b=function(a,b){var c=a.siblings(".tform-select");c.find(".tform-select-t").text(b).end().find(".tform-select-option[data-value="+b+"]").addClass("selected").end(),a.val(b)},d=_SL.formatDate.addMin(c.form.find("[name=endDay]").val()+c.form.find("[name=endHour]").val()+c.form.find("[name=endMin]").val(),-a);b(c.form.find("[name=startDay]"),d.substring(0,8)),b(c.form.find("[name=startHour]"),d.substring(8,10)),b(c.form.find("[name=startMin]"),d.substring(10,12))}}),c.form.find("[name=startDay],[name=startHour],[name=startMin],[name=endDay],[name=endHour],[name=endMin]").change(function(){var a=c.form.find("[name=timeSet]"),b=a.siblings(".tform-select").find("[data-value=0]").text();a.val(0).siblings(".tform-select").find(".tform-select-t").text(b)}),setInterval(g,1e4)},e=function(d){var e={datatype:"json",datafields:[{name:"request_id",type:"string"},{name:"search_keyword",type:"string"},{name:"proc_start_dt",type:"string"},{name:"proc_end_dt",type:"string"},{name:"status",type:"string"},{name:"status_name",type:"string"},{name:"sleep_ms",type:"string"},{name:"proc_pct",type:"string"},{name:"total_cnt",type:"string"},{name:"reg_dt",type:"string"},{name:"proc_dt",type:"string"}],root:"rows",beforeprocessing:function(a){null!=a&&(e.totalrecords=a.totalRows)},cache:!1,url:b.urlList},g=new $.jqx.dataAdapter(e,{beforeLoadComplete:function(b){for(var c in b)a.push(b[c].request_id);return b},formatData:function(a){var c,d={},e=$(b.formId).serializeArray();for(c in e)d[e[c].name]=e[c].value;return $.extend(a,d),a},loadComplete:function(a){c.grid.find(".iconscontainer").remove()},loadError:function(a,b,c){alert(c)}});d.jqxGrid({source:g,sortable:!0,width:"100%",virtualmode:!0,selectionmode:"none",enablehover:!1,rendergridrows:function(a){return a.data},columns:[{text:"No",columntype:"number",width:40,cellsalign:"center",cellsrenderer:function(a,b,c,d){return $(d).text(c+1)[0].outerHTML}},{text:"검색어",datafield:"search_keyword",cellsrenderer:function(a,b,c,d,e,f){return $(d).html('<button type="button" class="btn-link">'+c+"</button>")[0].outerHTML}},{text:"대상기간",datafield:"proc_start_end_dt",width:"25%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g=f.proc_start_dt+" ~ "+f.proc_end_dt;return $(d).html(g)[0].outerHTML}},{text:"등록일",datafield:"reg_dt",width:"18%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g=f.proc_dt;return $(d).html(g)[0].outerHTML}},{text:"진행률",datafield:"proc_pct",width:"18%",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g=f.request_id,h="",i="";0==f.status||1==f.status?(h="Stop",i="icon-stop"):4!=f.status&&9!=f.status||(h="Retry",i="icon-spinner");var j='<div id="list_'+g+'" style="position:relative;width:100px;height:16px;margin:5px auto;border:1px solid #000;background:#fff;"><div class="prcsPctB" style="position:absolute;left:0;top:0;bottom:0;width:'+c+'%;background-color:#89cf43;"></div><div class="prcsPctT" style="position:absolute;width:100%;height:100%;text-align:center;color:#000;">'+c+"%</div>";return""!=h&&(j+='<button type="button" style="left:105px; position:absolute; min-width:auto; vertical-align: top; cursor:pointer; vertical-align:middle;" key='+g+" id=buildControl_"+g+' class="btn-'+h+' btn-basic btn-xs" title="'+h+'"><i class="'+i+'"></i></button>'),j+="</div>"}},{text:"상태",datafield:"status_name",cellsalign:"center",cellsrenderer:function(a,b,c,d,e,f){var g=f.request_id,h='<span class="'+g+'_status">'+c+"</span>";return $(d).html(h)[0].outerHTML}}]}),d.on("cellclick",function(a){var c=a.args.row.bounddata.request_id,d=$("."+c+"_status").text();"search_keyword"===a.args.datafield&&("중지"==d||"오류"==d?i(b.urlForm+"?request_id="+c):"완료"==d?_alert("완료된 상태입니다. 변경할 수 없습니다."):_alert("수정은 중지 또는 오류 상태에서 할 수 있습니다.<br>변경 후 다시 시도하세요")),"proc_pct"===a.args.datafield&&$(this).find("button").on("click",function(){var b=a.args.row.bounddata.request_id;if("완료"!=d){var c="";c="icon-stop"==$("#buildControl_"+b+" i").attr("class")?"5":"4",f(b,c)}})})},f=function(a,c){if(""!=c){var d="";d=4==c?"재시작을 실행하였습니다.":"정지를 실행하였습니다",$("body").requestData(b.urlRebuildControl,{request_id:a,action_code:c},{callback:function(a,b,c){"SUCCESS"==a.RESULT_CODE?_alert(d):"DUPLICATED"==a.RESULT_CODE&&_alert(a.RESULT_MESSAGE)},displayLoader:!0})}},g=function(){if(!(a.length<1)){var c={request_id_arr:a},d=function(a){for(var b in a){var c=a[b],d=c.request_id,e=c.status,f=c.proc_pct,g=$("#list_"+d);if(f+"%"!=g.find(".prcsPctT").text()){c.status;$("."+d+"_status").text(c.status_name),g.find(".prcsPctB").width(f+"%"),g.find(".prcsPctT").text(f+"%")}var h=$("#buildControl_"+d);"0"==e||"1"==e?(h.attr("title","Stop").show(),$("."+d+"_status").text(c.status_name),h.find("i").removeClass("icon-spinner").addClass("icon-stop")):"4"==e||"9"==e?(h.attr("title","Retry").show(),$("."+d+"_status").text(c.status_name),h.find("i").removeClass("icon-stop").addClass("icon-spinner")):($("."+d+"_status").text(c.status_name),h.hide())}};$("body").requestData(b.urlProcPct,c,{callback:d})}},h=function(){c.grid.jqxGrid("updatebounddata")},i=function(a){new ModalPopup(a,{width:650,height:200,onClose:function(){h()}})};return{init:d}}(),$(function(){slapp.resmanager.rebuild.init()});